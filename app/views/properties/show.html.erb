<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><%= @property.title %></h1>
        <div>
          <%= link_to 'Editar', edit_property_path(@property), class: 'btn btn-primary' %>
          <%= link_to 'Lista', properties_path, class: 'btn btn-secondary' %>
        </div>
      </div>

      <div class="row">
        <!-- COLUMNA PRINCIPAL -->
        <div class="col-md-8">
          <!-- Descripci√≥n -->
          <div class="card mb-4">
            <div class="card-header">
              <h5>Descripci√≥n</h5>
            </div>
            <div class="card-body">
              <p><%= simple_format(@property.description) %></p>
            </div>
          </div>

          <!-- Ubicaci√≥n COMPLETA - MEJORADA -->
          <div class="card mb-4">
            <div class="card-header">
              <h5>üìç Ubicaci√≥n</h5>
            </div>
            <div class="card-body">
              <!-- Direcci√≥n Concatenada (READ-ONLY) -->
              <div class="alert alert-light mb-3">
                <h6 class="mb-2"><i class="bi bi-geo-alt-fill"></i> Direcci√≥n Completa:</h6>
                <p class="mb-0"><strong><%= @property.full_address %></strong></p>
                <small class="text-muted">(Generada autom√°ticamente)</small>
              </div>
              
              <hr>
              
              <!-- Detalles Desglosados -->
              <div class="row">
                <div class="col-md-6">
                  <dl class="row mb-0">
                    <dt class="col-sm-5">Pa√≠s:</dt>
                    <dd class="col-sm-7"><%= @property.country || "No especificado" %></dd>
                    
                    <dt class="col-sm-5">Estado:</dt>
                    <dd class="col-sm-7"><%= @property.state || "No especificado" %></dd>
                    
                    <dt class="col-sm-5">Municipio:</dt>
                    <dd class="col-sm-7"><%= @property.municipality || "No especificado" %></dd>
                    
                    <dt class="col-sm-5">Colonia/Barrio:</dt>
                    <dd class="col-sm-7"><%= @property.neighborhood || "No especificado" %></dd>
                  </dl>
                </div>
                
                <div class="col-md-6">
                  <dl class="row mb-0">
                    <dt class="col-sm-5">Calle:</dt>
                    <dd class="col-sm-7"><%= @property.street || "No especificado" %></dd>
                    
                    <dt class="col-sm-5">No. Exterior:</dt>
                    <dd class="col-sm-7"><%= @property.exterior_number || "S/N" %></dd>
                    
                    <dt class="col-sm-5">No. Interior:</dt>
                    <dd class="col-sm-7"><%= @property.interior_number.presence || "N/A" %></dd>
                    
                    <dt class="col-sm-5">C√≥digo Postal:</dt>
                    <dd class="col-sm-7"><%= @property.postal_code || "No especificado" %></dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n de la Propiedad -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">üè† Caracter√≠sticas</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <dl class="row">
                    <dt class="col-sm-5">Tipo:</dt>
                    <dd class="col-sm-7">
                      <span class="badge bg-primary">
                        <%= @property.property_type&.display_name || 'Sin especificar' %>
                      </span>
                    </dd>
                    
                    <dt class="col-sm-5">Precio Base:</dt>
                    <dd class="col-sm-7">
                      <strong class="text-success fs-5">
                        $<%= number_with_delimiter(@property.price, delimiter: ',') %>
                      </strong>
                      <br>
                      <small class="text-muted">(precio de referencia)</small>
                    </dd>
                    
                    <dt class="col-sm-5">Rec√°maras:</dt>
                    <dd class="col-sm-7"><%= @property.bedrooms || 0 %></dd>
                    
                    <dt class="col-sm-5">Ba√±os:</dt>
                    <dd class="col-sm-7"><%= @property.bathrooms || 0 %></dd>
                  </dl>
                </div>
                
                <div class="col-md-6">
                  <dl class="row">
                    <dt class="col-sm-6">√Årea Construida:</dt>
                    <dd class="col-sm-6"><%= @property.built_area_m2 %> m¬≤</dd>
                    
                    <dt class="col-sm-6">√Årea del Terreno:</dt>
                    <dd class="col-sm-6"><%= @property.lot_area_m2 %> m¬≤</dd>
                    
                    <% if @property.year_built.present? %>
                      <dt class="col-sm-6">A√±o Construcci√≥n:</dt>
                      <dd class="col-sm-6"><%= @property.year_built %></dd>
                    <% end %>
                    
                    <% if @property.parking_spaces.present? && @property.parking_spaces > 0 %>
                      <dt class="col-sm-6">Estacionamientos:</dt>
                      <dd class="col-sm-6"><%= @property.parking_spaces %></dd>
                    <% end %>
                  </dl>
                </div>
              </div>
              
              <!-- Amenidades -->
              <hr>
              <h6 class="mb-3">Amenidades:</h6>
              <div class="row">
                <div class="col-md-6">
                  <ul class="list-unstyled">
                    <li><%= @property.furnished? ? "‚úÖ" : "‚ùå" %> Amueblado</li>
                    <li><%= @property.pets_allowed? ? "‚úÖ" : "‚ùå" %> Mascotas permitidas</li>
                    <li><%= @property.elevator? ? "‚úÖ" : "‚ùå" %> Elevador</li>
                    <li><%= @property.balcony? ? "‚úÖ" : "‚ùå" %> Balc√≥n</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <ul class="list-unstyled">
                    <li><%= @property.terrace? ? "‚úÖ" : "‚ùå" %> Terraza</li>
                    <li><%= @property.garden? ? "‚úÖ" : "‚ùå" %> Jard√≠n</li>
                    <li><%= @property.pool? ? "‚úÖ" : "‚ùå" %> Piscina</li>
                    <li><%= @property.security? ? "‚úÖ" : "‚ùå" %> Seguridad</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Operaciones Disponibles -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">üíº Operaciones Disponibles</h5>
            </div>
            <div class="card-body">
              <% if @property.business_transactions.any? %>
                <% @property.business_transactions.each do |transaction| %>
                  <div class="card mb-3 border-<%= transaction.business_status.color %>">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h6 class="card-title">
                            <%= transaction.operation_type.display_name %>
                            <span class="badge bg-<%= transaction.business_status.color %>">
                              <%= transaction.business_status.display_name %>
                            </span>
                          </h6>
                          
                          <p class="mb-1">
                            <strong>Precio:</strong> 
                            <span class="text-success">$<%= number_with_delimiter(transaction.price, delimiter: ',') %></span>
                          </p>
                          
                          <% if transaction.assigned_agent.present? %>
                            <p class="mb-1">
                              <strong>Agente:</strong> <%= transaction.assigned_agent.full_name %>
                            </p>
                          <% end %>
                          
                          <!-- COPROPIETARIOS EN TRANSACCI√ìN (NO EN PROPIEDAD) -->
                          <% if transaction.co_owners.any? %>
                            <hr>
                            <p class="mb-2"><strong>Copropietarios en esta transacci√≥n:</strong></p>
                            <ul class="list-unstyled ms-3">
                              <% transaction.co_owners.each do |co_owner| %>
                                <li>
                                  <i class="bi bi-person-fill"></i>
                                  <%= co_owner.client&.full_name || co_owner.person_name %>
                                  <% if co_owner.percentage.present? %>
                                    <span class="badge bg-info"><%= co_owner.percentage %>%</span>
                                  <% end %>
                                  <% if co_owner.role.present? %>
                                    <small class="text-muted">(<%= co_owner.role %>)</small>
                                  <% end %>
                                </li>
                              <% end %>
                            </ul>
                          <% end %>
                        </div>
                        
                        <div>
                          <%= link_to "Ver Detalles", business_transaction_path(transaction), class: "btn btn-sm btn-outline-primary" %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                  <strong>Sin operaciones configuradas</strong>
                  <p class="mb-0">Esta propiedad a√∫n no tiene operaciones de venta o renta configuradas.</p>
                  <% if policy(@property).update? %>
                    <hr>
                    <%= link_to "Configurar Primera Operaci√≥n", new_business_transaction_path(property_id: @property.id), class: "btn btn-primary btn-sm" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <!-- FIN COLUMNA PRINCIPAL -->

        <!-- COLUMNA LATERAL -->
        <div class="col-md-4">
          <!-- Resumen R√°pido -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Resumen</h5>
            </div>
            <div class="card-body">
              <p class="mb-2">
                <strong>Precio:</strong>
                <br>
                <span class="text-success fs-4">$<%= number_with_delimiter(@property.price, delimiter: ',') %></span>
              </p>
              <p class="mb-2">
                <strong>Tipo:</strong> 
                <span class="badge bg-primary"><%= @property.property_type&.display_name %></span>
              </p>
              <hr>
              <p class="mb-1"><strong><%= @property.bedrooms || 0 %></strong> rec√°maras</p>
              <p class="mb-1"><strong><%= @property.bathrooms || 0 %></strong> ba√±os</p>
              <p class="mb-1"><strong><%= @property.built_area_m2 %></strong> m¬≤ construidos</p>
              <p class="mb-0"><strong><%= @property.lot_area_m2 %></strong> m¬≤ terreno</p>
            </div>
          </div>

          <!-- Informaci√≥n Adicional -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">‚ÑπÔ∏è Informaci√≥n Adicional</h5>
            </div>
            <div class="card-body">
              <dl class="row mb-0">
                <dt class="col-sm-6">Uso de Suelo:</dt>
                <dd class="col-sm-6">
                  <span class="badge bg-info"><%= @property.land_use_display %></span>
                </dd>
                
                <dt class="col-sm-6">Ampliaciones:</dt>
                <dd class="col-sm-6">
                  <%= @property.has_extensions? ? "‚úÖ S√≠" : "‚ùå No" %>
                </dd>
              </dl>
              
              <!-- Facilidades Cercanas (antes co_owners_details) -->
              <% if @property.co_owners_details.present? %>
                <hr>
                <h6 class="mb-2">üè™ Facilidades Cercanas:</h6>
                <div class="text-muted small">
                  <%= simple_format(@property.co_owners_details) %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Informaci√≥n del Registro -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">üë§ Agente Responsable</h5>
            </div>
            <div class="card-body">
              <p class="mb-2">
                <strong>Nombre:</strong><br>
                <%= @property.user.full_name %>
              </p>
              <% if @property.contact_phone.present? %>
                <p class="mb-2">
                  <strong>Tel√©fono:</strong><br>
                  <a href="tel:<%= @property.contact_phone %>"><%= @property.contact_phone %></a>
                </p>
              <% end %>
              <% if @property.contact_email.present? %>
                <p class="mb-0">
                  <strong>Email:</strong><br>
                  <a href="mailto:<%= @property.contact_email %>"><%= @property.contact_email %></a>
                </p>
              <% end %>
            </div>
          </div>

          <!-- Detalles del Registro -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üìÖ Registro</h5>
            </div>
            <div class="card-body">
              <p class="mb-2">
                <strong>Creado:</strong><br>
                <small><%= @property.created_at.strftime("%d/%m/%Y %H:%M") %></small>
              </p>
              <p class="mb-0">
                <strong>Actualizado:</strong><br>
                <small><%= @property.updated_at.strftime("%d/%m/%Y %H:%M") %></small>
              </p>
              
              <% if @property.published_at.present? %>
                <hr>
                <p class="mb-0 text-success">
                  <i class="bi bi-check-circle-fill"></i>
                  <strong>Publicada</strong><br>
                  <small><%= time_ago_in_words(@property.published_at) %> atr√°s</small>
                </p>
              <% end %>
            </div>
          </div>
        </div>
        <!-- FIN COLUMNA LATERAL -->
      </div>

      <!-- Estado de Transacciones por Operaci√≥n -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-shield-check"></i>
                Estado de Operaciones
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <% @property.operation_status_summary.each do |operation_key, info| %>
                  <div class="col-md-4 mb-3">
                    <div class="card border-<%= case info[:status]
                                                when 'reserved' then 'warning'
                                                when 'available' then 'success'
                                                else 'secondary'
                                                end %>">
                      <div class="card-body text-center">
                        <h6 class="card-title">
                          <%= OperationType.find_by(name: operation_key)&.display_name %>
                        </h6>
                        
                        <span class="badge bg-<%= case info[:status]
                                                 when 'reserved' then 'warning'
                                                 when 'available' then 'success'  
                                                 else 'secondary'
                                                 end %> mb-2">
                          <%= info[:message] %>
                        </span>
                        
                        <% if info[:agent] %>
                          <p class="card-text">
                            <small class="text-muted">
                              <i class="bi bi-person"></i>
                              <%= info[:agent] %>
                            </small>
                          </p>
                        <% end %>
                        
                        <!-- Bot√≥n de acci√≥n seg√∫n estado -->
                        <% case info[:status] %>
                        <% when 'none' %>
                          <% if policy(BusinessTransaction).create? %>
                            <%= link_to new_business_transaction_path(
                                  property_id: @property.id, 
                                  operation_type_id: OperationType.find_by(name: operation_key)&.id
                                ), class: "btn btn-sm btn-primary" do %>
                              <i class="bi bi-plus"></i> Crear Transacci√≥n
                            <% end %>
                          <% end %>
                        <% when 'available' %>
                          <small class="text-success">
                            <i class="bi bi-check-circle"></i>
                            Disponible para ofertas
                          </small>
                        <% when 'reserved' %>
                          <small class="text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Bloqueado - Oferta en proceso
                          </small>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
