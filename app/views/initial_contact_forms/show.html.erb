 <!-- app/views/initial_contact_forms/show.html.erb -->

<% if flash[:notice] %>
  <div class="alert alert-<%= flash[:notice].include?('‚ö†Ô∏è') ? 'warning' : 'success' %> alert-dismissible fade show" role="alert">
    <%= flash[:notice].html_safe %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% end %>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="bi bi-clipboard-check"></i>
        <%= @form.opportunity_identifier || "Formulario de Contacto Inicial ##{@form.id}" %>
      </h2>
      <p class="text-muted mb-0">
        <strong>Folio:</strong> <%= @form.initial_contact_folio || "Sin folio" %> |
        <strong>Agente:</strong> <%= @form.agent && @form.agent.user ? @form.agent.user.name : "No asignado" %> |
        <strong>Estado:</strong> <span class="badge <%= status_badge_class(@form.status) %>"><%= @form.status.humanize %></span>
        <% if @form.completed_at %>
          | <strong>Completado:</strong> <%= l(@form.completed_at, format: :short) %>
        <% end %>
      </p>
    </div>


    
    <!-- Botones de acci√≥n (mant√©n los que ya ten√≠as) -->
    <div class="btn-group">
      <%= link_to 'Editar', edit_initial_contact_form_path(@form), class: 'btn btn-primary' unless @form.converted? %>
      <%= link_to 'Volver', initial_contact_forms_path, class: 'btn btn-secondary' %>
      
      <% if @form.completed? && !@form.business_transaction.present? %>
        <%= button_to 'Convertir a Transacci√≥n',
                      convert_to_transaction_initial_contact_form_path(@form),
                      method: :post,
                      class: 'btn btn-success',
                      data: { confirm: '¬øConvertir este formulario a una transacci√≥n de negocio?' } %>
      <% end %>
    </div>
  </div>
   
    <div>
      <% unless @form.converted? %>
        <%= link_to 'Editar', edit_initial_contact_form_path(@form), 
                    class: 'btn btn-primary' %>
        
        <% if @form.completed? %>
          <%= button_to 'Convertir a Transacci√≥n', 
                        convert_to_transaction_initial_contact_form_path(@form),
                        method: :post,
                        class: 'btn btn-success',
                        data: { confirm: '¬øConvertir este formulario a una transacci√≥n?' } %>
        <% end %>
      <% end %>
      
      <%= link_to 'Volver', initial_contact_forms_path, class: 'btn btn-secondary' %>
    </div>
  </div>
  
  <!-- Progreso -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>Progreso: <%= @form.completion_percentage %>%</h5>
      <div class="progress">
        <div class="progress-bar" style="width: <%= @form.completion_percentage %>%"></div>
      </div>
    </div>
  </div>
  
  <!-- Datos generales -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Informaci√≥n General</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-6">Agente:</dt>
            <dd class="col-sm-6"><%= @form.agent.email %></dd>
            
            <dt class="col-sm-6">Creado:</dt>
            <dd class="col-sm-6"><%= l(@form.created_at, format: :short) %></dd>
            
            <dt class="col-sm-6">Completado:</dt>
            <dd class="col-sm-6">
              <%= @form.completed_at ? l(@form.completed_at, format: :short) : 'Pendiente' %>
            </dd>
            
            <% if @form.converted? %>
              <dt class="col-sm-6">Transacci√≥n:</dt>
              <dd class="col-sm-6">
                <%= link_to "##{@form.business_transaction_id}", 
                            business_transaction_path(@form.business_transaction) %>
              </dd>
            <% end %>
          </dl>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Resumen del Contacto</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-6">Propietario:</dt>
            <dd class="col-sm-6">
              <%= @form.general_conditions['owner_or_representative_name'] || 'No especificado' %>
            </dd>
            
            <dt class="col-sm-6">Tel√©fono:</dt>
            <dd class="col-sm-6">
              <%= @form.general_conditions['owner_phone'] || 'No especificado' %>
            </dd>
            
            <dt class="col-sm-6">Tipo inmueble:</dt>
            <dd class="col-sm-6">
              <%= @form.general_conditions['domicile_type']&.humanize || 'No especificado' %>
            </dd>
            
            <dt class="col-sm-6">M√©todo adquisici√≥n:</dt>
            <dd class="col-sm-6">
              <%= @form.acquisition_method_display %>
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Alertas especiales -->
  <% if @form.is_inheritance? %>
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>HERENCIA</strong> - Requiere atenci√≥n especial.
      Herederos: <%= @form.inheritance_info['heirs_count'] %>
    </div>
  <% end %>
  
  <% if @form.current_status['has_active_mortgage'] %>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>HIPOTECA ACTIVA</strong> - 
      Saldo: $<%= number_with_delimiter(@form.current_status['mortgage_balance']) %>
    </div>
  <% end %>
  
  <!-- Detalles de cada secci√≥n -->
  <div class="card mt-4">
    <div class="card-header">
      <h3>Detalles Completos</h3>
    </div>
    <div class="card-body">
      
      <%# ============================================================ %>
      <%# CONDICIONES GENERALES %>
      <%# ============================================================ %>
      <% if @form.general_conditions.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üìã Condiciones Generales</h4>
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Propietario:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['owner_or_representative_name'] %></dd>
                
                <dt class="col-sm-5">Tel√©fono:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['owner_phone'] %></dd>
                
                <dt class="col-sm-5">Email:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['owner_email'] %></dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Estado civil:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['civil_status']&.humanize %></dd>
                
                <% if @form.general_conditions['marriage_regime_id'].present? %>
                  <dt class="col-sm-5">R√©gimen matrimonial:</dt>
                  <dd class="col-sm-7"><%= MarriageRegime.find_by(id: @form.general_conditions['marriage_regime_id'])&.name %></dd>
                <% end %>
                
                <% if @form.general_conditions['notes'].present? %>
                  <dt class="col-sm-5">Observaciones:</dt>
                  <dd class="col-sm-7"><%= @form.general_conditions['notes'] %></dd>
                <% end %>
              </dl>
            </div>
          </div>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# INFORMACI√ìN DE LA PROPIEDAD %>
      <%# ============================================================ %>
      <% if @form.property_info.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üè† Ubicaci√≥n de la Propiedad</h4>
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Calle:</dt>
                <dd class="col-sm-7"><%= @form.property_info['street'] %></dd>
                
                <dt class="col-sm-5">N√∫mero exterior:</dt>
                <dd class="col-sm-7"><%= @form.property_info['exterior_number'] %></dd>
                
                <% if @form.property_info['interior_number'].present? %>
                  <dt class="col-sm-5">N√∫mero interior:</dt>
                  <dd class="col-sm-7"><%= @form.property_info['interior_number'] %></dd>
                <% end %>
                
                <dt class="col-sm-5">Colonia:</dt>
                <dd class="col-sm-7"><%= @form.property_info['neighborhood'] %></dd>
                
                <dt class="col-sm-5">C√≥digo Postal:</dt>
                <dd class="col-sm-7"><%= @form.property_info['postal_code'] %></dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Municipio:</dt>
                <dd class="col-sm-7"><%= @form.property_info['municipality'] %></dd>
                
                <dt class="col-sm-5">Ciudad:</dt>
                <dd class="col-sm-7"><%= @form.property_info['city'] %></dd>
                
                <dt class="col-sm-5">Pa√≠s:</dt>
                <dd class="col-sm-7"><%= @form.property_info['country'] %></dd>
              </dl>
            </div>
          </div>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# DETALLES DE ADQUISICI√ìN %>
      <%# ============================================================ %>
      <% if @form.acquisition_details.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üìù Detalles de Adquisici√≥n</h4>
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Estado:</dt>
                <dd class="col-sm-7"><%= @form.acquisition_details['state'] %></dd>
                
                <dt class="col-sm-5">Uso de suelo:</dt>
                <dd class="col-sm-7">
                  <% if @form.acquisition_details['land_use'].present? %>
                    <%= LandUseType.find_by(code: @form.acquisition_details['land_use'])&.name || @form.acquisition_details['land_use'] %>
                  <% end %>
                </dd>
                
                <dt class="col-sm-5">Copropietarios:</dt>
                <dd class="col-sm-7"><%= @form.acquisition_details['co_owners_count'] || 1 %></dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <% if @form.acquisition_details['relationship_type'].present? %>
                <dl class="row">
                  <dt class="col-sm-5">Relaci√≥n entre copropietarios:</dt>
                  <dd class="col-sm-7"><%= @form.acquisition_details['relationship_type']&.humanize %></dd>
                </dl>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# ESTADO ACTUAL %>
      <%# ============================================================ %>
      <% if @form.current_status.present? && @form.current_status.any? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üîß Estado Actual</h4>
          
          <%# Hipoteca %>
          <% if @form.current_status['has_active_mortgage'] %>
            <h5>Hipoteca</h5>
            <dl class="row">
              <dt class="col-sm-3">Saldo:</dt>
              <dd class="col-sm-9"><%= number_to_currency(@form.current_status['mortgage_balance']) rescue @form.current_status['mortgage_balance'] %></dd>
              
              <dt class="col-sm-3">Pagos al corriente:</dt>
              <dd class="col-sm-9"><%= @form.current_status['mortgage_payments_current'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
              
              <% if @form.current_status['mortgage_notes'].present? %>
                <dt class="col-sm-3">Notas:</dt>
                <dd class="col-sm-9"><%= @form.current_status['mortgage_notes'] %></dd>
              <% end %>
            </dl>
          <% end %>
          
          <%# Ampliaciones %>
          <% if @form.current_status['has_extensions'] %>
            <h5>Ampliaciones</h5>
            <dl class="row">
              <dt class="col-sm-3">Reportadas:</dt>
              <dd class="col-sm-9"><%= @form.current_status['extensions_reported'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
              
              <% if @form.current_status['extensions_notes'].present? %>
                <dt class="col-sm-3">Notas:</dt>
                <dd class="col-sm-9"><%= @form.current_status['extensions_notes'] %></dd>
              <% end %>
            </dl>
          <% end %>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# EXENCI√ìN ISR %>
      <%# ============================================================ %>
      <% if @form.tax_exemption.present? && @form.tax_exemption.any? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üí∞ Exenci√≥n ISR</h4>
          <dl class="row">
            <% if @form.tax_exemption['first_home_sale'].present? %>
              <dt class="col-sm-4">Primera venta de casa habitaci√≥n:</dt>
              <dd class="col-sm-8"><%= @form.tax_exemption['first_home_sale'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
            <% end %>
            
            <% if @form.tax_exemption['lived_last_5_years'].present? %>
              <dt class="col-sm-4">Vivi√≥ √∫ltimos 5 a√±os:</dt>
              <dd class="col-sm-8"><%= @form.tax_exemption['lived_last_5_years'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
            <% end %>
            
            <% if @form.tax_exemption['estimated_capital_gain'].present? %>
              <dt class="col-sm-4">Ganancia de capital estimada:</dt>
              <dd class="col-sm-8"><%= number_to_currency(@form.tax_exemption['estimated_capital_gain']) rescue @form.tax_exemption['estimated_capital_gain'] %></dd>
            <% end %>
          </dl>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# PREFERENCIAS DE PROMOCI√ìN %>
      <%# ============================================================ %>
      <% if @form.promotion_preferences.present? && @form.promotion_preferences.any? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üì£ Preferencias de Promoci√≥n</h4>
          <dl class="row">
            <dt class="col-sm-4">M√©todo de contacto preferido:</dt>
            <dd class="col-sm-8"><%= @form.promotion_preferences['preferred_contact_method']&.humanize %></dd>
            
            <dt class="col-sm-4">Horario de contacto:</dt>
            <dd class="col-sm-8"><%= @form.promotion_preferences['contact_hours']&.humanize %></dd>
            
            <% if @form.promotion_preferences['special_instructions'].present? %>
              <dt class="col-sm-4">Instrucciones especiales:</dt>
              <dd class="col-sm-8"><%= @form.promotion_preferences['special_instructions'] %></dd>
            <% end %>
          </dl>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# NOTAS DEL AGENTE %>
      <%# ============================================================ %>
      <% if @form.agent_notes.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üìù Notas del Agente</h4>
          <p class="text-muted"><%= simple_format(@form.agent_notes) %></p>
        </div>
      <% end %>

    </div>
  </div>

  <style>
    .detail-section {
      border-left: 3px solid #007bff;
      padding-left: 15px;
    }
    
    .section-title {
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    dl.row {
      margin-bottom: 0;
    }
    
    dl.row dt {
      font-weight: 600;
      color: #555;
    }
    
    dl.row dd {
      color: #666;
    }
  </style>
  
</div>
