<!-- app/views/initial_contact_forms/index.html.erb -->
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-clipboard-check"></i>
      Formularios de Contacto Inicial
    </h2>
    <%= link_to new_initial_contact_form_path, class: 'btn btn-primary' do %>
      <i class="bi bi-plus-circle"></i> Nuevo Formulario
    <% end %>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SECCI√ìN DE FILTROS MEJORADA - REEMPLAZA TU CARD ACTUAL DE FILTROS -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-funnel"></i> Filtros de B√∫squeda
      </h5>
    </div>
    <div class="card-body">
      <%= form_with url: initial_contact_forms_path, method: :get, local: true do |f| %>
        <div class="row g-3">
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- FILA 1: Filtros principales -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          
          <!-- Filtro por Agente (solo para admin/superadmin) -->
          <% if current_user.superadmin? || current_user.admin? %>
            <div class="col-md-3">
              <%= label_tag :agent_id, "üë§ Agente", class: "form-label" %>
              <%= select_tag :agent_id, 
                  options_from_collection_for_select(
                    @agents || [], 
                    :id, 
                    ->(a) { a.user.name }, 
                    params[:agent_id]
                  ),
                  include_blank: "Todos los agentes",
                  class: "form-select" %>
            </div>
          <% end %>
          
          <!-- Filtro por Estado -->
          <div class="col-md-3">
            <%= label_tag :status, "üìä Estado", class: "form-label" %>
            <%= select_tag :status, 
                options_for_select([
                  ["Borrador", "draft"],
                  ["Completado", "completed"],
                  ["Convertido", "converted"],
                  ["Archivado", "archived"]
                ], params[:status]),
                include_blank: "Todos los estados",
                class: "form-select" %>
          </div>
          
          <!-- Filtro por M√©todo de Adquisici√≥n -->
          <div class="col-md-3">
            <%= label_tag :acquisition_method_id, "üìã M√©todo de Adquisici√≥n", class: "form-label" %>
            <%= select_tag :acquisition_method_id,
                options_from_collection_for_select(
                  @acquisition_methods || [], 
                  :id, 
                  :name, 
                  params[:acquisition_method_id]
                ),
                include_blank: "Todos los m√©todos",
                class: "form-select" %>
          </div>
          
          <!-- Filtro por Tipo de Operaci√≥n -->
          <div class="col-md-3">
            <%= label_tag :operation_type_id, "üè† Tipo de Operaci√≥n", class: "form-label" %>
            <%= select_tag :operation_type_id,
                options_from_collection_for_select(
                  @operation_types || [], 
                  :id, 
                  :name, 
                  params[:operation_type_id]
                ),
                include_blank: "Todos los tipos",
                class: "form-select" %>
          </div>
          
        </div>
        
        <div class="row g-3 mt-2">
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- FILA 2: B√∫squedas de texto -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          
          <!-- B√∫squeda por Nombre de Propietario -->
          <div class="col-md-4">
            <%= label_tag :owner_name, "üîç Nombre del Propietario", class: "form-label" %>
            <%= text_field_tag :owner_name, 
                params[:owner_name], 
                placeholder: "Buscar por nombre...",
                class: "form-control" %>
          </div>
          
          <!-- B√∫squeda por Identificador -->
          <div class="col-md-4">
            <%= label_tag :property_identifier, "üè∑Ô∏è Identificador de Propiedad", class: "form-label" %>
            <%= text_field_tag :property_identifier, 
                params[:property_identifier],
                placeholder: "Ej: Venta-Casa-Garcia",
                class: "form-control" %>
          </div>
          
          <!-- Rango de Fechas (opcional) -->
          <div class="col-md-4">
            <%= label_tag :period, "üìÖ Periodo", class: "form-label" %>
            <%= select_tag :period, 
                options_for_select([
                  ["Hoy", "today"],
                  ["Esta semana", "week"],
                  ["Este mes", "month"],
                  ["√öltimos 3 meses", "quarter"],
                  ["Este a√±o", "year"]
                ], params[:period]),
                include_blank: "Todo el tiempo",
                class: "form-select" %>
          </div>
          
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- BOTONES DE ACCI√ìN -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        
        <div class="row mt-3">
          <div class="col-12 d-flex justify-content-end gap-2">
            <%= link_to initial_contact_forms_path, class: "btn btn-outline-secondary" do %>
              <i class="bi bi-arrow-clockwise"></i> Limpiar Filtros
            <% end %>
            <%= submit_tag "üîç Buscar", class: "btn btn-primary" %>
          </div>
        </div>
        
      <% end %>
    </div>
  </div>
  
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- FIN DE SECCI√ìN DE FILTROS MEJORADA -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- Contador de resultados -->
  <% if params.slice(:status, :agent_id, :acquisition_method_id, :operation_type_id, :owner_name, :property_identifier, :period).values.any?(&:present?) %>
    <div class="alert alert-info mb-3">
      <i class="bi bi-info-circle"></i>
      Mostrando <strong><%= @forms.total_count %></strong> resultados con los filtros aplicados
      <%= link_to "Ver todos", initial_contact_forms_path, class: "ms-2 text-decoration-none" %>
    </div>
  <% end %>

  <!-- Estad√≠sticas r√°pidas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">Borradores</h5>
          <h2><%= @forms.where(status: :draft).count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <h5 class="card-title">Pendientes</h5>
          <h2><%= @forms.where(status: :completed, business_transaction_id: nil).count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">Convertidos</h5>
          <h2><%= @forms.where(status: :converted).count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">Este mes</h5>
          <h2><%= @forms.this_month.count %></h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de formularios -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Identificador</th>
              <th>Fecha</th>
              <th>Propietario</th>
              <th>Tel√©fono</th>
              <th>M√©todo</th>
              <th>Estado</th>
              <th>Progreso</th>
              <th>Agente</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @forms.each do |form| %>
              <tr>
                <td>
                  <strong><%= form.initial_contact_folio || "##{form.id}" %></strong>
                </td>
                <td>
                  <small class="text-primary">
                    <%= form.opportunity_identifier || content_tag(:em, 'Sin identificador', class: 'text-muted') %>
                  </small>
                </td>
                <td><%= l(form.created_at, format: :short) %></td>
                <td>
                  <%= form.general_conditions['owner_or_representative_name'] || 
                      content_tag(:em, 'Sin nombre', class: 'text-muted') %>
                </td>
                <td>
                  <%= form.general_conditions['owner_phone'] || 
                      content_tag(:em, 'Sin tel√©fono', class: 'text-muted') %>
                </td>
                <td>
                  <% if form.property_acquisition_method.present? %>
                    <span class="badge bg-info">
                      <%= form.property_acquisition_method.name %>
                    </span>
                  <% else %>
                    <span class="badge bg-secondary">N/A</span>
                  <% end %>
                </td>
                <td>
                  <% 
                    badge_class = case form.status
                    when 'draft' then 'bg-secondary'
                    when 'completed' then 'bg-warning'
                    when 'converted' then 'bg-success'
                    else 'bg-light'
                    end
                  %>
                  <span class="badge <%= badge_class %>">
                    <%= form.status.humanize %>
                  </span>
                </td>
                <td>
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar" 
                         role="progressbar" 
                         style="width: <%= form.completion_percentage %>%">
                      <%= form.completion_percentage %>%
                    </div>
                  </div>
                </td>
                <td>
                  <small class="text-muted">
                    <%= form.agent.user.name rescue form.agent.email %>
                  </small>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <%= link_to form, class: 'btn btn-outline-primary', title: 'Ver' do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                    
                    <% unless form.converted? %>
                      <%= link_to edit_initial_contact_form_path(form), 
                                  class: 'btn btn-outline-secondary', 
                                  title: 'Editar' do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      
                      <% if form.completed? && !form.business_transaction.present? %>
                        <%= button_to convert_to_transaction_initial_contact_form_path(form),
                                      method: :post,
                                      class: 'btn btn-outline-success',
                                      title: 'Convertir',
                                      data: { confirm: '¬øConvertir a transacci√≥n?' } do %>
                          <i class="bi bi-arrow-right-circle"></i>
                        <% end %>
                      <% end %>
                    <% else %>
                      <%= link_to business_transaction_path(form.business_transaction),
                                  class: 'btn btn-outline-success',
                                  title: 'Ver transacci√≥n' do %>
                        <i class="bi bi-check-circle"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        
        <% if @forms.empty? %>
          <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3">No hay formularios que coincidan con los filtros</p>
            <%= link_to 'Limpiar filtros', initial_contact_forms_path, class: 'btn btn-secondary me-2' %>
            <%= link_to 'Crear nuevo formulario', new_initial_contact_form_path, class: 'btn btn-primary' %>
          </div>
        <% end %>
      </div>
      
      <!-- Paginaci√≥n -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div class="text-muted">
          P√°gina <%= @forms.current_page %> de <%= @forms.total_pages %> 
          (<%= @forms.total_count %> total)
        </div>
        <%= paginate @forms %>
      </div>
    </div>
  </div>
</div>

