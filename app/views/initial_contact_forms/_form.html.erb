<!-- app/views/initial_contact_forms/_form.html.erb -->
<!-- FORMULARIO REFACTORIZADO - 4 SECCIONES -->

<%= form_with(model: form, local: true, html: { class: 'initial-contact-form', id: 'contactForm' }) do |f| %> <% if form.errors.any? %>
    <div class="alert alert-danger">
      <h5>Errores en el formulario:</h5>
      <ul>
        <% form.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="bi bi-person-badge"></i>
        Formulario de Contacto Inicial
      </h2>
      <p class="mb-0 text-muted">
        <strong>Agente:</strong>
        <%= form.agent && form.agent.user ? form.agent.user.name : "No asignado" %>
      </p>
      <p class="mb-0 text-muted">
        <strong>Folio:</strong>
        <%= form.initial_contact_folio || "Sin folio" %>
      </p>
      <p class="mb-0 text-muted">
        <strong>Identificador:</strong>
        <%= form.property_human_identifier || "Sin identificador" %>
      </p>
    </div>
  </div>



  <!-- IDENTIFICADOR DE LA OPORTUNIDAD -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-tag"></i> Identificador de la Oportunidad
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-12 mb-3">
          <%= f.label :property_human_identifier, 'Nombre de la oportunidad *', class: 'form-label fw-bold' %>
          <%= f.text_field :property_human_identifier, 
                           class: 'form-control form-control-lg', 
                           required: true,
                           placeholder: 'Ej: Casa Lomas de Chapultepec - Familia Garc√≠a' %>
          <small class="text-muted mt-2 d-block">
            <i class="bi bi-info-circle"></i> 
            <strong>Importante:</strong> Este nombre te ayudar√° a identificar r√°pidamente esta oportunidad.
            <br>
            <strong>Se recomienda usar:</strong> [Tipo de propiedad] [Ubicaci√≥n] - [Propietario]
          </small>
        </div>
      </div>
      
      <div class="alert alert-success mt-3">
        <i class="bi bi-lightbulb"></i> 
        <strong>Sugerencia:</strong> Un buen identificador facilita el seguimiento de la operaci√≥n.
        <br><br>
        <strong>Ejemplos:</strong>
        <ul class="mb-0">
          <li>Casa Lomas de Chapultepec - Familia G√≥mez</li>
          <li>Departamento Reforma - Roberto Mart√≠nez</li>
          <li>Terreno Industrial Vallejo - Constructora ABC</li>
        </ul>
      </div>
    </div>
  </div>


  
  <!-- INDICADOR DE PROGRESO -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>Progreso de completitud</span>
        <strong><%= form.completion_percentage %>%</strong>
      </div>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" 
             style="width: <%= form.completion_percentage %>%">
          <%= form.completion_percentage %>% completado
        </div>
      </div>
    </div>
  </div>





  <!-- TABS DE NAVEGACI√ìN (4 SECCIONES) -->
  <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="section1-tab" data-bs-toggle="tab" data-bs-target="#section1" type="button">
        1. Condiciones Generales
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section2-tab" data-bs-toggle="tab" data-bs-target="#section2" type="button">
        2. Estatus Actual
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section3-tab" data-bs-toggle="tab" data-bs-target="#section3" type="button">
        3. Exenci√≥n ISR
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section4-tab" data-bs-toggle="tab" data-bs-target="#section4" type="button">
        4. Promoci√≥n
      </button>
    </li>
  </ul>

  <!-- CONTENIDO DE TABS -->
  <div class="tab-content" id="formTabContent">
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 1: CONDICIONES GENERALES                           -->
    <!-- ========================================================== -->
    <div class="tab-pane fade show active" id="section1" role="tabpanel">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-1-circle"></i> Condiciones Generales</h5>
        </div>
        <div class="card-body">
          
          <!-- Tipo de Operaci√≥n y M√©todo de Adquisici√≥n -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :operation_type_id, '¬øQu√© tipo de operaci√≥n es? *', class: 'form-label' %>
              <%= f.collection_select :operation_type_id,
                                     OperationType.active.by_sort_order,
                                     :id,
                                     :display_name,
                                     { prompt: 'Seleccione tipo de operaci√≥n...' },
                                     { class: 'form-select', required: true } %>
              <small class="text-muted">Indica si es venta, renta, o ambas</small>
            </div>
            
            <div class="col-md-6 mb-3">
              <%= f.label :property_acquisition_method_id, '¬øC√≥mo adquiri√≥ la propiedad? *', class: 'form-label' %>
              <%= f.collection_select :property_acquisition_method_id,
                                     PropertyAcquisitionMethod.active.ordered,
                                     :id,
                                     :name,
                                     { prompt: 'Seleccione un m√©todo...' },
                                     { class: 'form-select',
                                       id: 'acquisition_method_select',
                                       required: true } %>
              
              <% if form.property_acquisition_method.present? %>
                <small class="text-muted mt-1 d-block">
                  <strong>Ref. legal:</strong> <%= form.property_acquisition_method.legal_reference %>
                </small>
              <% end %>
            </div>
          </div>
          
          <!-- Campo oculto con mapping ID -> Code para JavaScript -->
          <%= hidden_field_tag 'property_acquisition_method_codes',
                              @acquisition_method_codes,
                              id: 'acquisition_method_codes_data' %>
          
          <!-- Datos del propietario/representante -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :contract_signer_type_id, '¬øQui√©n firmar√° el contrato? *', class: 'form-label' %>
              <%= f.collection_select :contract_signer_type_id,
                                     ContractSignerType.active.ordered,
                                     :id,
                                     :display_name,
                                     { prompt: 'Seleccione...' },
                                     { class: 'form-select', required: true } %>
            </div>
            
            <div class="col-md-6 mb-3">
              <%= label_tag 'general_conditions_owner_or_representative_name', 'Nombre completo del propietario/representante *', class: 'form-label' %>
              <%= text_field_tag 'initial_contact_form[general_conditions][owner_or_representative_name]',
                                form.general_conditions['owner_or_representative_name'],
                                class: 'form-control',
                                placeholder: 'Ej: Juan P√©rez Garc√≠a',
                                required: true %>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= label_tag 'general_conditions_owner_phone', 'Tel√©fono de contacto', class: 'form-label' %>
              <%= text_field_tag 'initial_contact_form[general_conditions][owner_phone]',
                                form.general_conditions['owner_phone'],
                                class: 'form-control',
                                placeholder: '(55) 1234-5678' %>
            </div>
            
            <div class="col-md-6 mb-3">
              <%= label_tag 'general_conditions_owner_email', 'Email de contacto', class: 'form-label' %>
              <%= email_field_tag 'initial_contact_form[general_conditions][owner_email]',
                                 form.general_conditions['owner_email'],
                                 class: 'form-control',
                                 placeholder: 'ejemplo@email.com' %>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= label_tag 'general_conditions[civil_status]', 'Estado civil al momento de la adquisici√≥n *', class: 'form-label' %>

              <%= select_tag 'initial_contact_form[general_conditions][civil_status]',
                  options_from_collection_for_select(
                    CivilStatus.active.order(:sort_order),
                    :name,          # Guardar name (que debe ser: soltero, casado, etc)
                    :display_name,  # Mostrar display_name (Soltero(a), Casado(a), etc)
                    form.general_conditions['civil_status']
                  ),
                  prompt: 'Seleccione...',
                  class: 'form-select',
                  id: 'civil-status-field',
                  required: true %>
              <small class="text-muted">Estado civil del propietario</small>
            </div>

            <div class="col-md-6 mb-3 marriage-regime-field" style="<%= 'display:none;' unless form.general_conditions['civil_status'] == 'casado' %>">
              <%= label_tag 'general_conditions_marriage_regime_id', 'R√©gimen matrimonial', class: 'form-label' %>
              <%= collection_select 'initial_contact_form[general_conditions]', :marriage_regime_id,
                                   MarriageRegime.active.ordered,
                                   :id, :display_name,
                                   { prompt: 'Seleccione...' },
                                   { class: 'form-select' } %>
            </div>
          </div>
          
          <div class="mb-3">
            <%= label_tag 'general_conditions_notes', 'Observaciones adicionales', class: 'form-label' %>
            <%= text_area_tag 'initial_contact_form[general_conditions][notes]',
                             form.general_conditions['notes'],
                             class: 'form-control',
                             rows: 3,
                             placeholder: 'Cualquier informaci√≥n adicional relevante...' %>
          </div>


          <!-- CAMPOS GLOBALES (SIEMPRE VISIBLES) -->
          <div class="row mt-4 mb-4">
            <div class="col-12 mb-3">
              <h6 class="text-primary">
                <i class="bi bi-geo-alt"></i> Ubicaci√≥n y Uso
              </h6>
              <hr>
            </div>
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- DIRECCI√ìN DE LA PROPIEDAD                                              -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìç Ubicaci√≥n de la Propiedad</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <strong>Importante:</strong> La direcci√≥n se usar√° para generar el identificador √∫nico de la oportunidad y evitar duplicados en el sistema.
                </div>

                <div class="row">
                  <!-- Calle/Avenida -->
                  <div class="col-md-8 mb-3">
                    <%= f.label 'property_info[street]', 'Calle/Avenida *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][street]',
                                      form.property_info['street'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Av. Insurgentes Sur',
                                      required: true,
                                      id: 'property-street-field' %>
                    <small class="text-muted">Nombre completo de la calle o avenida</small>
                  </div>

                  <!-- N√∫mero Exterior -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[exterior_number]', 'N√∫mero Exterior *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][exterior_number]',
                                      form.property_info['exterior_number'],
                                      class: 'form-control',
                                      placeholder: 'Ej: 1500',
                                      required: true,
                                      id: 'property-exterior-field' %>
                  </div>
                </div>

                <div class="row">
                  <!-- N√∫mero Interior -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[interior_number]', 'N√∫mero Interior', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][interior_number]',
                                      form.property_info['interior_number'],
                                      class: 'form-control',
                                      placeholder: 'Ej: 301, Depto A' %>
                    <small class="text-muted">Opcional</small>
                  </div>

                  <!-- Colonia -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[neighborhood]', 'Colonia *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][neighborhood]',
                                      form.property_info['neighborhood'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Del Valle',
                                      required: true %>
                  </div>

                  <!-- C√≥digo Postal -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[postal_code]', 'C√≥digo Postal *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][postal_code]',
                                      form.property_info['postal_code'],
                                      class: 'form-control',
                                      placeholder: '03100',
                                      required: true,
                                      pattern: '[0-9]{5}',
                                      maxlength: 5 %>
                  </div>
                </div>

                <div class="row">
                  <!-- Municipio/Alcald√≠a -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[municipality]', 'Municipio/Alcald√≠a *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][municipality]',
                                      form.property_info['municipality'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Benito Ju√°rez',
                                      required: true %>
                  </div>

                  <!-- Ciudad -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[city]', 'Ciudad *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][city]',
                                      form.property_info['city'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Ciudad de M√©xico',
                                      required: true %>
                  </div>
                </div>


                <!-- Estado (ahora en direcci√≥n) -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= f.label 'acquisition_details[state]', 'Estado *', class: 'form-label' %>
                    <%= select_tag 'initial_contact_form[acquisition_details][state]',
                                  options_from_collection_for_select(
                                    MexicanState.active.order(:sort_order),
                                    :name,
                                    :name,
                                    form.acquisition_details['state']
                                  ),
                                  prompt: 'Selecciona un estado...',
                                  id: 'property-state-field',
                                  class: 'form-select',
                                  required: true %>
                    <small class="text-muted">Estado donde se ubica la propiedad</small>
                  </div>

                  <!-- Pa√≠s (por defecto M√©xico) -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[country]', 'Pa√≠s', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][country]',
                                      form.property_info['country'] || 'M√©xico',
                                      class: 'form-control',
                                      readonly: true %>
                  </div>
                </div>


                <!-- Preview del identificador (se actualiza en tiempo real) -->
                <div class="alert alert-success mt-3">
                  <strong>üè∑Ô∏è Identificador de oportunidad:</strong>
                  <div id="opportunity-identifier-preview" class="mt-2 font-monospace fs-5">
                    <em class="text-muted">Se generar√° autom√°ticamente al completar los datos</em>
                  </div>
                  <small class="text-muted d-block mt-2">
                    Este identificador √∫nico se usar√° para rastrear la oportunidad y evitar duplicados
                  </small>
                </div>
              </div>
            </div>
           
            <div class="col-md-6 mb-3">
              <%= f.label 'acquisition_details[land_use]', 'Uso de suelo *', class: 'form-label' %>
              <%= select_tag 'initial_contact_form[acquisition_details][land_use]',
                            options_from_collection_for_select(
                              LandUseType.active.order(:sort_order),
                              :code,
                              :name,
                              form.acquisition_details['land_use']
                            ),
                            prompt: 'Selecciona uso de suelo...',
                            id: 'land_use_select',
                            class: 'form-select',
                            required: true %>
              <small class="text-muted">Clasificaci√≥n del inmueble</small>
            </div>










          </div>

        </div>
      </div>
      
      <!-- CAMPOS CONDICIONALES POR M√âTODO DE ADQUISICI√ìN (INLINE) -->
      <%= render 'conditional_fields', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 2: ESTATUS ACTUAL                                  -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section2" role="tabpanel">
      <%= render 'section_current_status', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 3: EXENCI√ìN ISR                                    -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section3" role="tabpanel">
      <%= render 'section_tax_exemption', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 4: PROMOCI√ìN                                       -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section4" role="tabpanel">
      <%= render 'section_promotion', form: form, f: f %>
    </div>
    
  </div>

  <!-- BOTONES DE NAVEGACI√ìN -->
  <div class="d-flex justify-content-between mt-4">
    <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
      <i class="bi bi-arrow-left"></i> Anterior
    </button>
    
    <div>
      <%= f.submit 'Guardar Borrador', 
                   name: 'save_draft', 
                   class: 'btn btn-outline-primary me-2',
                   formnovalidate: true %>
      <%= f.submit form.persisted? ? 'Actualizar' : 'Guardar y Completar', 
                   class: 'btn btn-primary' %>
    </div>
    
    <button type="button" class="btn btn-secondary" id="nextBtn">
      Siguiente <i class="bi bi-arrow-right"></i>
    </button>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Elementos del formulario
    const operationTypeSelect = document.querySelector('select[name="initial_contact_form[operation_type_id]"]');
    const streetField = document.getElementById('property-street-field');
    const exteriorField = document.getElementById('property-exterior-field');
    const previewDiv = document.getElementById('opportunity-identifier-preview');

    // Funci√≥n para generar preview del identificador MIXTO
    function updateIdentifierPreview() {
      // Obtener valores
      const operationTypeId = operationTypeSelect?.value || '';
      const ownerName = document.querySelector('input[name="initial_contact_form[general_conditions][owner_or_representative_name]"]')?.value || '';
      const street = streetField?.value || '';
      const exterior = exteriorField?.value || '';

      // Validar que tengamos todos los campos necesarios
      if (!operationTypeId || !ownerName || !street || !exterior) {
        previewDiv.innerHTML = '<em class="text-muted">Completa: operaci√≥n, nombre propietario, calle y n√∫mero</em>';
        return;
      }

      // 1. OPERACI√ìN - Obtener c√≥digo
      const selectedOption = operationTypeSelect.options[operationTypeSelect.selectedIndex];
      const operationType = selectedOption ? selectedOption.text.toLowerCase() : '';
      
      let opCode = 'X';
      if (operationType.includes('venta') || operationType.includes('sale')) {
        opCode = 'V';
      } else if (operationType.includes('renta') || operationType.includes('rent')) {
        opCode = 'R';
      } else if (operationType.includes('traspaso')) {
        opCode = 'T';
      } else if (operationType.includes('permuta')) {
        opCode = 'P';
      }
      
      // 2. CLIENTE - Extraer primer apellido
      const nameParts = ownerName.trim().split(/\s+/);
      let lastName = '';
      
      if (nameParts.length >= 2) {
        lastName = nameParts;  // Segundo elemento = primer apellido
      } else {
        lastName = nameParts;  // Solo hay un nombre
      }
      
      // Limpiar apellido (sin acentos, sin caracteres especiales, uppercase, max 10 chars)
      const lastNameClean = lastName
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')  // Remover acentos
        .replace(/[^a-zA-Z0-9]/g, '')
        .toUpperCase()
        .substring(0, 10);
      
      // 3. PROPIEDAD - Limpiar calle (max 12 chars)
      const streetClean = street
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9]/g, '')
        .substring(0, 12);
      
      // 4. FECHA - Fecha actual YYYYMMDD
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const dateStr = `${year}${month}${day}`;

      // 5. GENERAR IDENTIFICADOR MIXTO
      // Formato: V-PEREZ-Insurgentes-1500-20251123
      const identifier = `${opCode}-${lastNameClean}-${streetClean}-${exterior}-${dateStr}`;
      
      // 6. MOSTRAR con desglose
      previewDiv.innerHTML = `
        <code class="text-success fs-5">${identifier}</code>
        <small class="d-block text-muted mt-2">
          <strong>Desglose:</strong><br>
          ${opCode} = Operaci√≥n | 
          ${lastNameClean} = Cliente | 
          ${streetClean}-${exterior} = Propiedad | 
          ${dateStr} = Fecha
        </small>
      `;
    }


      // Event listeners para actualizaci√≥n en tiempo real
      if (operationTypeSelect) {
        operationTypeSelect.addEventListener('change', updateIdentifierPreview);
      }
      
      const ownerNameField = document.querySelector('input[name="initial_contact_form[general_conditions][owner_or_representative_name]"]');
      if (ownerNameField) {
        ownerNameField.addEventListener('input', updateIdentifierPreview);
      }
      
      if (streetField) {
        streetField.addEventListener('input', updateIdentifierPreview);
      }
      
      if (exteriorField) {
        exteriorField.addEventListener('input', updateIdentifierPreview);
      }


        
        
        
        

        // Ejecutar al cargar (por si hay datos pre-cargados)
        updateIdentifierPreview();
      });
      </script>

    <% end %>

<!-- JAVASCRIPT -->
<%= render 'form_javascript' %>

