<!-- app/views/initial_contact_forms/_form.html.erb -->
<!-- FORMULARIO REFACTORIZADO - 4 SECCIONES -->

<%= form_with(model: form, local: true, html: { class: 'initial-contact-form', id: 'contactForm' }) do |f| %>

  <%# ‚úÖ CAMPO OCULTO PARA AGENTE %>
  <%= f.hidden_field :agent_id, value: form.agent_id || current_user.agent&.id %>
  
  <% if form.errors.any? %>
    <div class="alert alert-danger">
      <h5>Errores en el formulario:</h5>
      <ul>
        <% form.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="bi bi-person-badge"></i>
        Formulario de Contacto Inicial
      </h2>
      <p class="mb-0 text-muted">
        <strong>Agente:</strong>
        <%= form.agent && form.agent.user ? form.agent.user.name : "No asignado" %>
      </p>
      <p class="mb-0 text-muted">
        <strong>Folio:</strong>
        <%= form.initial_contact_folio || "Sin folio" %>
      </p>
      <p class="mb-0 text-muted">
        <strong>Identificador:</strong>
        <%= form.opportunity_identifier || "Sin identificador" %>
      </p>
    </div>
  </div>



  <!-- IDENTIFICADOR DE LA OPORTUNIDAD -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-tag"></i> Identificador de la Oportunidad
      </h5>
    </div>
    <div class="card-body">
      <div class="row">

        <div class="col-md-12 mb-3">
          <%= f.label :opportunity_identifier, 'Nombre de la oportunidad *', class: 'form-label fw-bold' %>
          
          <%# Campo visible que muestra el identificador generado autom√°ticamente %>
          <div class="input-group">
            <span class="input-group-text" id="identifier-prefix">
              <i class="bi bi-tag"></i>
            </span>
            <% if form.opportunity_identifier.present? %>
              <%= f.text_field :opportunity_identifier,
                               class: 'form-control form-control-lg',
                               value: form.opportunity_identifier,
                               readonly: true %>
            <% else %>
              <%= f.text_field :opportunity_identifier,
                               class: 'form-control form-control-lg',
                               placeholder: 'Se generar√° autom√°ticamente al completar los datos',
                               readonly: false %>
            <% end %>
          </div>
          
          <small class="text-muted mt-2 d-block">
            <i class="bi bi-lightbulb"></i>
            <strong>Importante:</strong> Este identificador se genera autom√°ticamente a partir de:
            <br>
            <strong>Operaci√≥n</strong> (V=Venta, R=Renta) + <strong>Apellido</strong> + <strong>Calle</strong> + <strong>N√∫mero</strong> + <strong>Fecha</strong>
            <br>
            <strong>Ejemplo:</strong> V-CALDERON-INSURGENTES-1500-301-20251204
          </small>
        </div>


      </div>
      

  <!-- IDENTIFICADORES Y BOTONES DE EDICI√ìN -->
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-tag"></i> Identificadores y Datos Asociados
      </h5>
    </div>
    <div class="card-body">
      
      <!-- SECTION 1: OPORTUNIDAD -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h6 class="text-secondary">
            <i class="bi bi-bookmark"></i> Identificador de Oportunidad
          </h6>
          <div class="font-monospace bg-light p-3 rounded border border-secondary">
            <strong><%= form.opportunity_identifier || "Se genera autom√°ticamente" %></strong>
          </div>
          <small class="text-muted">
            Identifica ESTA OPORTUNIDAD (cliente + operaci√≥n + fecha)
            <br>
            Cambia si: El propietario o la fecha cambian
          </small>
        </div>
        
        <div class="col-md-6">
          <h6 class="text-secondary">
            <i class="bi bi-geo-alt"></i> Identificador de Propiedad
          </h6>
          <div class="font-monospace bg-light p-3 rounded border border-success">
            <strong><%= form.property&.property_id || "Pendiente" %></strong>
          </div>
          <small class="text-muted">
            Identifica LA PROPIEDAD (ubicaci√≥n permanente)
            <br>
            NO cambia aunque cambien clientes o propietarios
          </small>
        </div>
      </div>
      
      <hr class="my-4">
      
      
        <!-- SECTION 2: PROPIEDAD CON BOT√ìN -->
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="text-info mb-3">
              <i class="bi bi-house-fill"></i> Datos de la Propiedad
            </h6>
            
            <% if form.property_info.present? %>
              <div class="alert alert-success">
                <strong>‚úì Completado</strong>
                <br>
                <small>
                  <%= form.property_info['street'] %> <%= form.property_info['exterior_number'] %>
                  <br>
                  <%= form.property_info['neighborhood'] %>, <%= form.property_info['municipality'] %>
                </small>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Pendiente</strong>
                <br>
                <small>No hay datos de propiedad</small>
              </div>
            <% end %>

            <% if form.persisted? %>
              <%= button_to "Editar Propiedad", 
                  new_property_for_form_initial_contact_form_path(form),
                  method: :get,
                  class: 'btn btn-primary btn-sm w-100' %>
            <% else %>
              <button class="btn btn-primary btn-sm w-100" disabled>
                Guardar primero para editar propiedad
              </button>
            <% end %>
          </div>
          
          <!-- SECTION 3: CLIENTE CON BOT√ìN -->
          <div class="col-md-6">
            <h6 class="text-info mb-3">
              <i class="bi bi-person-fill"></i> Datos del Cliente/Propietario
            </h6>
            
            <% if form.general_conditions['owner_or_representative_name'].present? %>
              <div class="alert alert-success">
                <strong>‚úì Completado</strong>
                <br>
                <small>
                  <%= form.general_conditions['owner_or_representative_name'] %>
                  <br>
                  <%= form.general_conditions['owner_email'] %>
                </small>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Pendiente</strong>
                <br>
                <small>No hay datos del cliente</small>
              </div>
            <% end %>
            
            <% if form.persisted? %>
              <%= button_to "Editar Cliente", 
                  new_client_for_form_initial_contact_form_path(form),
                  method: :get,
                  class: 'btn btn-primary btn-sm w-100' %>
            <% else %>
              <button class="btn btn-primary btn-sm w-100" disabled>
                Guardar primero para editar cliente
              </button>
            <% end %>
          </div>
        </div>

        <hr class="my-4">


      
      <hr class="my-4">
      
      <!-- SECTION 4: COPROPIETARIOS -->
      <div class="row">
        <div class="col-12">
          <h6 class="text-warning mb-3">
            <i class="bi bi-people-fill"></i> Copropietarios 
            <% if form.acquisition_details['co_owners_count'].to_i > 1 %>
              (<%= form.acquisition_details['co_owners_count'] %> registrados)
            <% end %>
          </h6>
          
          <% if form.acquisition_details['co_owners_count'].to_i > 1 %>
            <div class="alert alert-info">
              <strong>‚ÑπÔ∏è Informaci√≥n Importante</strong>
              <br>
              <small>
                Hay <%= form.acquisition_details['co_owners_count'] %> copropietarios registrados.
                <br>
                Cada uno necesita un identificador de oportunidad y datos completos.
                <br>
                Los copropietarios son CLIENTES tambi√©n (aunque no directos).
              </small>
            </div>
            
            <% if form.persisted? %>
              <%= button_to "Editar Copropietarios", 
                  edit_co_owners_modal_initial_contact_form_path(form),
                  method: :get,
                  class: 'btn btn-primary btn-sm w-100',
                  data: { turbo_frame: 'modal' } %>
            <% else %>
              <button class="btn btn-primary btn-sm w-100" disabled>
                Guardar primero para editar copropietarios
              </button>
            <% end %>

          <% else %>
            <div class="alert alert-secondary">
              <small>Este formulario tiene 1 √∫nico propietario (sin copropietarios)</small>
            </div>
          <% end %>
        </div>
      </div>
      
    </div>
  </div>

  <!-- MODAL CONTAINER (Turbo Frame) -->
  <turbo-frame id="modal" target="_top"></turbo-frame>


  
  <!-- INDICADOR DE PROGRESO -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>Progreso de completitud</span>
        <strong><%= form.completion_percentage %>%</strong>
      </div>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" 
             style="width: <%= form.completion_percentage %>%">
          <%= form.completion_percentage %>% completado
        </div>
      </div>
    </div>
  </div>





  <!-- TABS DE NAVEGACI√ìN (4 SECCIONES) -->
  <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="section1-tab" data-bs-toggle="tab" data-bs-target="#section1" type="button">
        1. Condiciones Generales
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section2-tab" data-bs-toggle="tab" data-bs-target="#section2" type="button">
        2. Estatus Actual
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section3-tab" data-bs-toggle="tab" data-bs-target="#section3" type="button">
        3. Exenci√≥n ISR
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section4-tab" data-bs-toggle="tab" data-bs-target="#section4" type="button">
        4. Promoci√≥n
      </button>
    </li>
  </ul>

  <!-- CONTENIDO DE TABS -->
  <div class="tab-content" id="formTabContent">
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 1: CONDICIONES GENERALES                           -->
    <!-- ========================================================== -->
    <div class="tab-pane fade show active" id="section1" role="tabpanel">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-1-circle"></i> Condiciones Generales</h5>
        </div>
        <div class="card-body">
          
          <!-- Tipo de Operaci√≥n y M√©todo de Adquisici√≥n -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :operation_type_id, '¬øQu√© tipo de operaci√≥n es? *', class: 'form-label' %>
              <%= f.collection_select :operation_type_id,
                                     OperationType.active.by_sort_order,
                                     :id,
                                     :display_name,
                                     { prompt: 'Seleccione tipo de operaci√≥n...' },
                                     { class: 'form-select', required: true } %>
              <small class="text-muted">Indica si es venta, renta, o ambas</small>
            </div>
            
            <div class="col-md-6 mb-3">
              <%= f.label :property_acquisition_method_id, '¬øC√≥mo adquiri√≥ la propiedad? *', class: 'form-label' %>
              <%= f.collection_select :property_acquisition_method_id,
                                     PropertyAcquisitionMethod.active.ordered,
                                     :id,
                                     :name,
                                     { prompt: 'Seleccione un m√©todo...' },
                                     { class: 'form-select',
                                       id: 'acquisition_method_select',
                                       required: true } %>
              
              <% if form.property_acquisition_method.present? %>
                <small class="text-muted mt-1 d-block">
                  <strong>Ref. legal:</strong> <%= form.property_acquisition_method.legal_reference %>
                </small>
              <% end %>
            </div>
          </div>
          
          <!-- Campo oculto con mapping ID -> Code para JavaScript -->
          <%= hidden_field_tag 'property_acquisition_method_codes',
                              @acquisition_method_codes,
                              id: 'acquisition_method_codes_data' %>
          
          <!-- Datos del propietario/representante -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :contract_signer_type_id, '¬øQui√©n firmar√° el contrato? *', class: 'form-label' %>
              <%= f.collection_select :contract_signer_type_id,
                                     ContractSignerType.active.ordered,
                                     :id,
                                     :display_name,
                                     { prompt: 'Seleccione...' },
                                     { class: 'form-select', required: true } %>
            </div>
            
          

            <!-- DESPU√âS: Campos separados -->
            <div class="card mb-4">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                  <i class="bi bi-person-fill"></i> Datos del Propietario/Representante
                </h5>
              </div>
              <div class="card-body">
                
                <!-- Nombre(s) propio(s) -->
                <div class="col-md-6 mb-3">
                  <%= label_tag 'general_conditions_first_names', 
                                'Nombre(s) propio(s) *', 
                                class: 'form-label' %>
                  <%= text_field_tag 'initial_contact_form[general_conditions][first_names]',
                                    form.general_conditions['first_names'],
                                    class: 'form-control',
                                    placeholder: 'Ej: Isabel Mar√≠a Luisa',
                                    required: true %>
                  <small class="text-muted">Incluye todos tus nombres propios</small>
                </div>
                
                <!-- Primer apellido -->
                <div class="col-md-6 mb-3">
                  <%= label_tag 'general_conditions_first_surname', 
                                'Primer Apellido *', 
                                class: 'form-label' %>
                  <%= text_field_tag 'initial_contact_form[general_conditions][first_surname]',
                                    form.general_conditions['first_surname'],
                                    class: 'form-control',
                                    placeholder: 'Ej: Calder√≥n',
                                    required: true %>
                  <small class="text-muted">Apellido paterno o principal</small>
                </div>
                
                <!-- Segundo apellido (opcional) -->
                <div class="col-md-6 mb-3">
                  <%= label_tag 'general_conditions_second_surname', 
                                'Segundo Apellido', 
                                class: 'form-label' %>
                  <%= text_field_tag 'initial_contact_form[general_conditions][second_surname]',
                                    form.general_conditions['second_surname'],
                                    class: 'form-control',
                                    placeholder: 'Ej: Grajales (opcional)' %>
                  <small class="text-muted">Apellido materno (si aplica)</small>
                </div>
                
                <!-- VISTA PREVIA: Nombre completo como aparecer√° -->
                <div class="col-md-12 mb-3">
                  <div class="bg-light p-3 rounded border">
                    <strong>‚úì Nombre legal (tal como aparecer√° en documentos):</strong>
                    <br>
                    <span class="font-monospace" id="full_name_preview">
                      <!-- Se actualiza con JavaScript -->
                      (Se completa al rellenar arriba)
                    </span>
                  </div>
                </div>
                
                <!-- Resto de datos de contacto -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= label_tag 'general_conditions_owner_phone', 
                                  'Tel√©fono de contacto', 
                                  class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[general_conditions][owner_phone]',
                                      form.general_conditions['owner_phone'],
                                      class: 'form-control',
                                      placeholder: '(55) 1234-5678',
                                      id: 'owner-phone-field' %>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <%= label_tag 'general_conditions_owner_email', 
                                  'Email de contacto', 
                                  class: 'form-label' %>
                    <%= email_field_tag 'initial_contact_form[general_conditions][owner_email]',
                                      form.general_conditions['owner_email'],
                                      class: 'form-control',
                                      placeholder: 'ejemplo@email.com' %>
                  </div>
                </div>
              </div>
            </div>
          </div>




          
          
          <div class="row">
          
          <div class="col-md-6 mb-3">
            <label for="civil_status_field" class="form-label">Estado civil al momento de la adquisici√≥n *</label>
            <%= select_tag 'initial_contact_form[general_conditions][civil_status]',
                options_from_collection_for_select(
                  CivilStatus.active.order(:sort_order),
                  :name,
                  :display_name,
                  form.general_conditions['civil_status']
                ),
                prompt: 'Seleccione...',
                class: 'form-select',
                id: 'civil-status-field',
                required: true %>
            <small class="text-muted">Estado civil del propietario</small>
          </div>

          <div class="col-md-6 mb-3 marriage-regime-field">
            <%= label_tag 'general_conditions_marriage_regime_id', 'R√©gimen matrimonial', class: 'form-label' %>
            <%= collection_select 'initial_contact_form[general_conditions]', :marriage_regime_id,
                                  MarriageRegime.active.ordered,
                                  :id, :display_name,
                                  { selected: form.general_conditions['marriage_regime_id'], prompt: 'Seleccione...' },
                                  { class: 'form-select' } %>
          </div>





          </div>
          



          <!-- ESTADO CIVIL ACTUAL (NUEVO) -->
          <div class="row mt-4">
            <div class="col-md-6 mb-3">
              <%= label_tag 'general_conditions[current_civil_status]', 'Estado civil actual *', class: 'form-label' %>

              <%= select_tag 'initial_contact_form[general_conditions][current_civil_status]',
                  options_from_collection_for_select(
                    CivilStatus.active.order(:sort_order),
                    :name,
                    :display_name,
                    form.general_conditions['current_civil_status']
                  ),
                  prompt: 'Seleccione...',
                  class: 'form-select',
                  id: 'current-civil-status-field',
                  required: true %>
              <small class="text-muted">Estado civil ACTUAL del propietario</small>
            </div>

            <div class="col-md-6 mb-3 current-marriage-regime-field" style="<%= 'display:none;' unless form.general_conditions['current_civil_status'] == 'casado' %>">
              <%= label_tag 'general_conditions_current_marriage_regime_id', 'R√©gimen matrimonial actual', class: 'form-label' %>
              <%= collection_select 'initial_contact_form[general_conditions]', :current_marriage_regime_id,
                                    MarriageRegime.active.ordered,
                                    :id, :display_name,
                                    { selected: form.general_conditions['current_marriage_regime_id'], prompt: 'Seleccione...' },
                                    { class: 'form-select' } %>
            </div>
          </div>



          <div class="mb-3">
            <%= label_tag 'general_conditions_notes', 'Observaciones adicionales', class: 'form-label' %>
            <%= text_area_tag 'initial_contact_form[general_conditions][notes]',
                             form.general_conditions['notes'],
                             class: 'form-control',
                             rows: 3,
                             placeholder: 'Cualquier informaci√≥n adicional relevante...' %>
          </div>


          <!-- CAMPOS GLOBALES (SIEMPRE VISIBLES) -->
          <div class="row mt-4 mb-4">
            <div class="col-12 mb-3">
              <h6 class="text-primary">
                <i class="bi bi-geo-alt"></i> Ubicaci√≥n y Uso
              </h6>
              <hr>
            </div>
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- DIRECCI√ìN DE LA PROPIEDAD                                              -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìç Ubicaci√≥n de la Propiedad</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <strong>Importante:</strong> La direcci√≥n se usar√° para generar el identificador √∫nico de la oportunidad y evitar duplicados en el sistema.
                </div>

                <div class="row">
                  <!-- Calle/Avenida -->
                  <div class="col-md-8 mb-3">
                    <%= f.label 'property_info[street]', 'Calle/Avenida *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][street]',
                                      form.property_info['street'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Av. Insurgentes Sur',
                                      required: true,
                                      id: 'property-street-field' %>
                    <small class="text-muted">Nombre completo de la calle o avenida</small>
                  </div>

                  <!-- N√∫mero Exterior -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[exterior_number]', 'N√∫mero Exterior *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][exterior_number]',
                                      form.property_info['exterior_number'],
                                      class: 'form-control',
                                      placeholder: 'Ej: 1500',
                                      required: true,
                                      id: 'property-exterior-field' %>
                  </div>
                </div>

                <div class="row">
                  <!-- N√∫mero Interior -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[interior_number]', 'N√∫mero Interior', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][interior_number]',
                                      form.property_info['interior_number'],
                                      class: 'form-control',
                                      placeholder: 'Ej: 301, Depto A',
                                      required: false,
                                      id: 'property-interior-field' %>
                    <small class="text-muted">Opcional</small>
                  </div>

                  <!-- Colonia -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[neighborhood]', 'Colonia *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][neighborhood]',
                                      form.property_info['neighborhood'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Del Valle',
                                      required: true %>
                  </div>

                  <!-- C√≥digo Postal -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[postal_code]', 'C√≥digo Postal *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][postal_code]',
                                      form.property_info['postal_code'],
                                      class: 'form-control',
                                      placeholder: '03100',
                                      required: true,
                                      pattern: '[0-9]{5}',
                                      maxlength: 5 %>
                  </div>
                </div>

                <div class="row">
                  <!-- Municipio/Alcald√≠a -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[municipality]', 'Municipio/Alcald√≠a *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][municipality]',
                                      form.property_info['municipality'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Benito Ju√°rez',
                                      required: true %>
                  </div>

                  <!-- Ciudad -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[city]', 'Ciudad *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][city]',
                                      form.property_info['city'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Ciudad de M√©xico',
                                      required: true %>
                  </div>
                </div>


                <!-- Estado (ahora en direcci√≥n) -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= f.label 'acquisition_details[state]', 'Estado *', class: 'form-label' %>
                    <%= select_tag 'initial_contact_form[acquisition_details][state]',
                                  options_from_collection_for_select(
                                    MexicanState.active.order(:sort_order),
                                    :name,
                                    :name,
                                    form.acquisition_details['state']
                                  ),
                                  prompt: 'Selecciona un estado...',
                                  id: 'property-state-field',
                                  class: 'form-select',
                                  required: true %>
                    <small class="text-muted">Estado donde se ubica la propiedad</small>
                  </div>

                  <!-- Pa√≠s (por defecto M√©xico) -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[country]', 'Pa√≠s', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][country]',
                                      form.property_info['country'] || 'M√©xico',
                                      class: 'form-control',
                                      readonly: true %>
                  </div>
                </div>


                <!-- Preview del identificador (se actualiza en tiempo real) -->
                <div class="alert alert-success mt-3">
                  <strong>üè∑Ô∏è Identificador de oportunidad:</strong>
                  <div id="opportunity-identifier-preview" class="mt-2 font-monospace fs-5">
                    <em class="text-muted">Se generar√° autom√°ticamente al completar los datos</em>
                  </div>
                  <small class="text-muted d-block mt-2">
                    Este identificador √∫nico se usar√° para rastrear la oportunidad y evitar duplicados
                  </small>
                </div>
              </div>
            </div>
           
            <div class="col-md-6 mb-3">
              <%= f.label 'acquisition_details[land_use]', 'Uso de suelo *', class: 'form-label' %>
              <%= select_tag 'initial_contact_form[acquisition_details][land_use]',
                            options_from_collection_for_select(
                              LandUseType.active.order(:sort_order),
                              :code,
                              :name,
                              form.acquisition_details['land_use']
                            ),
                            prompt: 'Selecciona uso de suelo...',
                            id: 'land_use_select',
                            class: 'form-select',
                            required: true %>
              <small class="text-muted">Clasificaci√≥n del inmueble</small>
            </div>










          </div>

        </div>
      </div>
      
      <!-- CAMPOS CONDICIONALES POR M√âTODO DE ADQUISICI√ìN (INLINE) -->
      <%= render 'conditional_fields', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 2: ESTATUS ACTUAL                                  -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section2" role="tabpanel">
      <%= render 'section_current_status', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 3: EXENCI√ìN ISR                                    -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section3" role="tabpanel">
      <%= render 'section_tax_exemption', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 4: PROMOCI√ìN                                       -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section4" role="tabpanel">
      <%= render 'section_promotion', form: form, f: f %>
    </div>
    
  </div>

  <!-- BOTONES DE NAVEGACI√ìN -->
  <div class="d-flex justify-content-between mt-4">
    <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
      <i class="bi bi-arrow-left"></i> Anterior
    </button>
    
    <div>
      <%= f.submit 'Guardar Borrador', 
                  name: 'save_draft', 
                  class: 'btn btn-outline-primary me-2',
                  formnovalidate: true %>
      
      <% if @initial_contact_form.persisted? && @initial_contact_form.draft? %>
        <%= f.submit 'Guardar y Completar', 
                    name: 'complete', 
                    class: 'btn btn-success',
                    data: { confirm: '¬øCompletar este formulario? Se generar√° el identificador y podr√°s convertirlo a transacci√≥n.' } %>
      <% elsif @initial_contact_form.persisted? %>
        <%= f.submit 'Actualizar', 
                    name: 'update',
                    class: 'btn btn-primary' %>
      <% else %>
        <%= f.submit 'Guardar y Completar', 
                    name: 'complete',
                    class: 'btn btn-primary' %>
      <% end %>
    </div>




    <button type="button" class="btn btn-secondary" id="nextBtn">
      Siguiente <i class="bi bi-arrow-right"></i>
    </button>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const operationTypeSelect = document.querySelector('select[name="initial_contact_form[operation_type_id]"]');
    const firstSurnameField = document.querySelector('input[name="initial_contact_form[general_conditions][first_surname]"]');
    const streetField = document.getElementById('property-street-field');
    const exteriorField = document.getElementById('property-exterior-field');
    const interiorField = document.getElementById('property-interior-field');
    const identifierField = document.querySelector('input[name="initial_contact_form[opportunity_identifier]"]');
    const previewDiv = document.getElementById('opportunity-identifier-preview');
    const phoneField = document.getElementById('owner-phone-field');

    function updateIdentifierPreview() {
      const operationTypeId = operationTypeSelect?.value || '';
      const firstSurname = firstSurnameField?.value || '';
      const street = streetField?.value || '';
      const exterior = exteriorField?.value || '';
      const interior = interiorField?.value || '';

      // Validar campos m√≠nimos
      if (!operationTypeId || !firstSurname || !street || !exterior) {
        if (previewDiv) {
          previewDiv.innerHTML = '<em class="text-muted">Completa: operaci√≥n, apellido, calle y n√∫mero exterior</em>';
        }
        if (identifierField) {
          identifierField.value = '';
        }
        return;
      }

      // Extraer c√≥digo de operaci√≥n
      const selectedOption = operationTypeSelect?.options[operationTypeSelect.selectedIndex];
      const operationType = selectedOption ? selectedOption.text.toLowerCase() : '';
      let opCode = 'X';

      if (operationType.includes('venta') || operationType.includes('sale')) {
        opCode = 'V';
      } else if (operationType.includes('renta') || operationType.includes('rent')) {
        opCode = 'R';
      } else if (operationType.includes('traspaso')) {
        opCode = 'T';
      }

      // Limpiar apellido (sin acentos, sin caracteres especiales, uppercase)
      const lastNameClean = firstSurname
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9]/g, '')
        .toUpperCase()
        .slice(0, 10);

      // Limpiar calle
      const streetClean = street
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9]/g, '')
        .toUpperCase()
        .slice(0, 15);

      // Generar fecha
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const dateStr = `${year}${month}${day}`;

      // Construir identificador (igual l√≥gica que Rails)
      let identifier = `${opCode}-${lastNameClean}-${streetClean}-${exterior}`;
      if (interior && interior.trim()) {
        identifier += `-${interior.slice(0, 3)}`;
      }
      identifier += `-${dateStr}`;

      // IMPORTANTE: Actualizar AMBOS: preview y campo hidden
      if (previewDiv) {
        previewDiv.innerHTML = `
          <code class="text-success fs-5">${identifier}</code>
          <small class="d-block text-muted mt-2">
            <strong>Desglose:</strong> ${opCode} (operaci√≥n) | ${lastNameClean} (cliente) | ${streetClean}-${exterior}${interior ? `-${interior}` : ''} (propiedad) | ${dateStr} (fecha)
          </small>
        `;
      }

      // ‚úÖ ACTUALIZAR EL CAMPO HIDDEN (esto es lo CR√çTICO)
      if (identifierField) {
        identifierField.value = identifier;
      }

      console.log('‚úÖ Identifier updated:', identifier);
    }

    // Event listeners
    if (operationTypeSelect) operationTypeSelect.addEventListener('change', updateIdentifierPreview);
    if (firstSurnameField) firstSurnameField.addEventListener('input', updateIdentifierPreview);
    if (streetField) streetField.addEventListener('input', updateIdentifierPreview);
    if (exteriorField) exteriorField.addEventListener('input', updateIdentifierPreview);
    if (interiorField) interiorField.addEventListener('input', updateIdentifierPreview);
    if (phoneField) {
      phoneField.addEventListener('blur', function(e) {
        let phone = e.target.value.trim();
        
        if (!phone) return;
        
        let cleaned = phone.replace(/[\s\-()]/g, '');
        
        if (cleaned.match(/^\d{10}$/)) {
          e.target.value = cleaned.slice(0, 2) + ' ' + 
                           cleaned.slice(2, 6) + ' ' + 
                           cleaned.slice(6, 10);
        }
      });
    }

    // Trigger inicial
    setTimeout(() => updateIdentifierPreview(), 100);
  });
  </script>

    <% end %>

<!-- JAVASCRIPT -->
<%= render 'form_javascript' %>
