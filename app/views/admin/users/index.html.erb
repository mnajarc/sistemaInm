<% content_for :title, "Gestión de Usuarios" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Gestión de Usuarios</h2>
  <div class="badge bg-info">
    Nivel de acceso: <%= current_user.role_name %>
  </div>
</div>

<!-- Tabla de usuarios -->
<div class="table-responsive">
  <table class="table table-striped">
    <thead class="table-dark">
      <tr>
        <th>Email</th>
        <th>Rol Actual</th>
        <th>Nivel</th>
        <th>Último Login</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr id="user-<%= user.id %>">
          <td>
            <%= user.email %>
            <% if user == current_user %>
              <span class="badge bg-info ms-2">Tú</span>
            <% end %>
          </td>
          <td>
            <span class="badge bg-<%= role_badge_class(user.role) %>">
              <%= role_name(user.role) %>
            </span>
          </td>
          <td>
            <small class="text-muted">Nivel <%= user.role_level %></small>
          </td>
          <td>
            <%= user.last_sign_in_at&.strftime("%d/%m/%Y %H:%M") || "Nunca" %>
          </td>
          <td>
            <% if user.can_be_managed_by?(current_user) %>
              <div class="btn-group" role="group">
                <!-- ✅ Solo mostrar roles que se pueden asignar -->
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" 
                          type="button" data-bs-toggle="dropdown">
                    Cambiar Rol
                  </button>
                  <ul class="dropdown-menu">
                    <% @manageable_roles.each do |role_key| %>
                      <% unless user.role == role_key %>
                        <% if user.can_change_role_to?(role_key, current_user) %>
                          <li>
                            <%= link_to role_name(role_key), "#", 
                                       class: "dropdown-item role-change-link",
                                       data: { 
                                         user_id: user.id, 
                                         role: role_key,
                                         confirm: role_key == 'admin' ? "¿Confirmar hacer administrador a #{user.email}?" : nil
                                       } %>
                          </li>
                        <% end %>
                      <% end %>
                    <% end %>
                  </ul>
                </div>
                
                <%= link_to "Editar", edit_admin_user_path(user), 
                           class: "btn btn-sm btn-outline-secondary" %>
                
                <% unless user == current_user %>
                  <%= link_to "Eliminar", admin_user_path(user), 
                             method: :delete,
                             data: { 
                               confirm: "¿Estás seguro de eliminar a #{user.email}?" 
                             },
                             class: "btn btn-sm btn-outline-danger" %>
                <% end %>
              </div>
            <% else %>
              <span class="badge bg-warning">
                <i class="bi bi-shield-lock"></i> Protegido
              </span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- ✅ Información de jerarquía -->
<div class="mt-4">
  <h6>Jerarquía de Roles:</h6>
  <div class="row">
    <div class="col-md-6">
      <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between">
          <span>SuperAdministrador</span>
          <span class="badge bg-warning">Nivel 0</span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Administrador</span>
          <span class="badge bg-danger">Nivel 10</span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Agente</span>
          <span class="badge bg-primary">Nivel 20</span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Cliente</span>
          <span class="badge bg-secondary">Nivel 30</span>
        </li>
      </ul>
    </div>
    <div class="col-md-6">
      <div class="alert alert-info">
        <strong>Tu nivel actual:</strong> <%= current_user.role_level %><br>
        <strong>Puedes gestionar:</strong> Niveles > <%= current_user.role_level %>
      </div>
    </div>
  </div>
</div>
