<!-- app/views/document_submissions/_document_notes_panel.html.erb -->
<!-- 
  Uso: render 'document_notes_panel', submission: @submission, current_user: current_user
-->

<div class="notes-panel">
  <!-- Historial de notas -->
  <div class="notes-list mb-3" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 0.375rem; padding: 1rem;">
    <% if submission.document_notes.any? %>
      <% submission.document_notes.recent.each do |note| %>
        <div class="note-item mb-3 pb-3 border-bottom" data-note-id="<%= note.id %>">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong class="d-block"><%= note.user.full_name %></strong>
              <small class="text-muted">
                <%= note.created_at.strftime('%d/%m/%Y %H:%M') %>
                <% if note.note_type == 'status_change' %>
                  <span class="badge bg-info ms-2">Cambio de estado</span>
                <% end %>
              </small>
            </div>
            
            <!-- Botón eliminar (solo si es la última nota propia) -->
            <% if note.deletable_by?(current_user) %>
              <%= button_to delete_business_transaction_document_submission_path(submission.business_transaction, note.id),
                  method: :delete,
                  class: 'btn btn-sm btn-outline-danger',
                  title: 'Eliminar esta nota',
                  data: { bs_toggle: 'tooltip' } do %>
                <i class="bi bi-trash"></i>
              <% end %>
            <% end %>
          </div>
          
          <p class="mt-2 mb-0" style="white-space: pre-wrap; word-break: break-word;">
            <%= simple_format(note.content) %>
          </p>
        </div>
      <% end %>
    <% else %>
      <div class="text-center text-muted py-4">
        <i class="bi bi-chat-dots"></i>
        <p>Sin notas aún</p>
      </div>
    <% end %>
  </div>

  <!-- Agregar nota -->
  <div class="add-note-form">
    <form id="noteForm-<%= submission.id %>" 
          data-submission-id="<%= submission.id %>"
          class="add-note-form-submit">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      
      <div class="mb-3">
        <label for="noteContent-<%= submission.id %>" class="form-label">Agregar nota</label>
        <textarea 
          class="form-control form-control-sm"
          id="noteContent-<%= submission.id %>"
          name="content"
          rows="3"
          placeholder="Escribe una nota sobre este documento..."
          required></textarea>
      </div>
      
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="bi bi-plus-circle"></i> Agregar nota
        </button>
        <button type="reset" class="btn btn-sm btn-secondary">
          <i class="bi bi-x-circle"></i> Limpiar
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .note-item {
    animation: slideIn 0.3s ease-in-out;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
