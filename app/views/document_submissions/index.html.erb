<!-- app/views/document_submissions/index.html.erb -->
<div class="container-fluid py-4" data-business-transaction-id="<%= @business_transaction.id %>">

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2>
          <i class="bi bi-file-earmark-check"></i>
          Checklist Documental
        </h2>
        <%= link_to business_transaction_path(@business_transaction), class: 'btn btn-outline-secondary' do %>
          <i class="bi bi-arrow-left"></i> Volver a Transacci√≥n
        <% end %>
      </div>
      <div class="text-muted mt-2">
        <strong>Transacci√≥n:</strong> <%= @business_transaction.id %> |
        <strong>Escenario:</strong> <%= @business_transaction.transaction_scenario&.name || 'Sin escenario' %> |
        <strong>Propiedad:</strong> <%= @business_transaction.property.address %>
      </div>
    </div>
  </div>

  <%= render 'shared/document_progress_summary', checklist: @checklist %>

  <div class="mb-3 d-flex gap-2">
    <button id="copy-whatsapp-btn" class="btn btn-success">
      <i class="bi bi-whatsapp"></i> Copiar para WhatsApp
    </button>
    <a href="<%= export_checklist_business_transaction_document_submissions_path(@business_transaction, format: :pdf) %>"
       class="btn btn-primary" target="_blank">
      <i class="bi bi-download"></i> Descargar PDF
    </a>
    <a href="<%= export_checklist_business_transaction_document_submissions_path(@business_transaction, format: :text) %>"
       class="btn btn-info" download="checklist_<%= @business_transaction.id %>.txt">
      <i class="bi bi-file-text"></i> Descargar TXT
    </a>
  </div>

  <script>
    document.getElementById('copy-whatsapp-btn')?.addEventListener('click', function() {
      const transactionId = <%= @business_transaction.id %>;
      const checklist = <%= @checklist.to_json.html_safe %>;

      let text = 'üìã CHECKLIST DOCUMENTAL\n';
      text += '‚ïê'.repeat(60) + '\n\n';
      text += `Transacci√≥n: #${transactionId}\n`;
      text += `Propiedad: <%= @business_transaction.property.address %>\n`;
      text += `Escenario: <%= @business_transaction.transaction_scenario&.name || 'Sin escenario' %>\n`;
      text += `Fecha: <%= I18n.l(Date.today, format: :long) %>\n\n`;

      text += 'üìä RESUMEN\n';
      text += '‚îÄ'.repeat(60) + '\n';
      text += `Total: ${checklist.summary.total} | `;
      text += `Cargados: ${checklist.summary.uploaded} | `;
      text += `Validados: ${checklist.summary.validated} | `;
      text += `Rechazados: ${checklist.summary.rejected} | `;
      text += `Progreso: ${checklist.summary.progress}%\n\n`;

      navigator.clipboard.writeText(text);
      alert('‚úÖ Copiado al portapapeles');
    });
  </script>

  <!-- PESTA√ëAS POR COPROPIETARIO -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <% @checklist[:copropietarios].each_with_index do |co_data, index| %>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= 'active' if index == 0 %>" 
                id="tab-<%= co_data[:co_owner][:id] %>" 
                data-bs-toggle="tab" 
                data-bs-target="#pane-<%= co_data[:co_owner][:id] %>" 
                type="button" 
                role="tab">
          <%= co_data[:co_owner][:name] %>
          <span class="badge bg-primary ms-2"><%= co_data[:documents][:list].sum { |cat| cat[:documents].count } %></span>
        </button>
      </li>
    <% end %>
  </ul>

  <!-- CONTENIDO DE LAS PESTA√ëAS -->
  <div class="tab-content">
    <% @checklist[:copropietarios].each_with_index do |co_data, index| %>
      <div class="tab-pane fade <%= 'show active' if index == 0 %>" 
           id="pane-<%= co_data[:co_owner][:id] %>" 
           role="tabpanel">
        
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead class="table-light">
              <tr>
                <th>Documento</th>
                <th>Estado</th>
                <th>Cargado</th>
                <th>Validado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% co_data[:documents][:list].each do |category| %>
                <% category[:documents].each do |doc| %>
                  <% submission = doc[:submission] %>
                  <tr id="document-row-<%= submission.id %>">
                    <td>
                      <strong><%= doc[:document_type][:name] %></strong>
                    </td>
                    <td>
                      <% if submission.document_file.attached? %>
                        <span class="badge bg-<%= submission.document_status&.name || 'secondary' %>">
                          <%= submission.document_status&.name || 'Desconocido' %>
                        </span>
                      <% else %>
                        <span class="badge bg-secondary">Pendiente Solicitud</span>
                      <% end %>
                    </td>
                    <td>
                      <% if submission.submitted_at %>
                        <small><%= submission.submitted_at.strftime('%d/%m/%Y') %></small>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if submission.validated_at %>
                        <small><%= submission.validated_at.strftime('%d/%m/%Y') %></small>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <% if submission.document_file.attached? %>
                          <button class="btn btn-outline-primary preview-btn" 
                                  data-submission-id="<%= submission.id %>"
                                  data-document-type="<%= submission.document_type&.name %>"
                                  title="Ver previsualizaci√≥n">
                            <i class="bi bi-eye"></i>
                          </button>
                          <a href="<%= download_business_transaction_document_submission_path(@business_transaction, submission) %>"
                             class="btn btn-outline-info"
                             title="Descargar">
                            <i class="bi bi-download"></i>
                          </a>
                        <% end %>

                        <% if current_user.admin? || current_user.agent? %>
                          <% if submission.document_file.attached? && !submission.validated? %>
                            <button class="btn btn-outline-success validate-btn"
                                    data-submission-id="<%= submission.id %>"
                                    title="Validar documento">
                              <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-outline-danger reject-btn"
                                    data-submission-id="<%= submission.id %>"
                                    title="Rechazar documento">
                              <i class="bi bi-x-circle"></i>
                            </button>
                          <% end %>
                        <% end %>

                        <% if !submission.document_file.attached? || (current_user == submission.uploaded_by || current_user.admin?) %>
                          <button class="btn btn-outline-warning upload-btn"
                                  data-submission-id="<%= submission.id %>"
                                  title="Cargar/Recargar documento">
                            <i class="bi bi-upload"></i>
                          </button>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </div>

  <!-- MODALES (sin cambios) -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">Previsualizaci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="previewContent" style="max-height: 70vh; overflow-y: auto;">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Cargar Documento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <form id="uploadForm" method="POST" enctype="multipart/form-data">
          <div class="modal-body">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <div class="mb-3">
              <label for="documentFile" class="form-label">Selecciona un archivo:</label>
              <input type="file" class="form-control" id="documentFile" name="document_file" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Cargar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="validateModal" tabindex="-1" aria-labelledby="validateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="validateModalLabel">Validar Documento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <form id="validateForm" method="POST">
          <div class="modal-body">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <div class="mb-3">
              <label for="validationNotes" class="form-label">Notas (opcional):</label>
              <textarea class="form-control" id="validationNotes" name="validation_notes" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Validar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectModalLabel">Rechazar Documento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <form id="rejectForm" method="POST">
          <div class="modal-body">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <div class="mb-3">
              <label for="rejectionReason" class="form-label">Motivo del rechazo:</label>
              <textarea class="form-control" id="rejectionReason" name="rejection_reason" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Rechazar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btxId = document.querySelector('[data-business-transaction-id]')?.dataset.businessTransactionId;

  document.querySelectorAll('.preview-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const submissionId = this.dataset.submissionId;
      const documentType = this.dataset.documentType;
      const previewContent = document.getElementById('previewContent');
      previewContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div></div>';

      fetch(`/business_transactions/${btxId}/document_submissions/${submissionId}/preview.json`)
        .then(r => r.json())
        .then(data => {
          let html = `<div class="preview-wrapper"><h6>${documentType}</h6><p class="text-muted small"><strong>Cargado:</strong> ${data.uploaded_at || 'N/A'} | <strong>Por:</strong> ${data.uploaded_by || 'Sistema'}<br><strong>Estado:</strong> ${data.status || 'Desconocido'} | <strong>An√°lisis:</strong> ${data.analysis.status_label || 'Pendiente'}</p>`;
          
          if (data.file_url) {
            if (data.content_type?.startsWith('image/')) {
              html += `<img src="${data.file_url}" style="max-width: 100%; max-height: 60vh; object-fit: contain;" alt="Previsualizaci√≥n">`;
            } else if (data.content_type === 'application/pdf') {
              html += `<embed src="${data.file_url}" style="width: 100%; height: 60vh;" type="application/pdf">`;
            } else {
              html += `<p class="alert alert-info">Archivo no previewable. <a href="${data.file_url}" target="_blank">Descargar</a></p>`;
            }
          } else {
            html += '<p class="alert alert-warning">No hay archivo cargado</p>';
          }
          
          if (data.analysis.legibility_score) {
            html += `<hr><p><strong>Puntuaci√≥n de legibilidad:</strong> ${data.analysis.legibility_score}%</p>`;
          }
          html += '</div>';
          previewContent.innerHTML = html;

          // ZOOM DE IM√ÅGENES CON SCROLL
          document.addEventListener('wheel', function(event) {
            const img = document.querySelector('.preview-wrapper img');
            if (!img) return;
            
            if (event.target === img || img.contains(event.target)) {
              event.preventDefault();
              
              if (event.deltaY < 0) {
                if (img.classList.contains('zoomed-2x')) return;
                if (img.classList.contains('zoomed')) {
                  img.classList.remove('zoomed');
                  img.classList.add('zoomed-2x');
                } else {
                  img.classList.add('zoomed');
                }
              } else {
                if (img.classList.contains('zoomed-2x')) {
                  img.classList.remove('zoomed-2x');
                  img.classList.add('zoomed');
                } else if (img.classList.contains('zoomed')) {
                  img.classList.remove('zoomed');
                }
              }
            }
          }, { passive: false });

          // CLICK PARA ZOOM
          document.addEventListener('click', function(event) {
            const img = event.target.closest('.preview-wrapper img');
            if (!img) return;
            
            if (img.classList.contains('zoomed-2x')) {
              img.classList.remove('zoomed-2x');
              img.classList.remove('zoomed');
            } else if (img.classList.contains('zoomed')) {
              img.classList.remove('zoomed');
              img.classList.add('zoomed-2x');
            } else {
              img.classList.add('zoomed');
            }
          });
        })
        .catch(err => {
          previewContent.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
        });

      const modal = new bootstrap.Modal(document.getElementById('previewModal'));
      modal.show();
    });
  });

  // UPLOAD
  document.querySelectorAll('.upload-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const submissionId = this.dataset.submissionId;
      document.getElementById('uploadForm').action = `/business_transactions/${btxId}/document_submissions/${submissionId}/upload`;
      const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
      modal.show();
    });
  });

  document.getElementById('uploadForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const action = this.action;
    fetch(action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.text())
    .then(() => {
      bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
      location.reload();
    })
    .catch(err => alert('Error: ' + err.message));
  });

  // VALIDATE
  document.querySelectorAll('.validate-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const submissionId = this.dataset.submissionId;
      document.getElementById('validateForm').action = `/business_transactions/${btxId}/document_submissions/${submissionId}/validate_document`;
      const modal = new bootstrap.Modal(document.getElementById('validateModal'));
      modal.show();
    });
  });

  document.getElementById('validateForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const action = this.action;
    fetch(action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.text())
    .then(() => {
      bootstrap.Modal.getInstance(document.getElementById('validateModal')).hide();
      location.reload();
    })
    .catch(err => alert('Error: ' + err.message));
  });

  // REJECT
  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const submissionId = this.dataset.submissionId;
      document.getElementById('rejectForm').action = `/business_transactions/${btxId}/document_submissions/${submissionId}/reject_document`;
      const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
      modal.show();
    });
  });

  document.getElementById('rejectForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const action = this.action;
    fetch(action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.text())
    .then(() => {
      bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
      location.reload();
    })
    .catch(err => alert('Error: ' + err.message));
  });
});
</script>

<style>
.preview-wrapper {
  padding: 20px;
  max-height: 70vh;
  overflow: auto;
  text-align: center;
  position: relative;
}

.preview-wrapper img {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  width: 100%;
  height: auto;
  object-fit: contain;
  max-width: 95%;
  margin: 0 auto;
  display: block;
  cursor: zoom-in;
  transition: transform 0.2s ease;
  transform-origin: center;
  zoom: 1;
}

.preview-wrapper img.zoomed {
  cursor: zoom-out;
  zoom: 1.5;
}

.preview-wrapper img.zoomed-2x {
  cursor: zoom-out;
  zoom: 2;
}

.preview-wrapper embed {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  width: 100%;
  height: auto;
  object-fit: contain;
  max-width: 95%;
  margin: 0 auto;
  display: block;
}

.modal-dialog {
  will-change: transform, opacity;
  transform: translateZ(0);
  max-width: 90vw !important;
}

.modal-lg {
  max-width: 90vw !important;
}

.modal-backdrop.show {
  opacity: 0.99;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

body.modal-open {
  transition: none !important;
}

/* ESTILOS PARA LAS PESTA√ëAS */
.nav-tabs {
  border-bottom: 2px solid #e9ecef;
}

.nav-tabs .nav-link {
  border: none;
  border-bottom: 3px solid transparent;
  color: #6c757d;
  font-weight: 500;
  transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
  border-bottom-color: #0d6efd;
  color: #0d6efd;
}

.nav-tabs .nav-link.active {
  border-bottom-color: #0d6efd;
  color: #0d6efd;
  background: none;
}

.nav-tabs .badge {
  font-size: 11px;
  padding: 3px 6px;
}

/* BADGES DE ESTADOS PERSONALIZADOS */
.badge.bg-rechazado {
  background-color: #dc3545 !important; /* Rojo */
  color: white;
}

.badge.bg-validado {
  background-color: #28a745 !important; /* Verde */
  color: white;
}

.badge.bg-pendiente {
  background-color: #ffc107 !important; /* Amarillo */
  color: #333;
}

.badge.bg-desconocido {
  background-color: #6c757d !important; /* Gris */
  color: white;
}

</style>
