<!-- app/views/document_submissions/preview.html.erb -->
<script>
  // üî¥ DESACTIVA TURBO globalmente en modales
  document.addEventListener('show.bs.modal', function() {
    Turbo.session.drive = false;
    console.log('Modal abierto - Turbo DESACTIVADO');
  });

  document.addEventListener('hidden.bs.modal', function() {
    // No reactive Turbo - mant√©n it off
    console.log('Modal cerrado - Turbo SIGUE DESACTIVADO');
  });

  // Tambi√©n bloquea Turbo Frame updates
  document.addEventListener('turbo:load', function() {
    Turbo.session.drive = false;
  });

  document.addEventListener('turbo:frame-load', function() {
    Turbo.session.drive = false;
  });
</script>

<div class="document-preview-container">
  <!-- Header con info del documento -->
  <div class="preview-header bg-light p-3 border-bottom">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h5 class="mb-1">
          <i class="bi bi-file-earmark-text"></i>
          <%= @submission.document_type.name %>
        </h5>
        <small class="text-muted">
          Subido: <%= @submission.submitted_at&.strftime('%d/%m/%Y %H:%M') %> |
          Por: <%= @submission.uploaded_by&.email %>
        </small>
      </div>
      <div class="col-md-4 text-end">
        <span class="badge <%= @submission.document_status&.name == 'validado' ? 'bg-success' : @submission.document_status&.name == 'rechazado' ? 'bg-danger' : 'bg-warning' %> fs-6">
          <%= @submission.document_status&.name&.titleize %>
        </span>
      </div>
    </div>
  </div>

  <!-- An√°lisis IA -->
  <% if @submission.analyzed? %>
    <div class="preview-analysis bg-info bg-opacity-10 p-3 border-bottom">
      <h6><i class="bi bi-robot"></i> An√°lisis de Calidad (OCR)</h6>

      <div class="row mb-3">
        <div class="col-md-3">
          <strong>Legibilidad:</strong>
          <div class="progress mt-1" style="height: 25px;">
            <div class="progress-bar <%= @submission.legibility_score.to_i >= 80 ? 'bg-success' : @submission.legibility_score.to_i >= 60 ? 'bg-warning' : 'bg-danger' %>"
                 role="progressbar"
                 style="width: <%= @submission.legibility_score %>%"
                 aria-valuenow="<%= @submission.legibility_score %>"
                 aria-valuemin="0"
                 aria-valuemax="100">
              <%= @submission.legibility_score&.round(1) %>%
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <strong>Auto-validado:</strong>
          <div class="mt-1">
            <% if @submission.auto_validated? %>
              <span class="badge bg-success"><i class="bi bi-check-lg"></i> S√≠</span>
            <% else %>
              <span class="badge bg-secondary"><i class="bi bi-dash-lg"></i> No</span>
            <% end %>
          </div>
        </div>

        <div class="col-md-3">
          <strong>Estado:</strong>
          <div class="mt-1">
            <span class="badge bg-info"><%= @submission.analysis_status&.titleize %></span>
          </div>
        </div>

        <div class="col-md-3">
          <strong>Analizado:</strong>
          <div class="mt-1">
            <small class="text-muted"><%= @submission.analyzed_at&.strftime('%d/%m/%Y %H:%M') %></small>
          </div>
        </div>
      </div>

      <!-- Detalles del an√°lisis -->
      <% if @submission.analysis_result.present? %>
        <div class="mt-2 pt-2 border-top">
          <strong>Detalles:</strong>
          <div class="bg-white p-2 border rounded mt-2" style="max-height: 120px; overflow-y: auto;">
            <% @submission.analysis_result.each do |key, value| %>
              <small class="d-block">
                <strong><%= key.humanize %>:</strong>
                <%= value.is_a?(Hash) || value.is_a?(Array) ? value.to_json : value %>
              </small>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- OCR extra√≠do -->
      <% if @submission.ocr_text.present? %>
        <div class="mt-2 pt-2 border-top">
          <strong>Texto (OCR):</strong>
          <div class="bg-white p-2 border rounded mt-1" style="max-height: 100px; overflow-y: auto;">
            <small><%= @submission.ocr_text %></small>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-info mt-3">
      <i class="bi bi-info-circle"></i> Documento a√∫n no ha sido analizado
    </div>
  <% end %>

  <!-- Documento principal -->
  <div class="preview-document p-3">
    <% if @submission.document_file.attached? %>
      <% if @submission.document_file.content_type.start_with?('image/') %>
        <div class="text-center">
          <%= image_tag @submission.document_file,
                        class: 'img-fluid border shadow-sm preview-image',
                        style: 'max-height: 70vh; cursor: zoom-in;',
                        data: { bs_toggle: 'modal', bs_target: '#imageZoomModal' } %>
        </div>
      <% elsif @submission.document_file.content_type == 'application/pdf' %>
        <div class="pdf-viewer">
          <embed src="<%= url_for(@submission.document_file) %>"
                 type="application/pdf"
                 width="100%"
                 height="600px">
          <p class="text-center mt-3">
            <a href="<%= url_for(@submission.document_file) %>"
               target="_blank"
               class="btn btn-outline-primary">
              <i class="bi bi-file-pdf"></i> Abrir PDF
            </a>
          </p>
        </div>
      <% else %>
        <div class="text-center p-5">
          <i class="bi bi-file-earmark display-1 text-muted"></i>
          <p class="mt-3">Tipo: <%= @submission.document_file.content_type %></p>
          <a href="<%= download_business_transaction_document_submission_path(@submission.business_transaction, @submission) %>"
             class="btn btn-primary">
            <i class="bi bi-download"></i> Descargar
          </a>
        </div>
      <% end %>
    <% else %>
      <div class="text-center p-5 text-muted">
        <i class="bi bi-file-x display-1"></i>
        <p class="mt-3">No hay archivo</p>
      </div>
    <% end %>
  </div>

  <!-- NOTAS -->
  <% if current_user.admin? || current_user.agent? %>
    <div class="preview-notes p-3 border-top bg-light">
      <h6 class="mb-3">
        <i class="bi bi-chat-dots"></i> Di√°logo
        <span class="badge bg-secondary"><%= @submission.document_notes.count %></span>
      </h6>

      <!-- Historial notas -->
      <div class="notes-container mb-3" style="max-height: 250px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
        <% if @submission.document_notes.any? %>
          <% @submission.document_notes.order(created_at: :asc).each do |note| %>
            <div class="note-item mb-2 pb-2 border-bottom">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong class="text-primary"><%= note.user.email %></strong>
                  <% if note.note_type == 'acceptance' %>
                    <span class="badge bg-success ms-1">Aprob√≥</span>
                  <% elsif note.note_type == 'rejection' %>
                    <span class="badge bg-danger ms-1">Rechaz√≥</span>
                  <% elsif note.note_type == 'comment' %>
                    <span class="badge bg-info ms-1">Comentario</span>
                  <% end %>
                  <br>
                  <small class="text-muted"><%= note.created_at.strftime('%d/%m/%Y %H:%M') %></small>
                </div>
              </div>
              <p class="mb-0 mt-1 small"><%= simple_format(note.content) %></p>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted text-center py-3 mb-0">Sin comentarios</p>
        <% end %>
      </div>

      <!-- FORM AGREGAR NOTA - SIN TURBO -->
      <div class="add-note-form">
        <form action="<%= add_note_business_transaction_document_submission_path(@submission.business_transaction, @submission) %>"
              method="POST"
              data-turbo="false"
              style="display: none;" id="noteForm"></form>

        <input type="text"
               name="content"
               class="form-control form-control-sm mb-2"
               id="noteInput"
               placeholder="Escribe tu comentario aqu√≠..."
               required>
        <button type="button"
                class="btn btn-sm btn-primary w-100"
                onclick="submitNoteForm()">
          Agregar nota
        </button>
      </div>
    </div>
  <% end %>

  <!-- ACCIONES -->
  <% if current_user.admin? || current_user.agent? %>
    <div class="preview-actions p-3 border-top bg-white">
      <div class="row g-2">
        <!-- VALIDAR -->
        <div class="col-md-6">
          <form action="<%= validate_document_business_transaction_document_submission_path(@submission.business_transaction, @submission) %>"
                method="POST"
                data-turbo="false"
                onsubmit="return confirm('¬øValidar este documento?')" style="display: inline;">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-check-circle"></i> Aceptar
            </button>
          </form>
        </div>

        <!-- RECHAZAR -->
        <div class="col-md-6">
          <button type="button"
                  class="btn btn-danger w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#rejectModal"
                  data-turbo="false"
                  onclick="document.getElementById('rejectForm').action = '<%= reject_document_business_transaction_document_submission_path(@submission.business_transaction, @submission) %>'">
            <i class="bi bi-x-circle"></i> Rechazar
          </button>
        </div>
      </div>

      <!-- Notas de validaci√≥n -->
      <% if @submission.validation_notes.present? %>
        <div class="mt-3 alert alert-info">
          <strong>Notas:</strong>
          <p class="mb-0 mt-2"><%= simple_format(@submission.validation_notes) %></p>
        </div>
      <% end %>
    </div>
  <% end %>

</div>

<!-- Modal Zoom Imagen -->
<div class="modal fade" id="imageZoomModal" tabindex="-1" data-turbo="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vista ampliada</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <% if @submission.document_file.attached? && @submission.document_file.content_type.start_with?('image/') %>
          <%= image_tag @submission.document_file, class: 'img-fluid' %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
function submitNoteForm() {
  const noteInput = document.getElementById('noteInput');
  const content = noteInput.value.trim();

  if (!content) {
    alert('Por favor escribe una nota');
    return;
  }

  const form = document.querySelector('#noteForm');
  const formData = new FormData();
  formData.append('content', content);
  formData.append('authenticity_token', document.querySelector('input[name="authenticity_token"]').value);

  fetch('<%= add_note_business_transaction_document_submission_path(@submission.business_transaction, @submission) %>', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRF-Token': document.querySelector('input[name="authenticity_token"]').value,
      'Accept': 'application/json'
    }
  })
  .then(response => {
    if (response.ok) {
      noteInput.value = '';
      alert('‚úÖ Nota agregada');
      // üöÄ SIN location.reload() - solo limpiar y mostrar mensaje
    } else {
      alert('Error al agregar nota');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al agregar nota');
  });
}
</script>

<style>
.preview-image {
  transition: transform 0.2s;
}
.preview-image:hover {
  transform: scale(1.02);
}

.note-item {
  border-radius: 4px;
}

.note-item:hover {
  background-color: #f8f9fa;
}

.notes-container {
  font-size: 0.9rem;
}

.preview-document {
  min-height: 400px;
  background: #f8f9fa;
}
</style>
