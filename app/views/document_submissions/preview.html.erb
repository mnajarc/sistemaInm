<!-- app/views/document_submissions/preview.html.erb -->
<!-- üî• ACTUALIZADA - SIN validation_status, SOLO document_status -->

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h3">üìÑ <%= @document_submission.document_type.name %></h1>
      <p class="text-muted">
        Cargado: <%= @document_submission.submitted_at&.strftime("%d/%m/%Y %H:%M") || "A√∫n no cargado" %>
      </p>
      <!-- üî• ID CR√çTICO PARA TURBO STREAM -->
      <span id="document_status_<%= @document_submission.id %>">
        <% status = @document_submission.document_status&.name %>
        <span class="badge <%= @document_submission.status_badge_class %>">
          <%= status || "Sin Estado" %>
        </span>
      </span>



    </div>
  </div>

  <div class="row">
    <!-- Preview -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body p-0" style="height: 600px; overflow: auto;">
          <% if @document_submission.document_file.attached? %>
            <% file = @document_submission.document_file.blob %>
            <% case File.extname(file.filename.to_s).downcase %>
              <% when '.pdf' %>
                <iframe src="<%= rails_blob_path(file, disposition: 'inline') %>"
                  style="width: 100%; height: 600px; border: none;"></iframe>
              <% when '.png', '.jpg', '.jpeg', '.gif', '.heic' %>
                <%= image_tag rails_blob_path(file), class: "img-fluid" %>
              <% else %>
                <p class="p-3">Formato no soportado</p>
            <% end %>
          <% else %>
            <p class="p-3 text-danger">‚ùå Sin archivo cargado</p>
          <% end %>
        </div>
        <div class="p-3 border-top">
          <% if @document_submission.document_file.attached? %>
            <%= link_to download_business_transaction_document_submission_path(@business_transaction, @document_submission),
                class: "btn btn-primary w-100" do %>
              ‚¨áÔ∏è Descargar
            <% end %>
          <% else %>
            <button class="btn btn-primary w-100" disabled>‚¨áÔ∏è Descargar</button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Actions & Info -->
    <div class="col-lg-4">
      <!-- Informaci√≥n del documento -->
      <div class="card mb-3">
        <div class="card-header bg-info bg-opacity-10">
          <strong>‚ÑπÔ∏è Informaci√≥n</strong>
        </div>
        <div class="card-body small">
          <p><strong>Tipo:</strong> <%= @document_submission.document_type.name %></p>
          <p><strong>Parte:</strong> <%= @document_submission.party_display_name %></p>
          <% if @document_submission.uploaded_by %>
            <p><strong>Por:</strong> <%= @document_submission.uploaded_by&.email %></p>
          <% end %>
          <p><strong>Estado:</strong>
            <span class="badge <%= "bg-success" if @document_submission.validated? %>">
              <%= @document_submission.document_status&.name || "Sin Estado" %>
            </span>
          </p>
          <% if @document_submission.expiry_date %>
            <p><strong>Vencimiento:</strong>
              <span class="<%= "text-danger" if @document_submission.expired? %>">
                <%= @document_submission.expiry_date.strftime("%d/%m/%Y") %>
              </span>
            </p>
          <% end %>
        </div>
      </div>

      <!-- ‚úÖ VALIDAR DOCUMENTO - Solo Agent/Admin -->
      <% if policy(@document_submission).validate? %>
        <div class="card border-success mb-3">
          <div class="card-header bg-success bg-opacity-10">
            <strong>‚úÖ Validar Documento</strong>
          </div>
          <div class="card-body">
          <%= form_with url: validate_business_transaction_document_submission_path(
                @business_transaction, @document_submission),
                method: :patch, local: true, data: { turbo: true } do |f| %>

            <div class="mb-3">
              <textarea name="notes" rows="2" placeholder="Notas (opcional)..."
                  class="form-control form-control-sm"></textarea>
            </div>
            <%= f.submit "‚úÖ Validar", class: "btn btn-success btn-sm w-100" %>
          <% end %>
          </div>
        </div>
      <% end %>

      <!-- ‚ùå RECHAZAR DOCUMENTO - Solo Agent/Admin -->
      <% if policy(@document_submission).reject? %>
        <div class="card border-danger mb-3">
          <div class="card-header bg-danger bg-opacity-10">
            <strong>‚ùå Rechazar Documento</strong>
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2">
              <em>Puedes rechazar este documento incluso si ya fue validado (en caso de error).</em>
            </p>
            <%= form_with url: reject_business_transaction_document_submission_path(
                  @business_transaction, @document_submission),
                  method: :patch, local: true, data: { turbo: true } do |f| %>

              <div class="mb-3">
                <%= f.text_area :reason, rows: 2, placeholder: "Motivo del rechazo (requerido)...",
                    class: "form-control form-control-sm", required: true %>
              </div>
              <%= f.submit "‚ùå Rechazar", class: "btn btn-danger btn-sm w-100" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- ‚è∞ MARCAR EXPIRADO - Solo Agent/Admin (en caso de error manual) -->
      <% if policy(@document_submission).mark_expired? %>
        <div class="card border-warning mb-3">
          <div class="card-header bg-warning bg-opacity-10">
            <strong>‚è∞ Marcar Expirado (Error Manual)</strong>
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2">
              <em>La expiraci√≥n es normalmente autom√°tica. Usa esto solo en caso de error manual.</em>
            </p>
            <%= form_with url: mark_expired_business_transaction_document_submission_path(
                  @business_transaction, @document_submission),
                  method: :patch, local: true, data: { turbo: true } do |f| %>

              <div class="mb-3">
                <%= f.text_area :reason, rows: 2, placeholder: "Motivo de expiraci√≥n (requerido)...",
                    class: "form-control form-control-sm", required: true %>
              </div>
              <%= f.submit "‚è∞ Marcar Expirado", class: "btn btn-warning btn-sm w-100" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Volver -->
      <%= link_to business_transaction_document_submissions_path(@business_transaction),
          class: "btn btn-outline-secondary btn-sm w-100" do %>
        ‚¨ÖÔ∏è Volver
      <% end %>
    </div>
  </div>

  <!-- üìù Notas y Comentarios - VISIBLES PARA TODOS -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <strong>üìù Comentarios y Notas</strong>
          <!-- ‚úÖ ACTUALIZADO - SIN validation_status, SOLO document_status -->
          <% if @document_submission.document_status&.name == 'rechazado' %>
            <span class="badge bg-danger float-end">‚ö†Ô∏è Documento Rechazado</span>
          <% elsif @document_submission.document_status&.name == 'expirado' %>
            <span class="badge bg-warning float-end">‚è∞ Documento Expirado</span>
          <% elsif @document_submission.validated? %>
            <span class="badge bg-success float-end">‚úÖ Documento Validado</span>
          <% end %>
        </div>
        <div class="card-body">
          <!-- ‚úÖ CONTENEDOR CON ID para Turbo Stream (CR√çTICO) -->
          <div id="form_note_container"></div>

          <!-- Formulario para agregar nota - TODOS PUEDEN si tienen permiso -->
          <% if policy(@document_submission).add_note? %>
            <div class="mt-4 pt-3 border-top">
              <h6>üí¨ Agregar Comentario</h6>

              <!-- Info contextual -->
              <% if @document_submission.uploaded_by_id == current_user.id %>
                <p class="small text-info mb-2">
                  <strong>‚ÑπÔ∏è</strong> Est√°s viendo un documento que <strong>enviaste t√∫</strong>.
                </p>
              <% elsif @document_submission.document_status&.name == 'rechazado' %>
                <p class="small text-warning mb-2">
                  <strong>‚ö†Ô∏è</strong> Este documento fue <strong>rechazado</strong>.
                  Puedes comentar para defender o replantear tu env√≠o.
                </p>
              <% end %>
              <!-- ‚úÖ CORRECTO - El formulario debe ser as√≠: -->
              <%= form_with url: add_note_business_transaction_document_submission_path(
                    @business_transaction, @document_submission),
                    method: :post, local: true do |f| %>
                <div class="mb-2">
                  <%= f.text_area :content, rows: 2, placeholder: "Escribe tu comentario...",
                      class: "form-control form-control-sm", required: true, id: "document_submission_content" %>
                </div>
                <div class="mb-2">
                  <%= f.hidden_field :note_type, value: 'comment' %>
                </div>
                <%= f.submit "üí¨ Agregar Comentario", class: "btn btn-primary btn-sm" %>
              <% end %>
            </div>
          <% end %>

          <div id="document_notes_list">
            <!-- Lista de notas existentes -->
            <% if @document_submission.document_notes.any? %>
              <% @document_submission.document_notes.order(created_at: :desc).each do |note| %>
                <div class="mb-3 pb-3 border-bottom">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <small class="text-muted">
                        <span class="badge bg-info"><%= note.note_type %></span>
                        <strong><%= note.user&.email || "Usuario" %></strong> ‚Ä¢
                        <%= time_ago_in_words(note.created_at) %>
                      </small>
                      <p class="mb-0 mt-2"><%= simple_format(note.content) %></p>
                    </div>
                    <% if policy(@document_submission).delete_note? %>
                      <%= button_to delete_note_business_transaction_document_submission_path(
                            @business_transaction, @document_submission),
                          method: :delete,
                          form_class: "d-inline ms-2",
                          class: "btn btn-sm btn-outline-danger",
                          data: { confirm: "¬øEliminar nota?" } do %>
                        üóëÔ∏è
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <p class="text-muted text-center py-3" id="no_notes_message">Sin comentarios a√∫n</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>