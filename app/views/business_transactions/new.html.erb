<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="mb-1">Nueva Transacci√≥n de Negocio</h2>
          <p class="text-muted mb-0">Complete todos los datos para crear la transacci√≥n</p>
        </div>
        <%= link_to "‚Üê Volver", business_transactions_path, class: "btn btn-outline-secondary" %>
      </div>

      <!-- FORM HTML PURO - SIN TURBO -->
      <form action="<%= business_transactions_path %>" method="POST" class="needs-validation" novalidate data-turbo="false">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <input type="hidden" name="utf8" value="‚úì">
        
        <div data-controller="co-owners">

        <!-- SECCI√ìN 1: DATOS B√ÅSICOS -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>1. Datos de la Transacci√≥n</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <label for="operation_type_id" class="form-label required">Tipo de Operaci√≥n</label>
                <select name="business_transaction[operation_type_id]" id="operation_type_id" class="form-select" required>
                  <option value="">Seleccione tipo de operaci√≥n...</option>
                  <% @operation_types.each do |op| %>
                    <option value="<%= op.id %>"><%= op.display_name %></option>
                  <% end %>
                </select>
              </div>
              <div class="col-md-4">
                <label for="start_date" class="form-label required">Fecha de Inicio</label>
                <input type="date" name="business_transaction[start_date]" id="start_date" class="form-control" value="<%= Date.current %>" required>
              </div>
              <div class="col-md-4">
                <label for="business_status_id" class="form-label">Estado</label>
                <select name="business_transaction[business_status_id]" id="business_status_id" class="form-select">
                  <option value="">Seleccione estado...</option>
                  <% @business_statuses.each do |status| %>
                    <option value="<%= status.id %>" <%= "selected" if status.name == 'available' %>>
                      <%= status.display_name %>
                    </option>
                  <% end %>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 2: PROPIEDAD -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-home me-2"></i>2. Propiedad</h5>
          </div>
          <div class="card-body">
            <label for="property_id" class="form-label required">Seleccionar Propiedad</label>
            <div class="input-group">
              <select name="business_transaction[property_id]" id="property_id" class="form-select" required>
                <option value="">Buscar por direcci√≥n...</option>
                <% @properties.each do |prop| %>
                  <option value="<%= prop.id %>"><%= prop.address %></option>
                <% end %>
              </select>
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newPropertyModal">
                <i class="bi bi-plus-circle"></i> Nueva
              </button>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 2.5: CLIENTES -->
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>2.5. Clientes de la Transacci√≥n</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- Cliente Ofertante -->
              <div class="col-md-6">
                <label for="offering_client_id" class="form-label required">Cliente Ofertante (Vendedor)</label>
                <div class="input-group">
                  <select name="business_transaction[offering_client_id]" id="offering_client_id" class="form-select" required>
                    <option value="">Seleccione cliente...</option>
                    <% @clients.each do |client| %>
                      <option value="<%= client.id %>"><%= client.display_name %></option>
                    <% end %>
                  </select>
                  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newClientModal">
                    <i class="bi bi-plus-circle"></i> Nuevo
                  </button>
                </div>
                <small class="text-muted">Cliente que ofrece/vende la propiedad</small>
              </div>

              <!-- Cliente Adquiriente -->
              <div class="col-md-6">
                <label for="acquiring_client_id" class="form-label">Cliente Adquiriente (Comprador)</label>
                <div class="input-group">
                  <select name="business_transaction[acquiring_client_id]" id="acquiring_client_id" class="form-select">
                    <option value="">Seleccione cliente (opcional)...</option>
                    <% @clients.each do |client| %>
                      <option value="<%= client.id %>"><%= client.display_name %></option>
                    <% end %>
                  </select>
                  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newClientModal">
                    <i class="bi bi-plus-circle"></i> Nuevo
                  </button>
                </div>
                <small class="text-muted">Cliente que compra/adquiere (dejar vac√≠o si a√∫n no existe)</small>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 3: COPROPIEDAD -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>3. Propietarios/Copropietarios</h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="co_ownership_type_id" class="form-label required">Tipo de Copropiedad</label>
                <select name="business_transaction[co_ownership_type_id]" id="co_ownership_type_id" class="form-select" required data-action="change->co-owners#updateCoOwnershipType">
                  <option value="">Seleccione tipo de copropiedad...</option>
                  <% @co_ownership_types.each do |type| %>
                    <option value="<%= type.id %>"><%= type.display_name %></option>
                  <% end %>
                </select>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <button type="button" class="btn btn-outline-success me-2" data-action="click->co-owners#autoSetup">
                  <i class="fas fa-magic me-1"></i> Setup Autom√°tico
                </button>
                <button type="button" class="btn btn-outline-primary" data-action="click->co-owners#addCoOwner">
                  <i class="fas fa-plus me-1"></i> Agregar
                </button>
              </div>
            </div>

            <!-- Lista de copropietarios -->
            <div id="co-owners-section" data-co-owners-target="container">
              <!-- Los co-owners se renderizan aqu√≠ -->
              <div class="co-owner-item border rounded p-3 mb-3" data-co-owners-target="item">
                <div class="row align-items-center">
                  <div class="col-md-4">
                    <label class="form-label">Cliente</label>
                    <select name="business_transaction[business_transaction_co_owners_attributes][][client_id]" class="form-select">
                      <option value="">Seleccionar cliente...</option>
                      <% @clients.each do |client| %>
                        <option value="<%= client.id %>"><%= client.display_name %></option>
                      <% end %>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">O escribir nombre</label>
                    <input type="text" name="business_transaction[business_transaction_co_owners_attributes][][person_name]" placeholder="Nombre completo" class="form-control">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Porcentaje</label>
                    <div class="input-group">
                      <input type="number" name="business_transaction[business_transaction_co_owners_attributes][][percentage]" class="form-control" step="0.01" min="0" max="100" value="100" data-action="input->co-owners#updatePercentages">
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Rol</label>
                    <select name="business_transaction[business_transaction_co_owners_attributes][][role]" class="form-select">
                      <option value="propietario">Propietario</option>
                      <option value="vendedor">Vendedor</option>
                      <option value="conyuge">C√≥nyuge</option>
                      <option value="heredero">Heredero</option>
                    </select>
                  </div>
                  <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-outline-danger btn-sm d-block" data-action="click->co-owners#removeCoOwner">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Info de porcentajes -->
            <div class="mt-3 p-3 bg-light rounded">
              <div class="row text-center">
                <div class="col-md-4">
                  <small class="text-muted">Total Asignado:</small>
                  <div class="fw-bold" data-co-owners-target="totalPercentage">0%</div>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Disponible:</small>
                  <div class="fw-bold" data-co-owners-target="remainingPercentage">100%</div>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Copropietarios:</small>
                  <div class="fw-bold" data-co-owners-target="totalCount">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 4: DETALLES FINANCIEROS -->
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>4. Detalles Financieros</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label for="price" class="form-label required">Precio de Operaci√≥n</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" name="business_transaction[price]" id="price" class="form-control" step="0.01" min="0" required>
                </div>
              </div>
              <div class="col-md-6">
                <label for="commission_percentage" class="form-label">Comisi√≥n (%)</label>
                <div class="input-group">
                  <input type="number" name="business_transaction[commission_percentage]" id="commission_percentage" class="form-control" step="0.01" min="0" max="100">
                  <span class="input-group-text">%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="d-flex justify-content-between mb-4">
          <%= link_to "Cancelar", business_transactions_path, class: "btn btn-secondary btn-lg" %>
          <button type="submit" class="btn btn-primary btn-lg px-5">Crear Transacci√≥n</button>
        </div>

        </div> <!-- cierre data-controller -->
      </form> <!-- cierre form HTML puro -->

      <!-- MODAL: Crear Nueva Propiedad -->
      <div class="modal fade" id="newPropertyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-house-add"></i> Crear Nueva Propiedad</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="newPropertyForm">
                <div class="mb-3">
                  <label for="prop_title" class="form-label">T√≠tulo</label>
                  <input type="text" id="prop_title" class="form-control" placeholder="Ej: Casa moderna">
                </div>
                <div class="mb-3">
                  <label for="prop_type" class="form-label">Tipo de Propiedad</label>
                  <select id="prop_type" class="form-select">
                    <option value="">Selecciona tipo</option>
                    <% @property_types.each do |type| %>
                      <option value="<%= type.id %>"><%= type.display_name %></option>
                    <% end %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="prop_description" class="form-label">Descripci√≥n</label>
                  <textarea id="prop_description" class="form-control" rows="3"></textarea>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prop_price" class="form-label">Precio</label>
                      <input type="number" id="prop_price" class="form-control" step="0.01" min="0">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prop_built" class="form-label">√Årea Construida (m¬≤)</label>
                      <input type="number" id="prop_built" class="form-control" step="0.01" min="0">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prop_lot" class="form-label">√Årea Terreno (m¬≤)</label>
                      <input type="number" id="prop_lot" class="form-control" step="0.01" min="0">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label for="prop_beds" class="form-label">Rec√°maras</label>
                      <input type="number" id="prop_beds" class="form-control" min="0">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label for="prop_baths" class="form-label">Ba√±os</label>
                      <input type="number" id="prop_baths" class="form-control" min="0">
                    </div>
                  </div>
                </div>
                <hr>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="prop_street" class="form-label">Calle</label>
                      <input type="text" id="prop_street" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="mb-3">
                      <label for="prop_ext" class="form-label">No. Ext</label>
                      <input type="text" id="prop_ext" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="mb-3">
                      <label for="prop_int" class="form-label">No. Int</label>
                      <input type="text" id="prop_int" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="prop_cp" class="form-label">CP</label>
                      <input type="text" id="prop_cp" class="form-control">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="prop_neighborhood" class="form-label">Colonia</label>
                      <input type="text" id="prop_neighborhood" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="prop_municipality" class="form-label">Municipio</label>
                      <input type="text" id="prop_municipality" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="prop_state" class="form-label">Estado</label>
                      <input type="text" id="prop_state" class="form-control">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prop_city" class="form-label">Ciudad</label>
                      <input type="text" id="prop_city" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prop_country" class="form-label">Pa√≠s</label>
                      <input type="text" id="prop_country" class="form-control">
                    </div>
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="savePropertyBtn">
                <i class="bi bi-check"></i> Crear Propiedad
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL: Crear Nuevo Cliente -->
      <div class="modal fade" id="newClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-person-plus"></i> Crear Nuevo Cliente</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="newClientForm">
                <div class="mb-3">
                  <label for="client_name" class="form-label">Nombre Completo</label>
                  <input type="text" id="client_name" class="form-control" placeholder="Juan P√©rez Garc√≠a" required>
                </div>
                <div class="mb-3">
                  <label for="client_email" class="form-label">Email</label>
                  <input type="email" id="client_email" class="form-control" placeholder="cliente@email.com" required>
                </div>
                <div class="mb-3">
                  <label for="client_phone" class="form-label">Tel√©fono</label>
                  <input type="tel" id="client_phone" class="form-control" placeholder="+52 5512345678">
                </div>
                <div class="mb-3">
                  <label for="client_address" class="form-label">Domicilio</label>
                  <input type="text" id="client_address" class="form-control" placeholder="Calle Principal 123">
                </div>
                <div class="mb-3">
                  <input type="checkbox" id="client_active" class="form-check-input" checked>
                  <label for="client_active" class="form-check-label">Cliente Activo</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="saveClientBtn">
                <i class="bi bi-check"></i> Crear Cliente
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- JAVASCRIPT PARA LOS MODALES -->
      <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Script de modales cargado - FORM HTML PURO');

        // ============================================================
        // GUARDAR NUEVA PROPIEDAD
        // ============================================================
        document.getElementById('savePropertyBtn')?.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('üíæ Guardando nueva propiedad...');
          
          const formData = new FormData();
          formData.append('property[title]', document.getElementById('prop_title').value);
          formData.append('property[property_type_id]', document.getElementById('prop_type').value);
          formData.append('property[description]', document.getElementById('prop_description').value);
          formData.append('property[price]', document.getElementById('prop_price').value);
          formData.append('property[built_area_m2]', document.getElementById('prop_built').value);
          formData.append('property[lot_area_m2]', document.getElementById('prop_lot').value);
          formData.append('property[bedrooms]', document.getElementById('prop_beds').value);
          formData.append('property[bathrooms]', document.getElementById('prop_baths').value);
          formData.append('property[street]', document.getElementById('prop_street').value);
          formData.append('property[exterior_number]', document.getElementById('prop_ext').value);
          formData.append('property[interior_number]', document.getElementById('prop_int').value);
          formData.append('property[postal_code]', document.getElementById('prop_cp').value);
          formData.append('property[neighborhood]', document.getElementById('prop_neighborhood').value);
          formData.append('property[municipality]', document.getElementById('prop_municipality').value);
          formData.append('property[state]', document.getElementById('prop_state').value);
          formData.append('property[city]', document.getElementById('prop_city').value);
          formData.append('property[country]', document.getElementById('prop_country').value);

          fetch('<%= properties_path %>', {
            method: 'POST',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
              'Accept': 'application/json'
            },
            body: formData
          })
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(data => {
            console.log('‚úÖ Propiedad creada:', data);
            if (data.id) {
              const select = document.getElementById('property_id');
              const option = new Option(data.title || data.address, data.id, true, true);
              select.add(option);
              bootstrap.Modal.getInstance(document.getElementById('newPropertyModal')).hide();
              document.getElementById('newPropertyForm').reset();
              alert('‚úÖ Propiedad creada: ' + (data.title || data.address));
            } else {
              alert('‚ùå Error: ' + (data.errors?.[0] || 'Error desconocido'));
            }
          })
          .catch(e => {
            console.error('‚ùå Error al crear propiedad:', e);
            alert('‚ùå Error de conexi√≥n al crear propiedad');
          });
        });

        // ============================================================
        // GUARDAR NUEVO CLIENTE
        // ============================================================
        document.getElementById('saveClientBtn')?.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('üíæ Guardando nuevo cliente...');
          
          const clientName = document.getElementById('client_name').value.trim();
          const clientEmail = document.getElementById('client_email').value.trim();
          
          if (!clientName) {
            alert('‚ùå El nombre del cliente es obligatorio');
            return;
          }

          // Separar nombre en partes (simple)
          const nameParts = clientName.split(' ');
          const firstNames = nameParts.slice(0, -1).join(' ') || clientName;
          const firstSurname = nameParts[nameParts.length - 1] || clientName;

          const formData = new FormData();
          formData.append('client[first_names]', firstNames);
          formData.append('client[first_surname]', firstSurname);
          formData.append('client[email]', clientEmail);
          formData.append('client[phone]', document.getElementById('client_phone').value);
          formData.append('client[notes]', document.getElementById('client_address').value);

          fetch('<%= clients_path %>', {
            method: 'POST',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
              'Accept': 'application/json'
            },
            body: formData
          })
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(data => {
            console.log('‚úÖ Cliente creado:', data);
            if (data.id) {
              // Construir nombre completo
              const displayName = data.display_name || `${data.first_names} ${data.first_surname}`;
              
              // Agregar a AMBOS selects de clientes
              const offeringSelect = document.getElementById('offering_client_id');
              const acquiringSelect = document.getElementById('acquiring_client_id');
              
              if (offeringSelect) {
                const option1 = new Option(displayName, data.id, true, true);
                offeringSelect.add(option1);
                console.log('‚úÖ Cliente agregado a offering_client_id');
              }
              
              if (acquiringSelect) {
                const option2 = new Option(displayName, data.id);
                acquiringSelect.add(option2);
                console.log('‚úÖ Cliente agregado a acquiring_client_id');
              }
              
              // Cerrar modal y limpiar
              bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();
              document.getElementById('newClientForm').reset();
              alert('‚úÖ Cliente creado: ' + displayName);
            } else {
              alert('‚ùå Error: ' + (data.errors?.join(', ') || 'Error desconocido'));
            }
          })
          .catch(e => {
            console.error('‚ùå Error al crear cliente:', e);
            alert('‚ùå Error de conexi√≥n al crear cliente');
          });
        });

      }); // Fin DOMContentLoaded
      </script>

    </div>
  </div>
</div>
