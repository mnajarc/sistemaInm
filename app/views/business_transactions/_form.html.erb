<!-- app/views/business_transactions/_form.html.erb -->
<%= form_with model: transaction, 
             local: true,
             class: "needs-validation",
             data: { turbo: false } do |form| %>

  <% if transaction.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h6 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <%= pluralize(transaction.errors.count, "error") %> impidieron guardar la transacción:
      </h6>
      <ul class="mb-0">
        <% transaction.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <!-- SECCIÓN 1: DATOS BÁSICOS -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>1. Datos de la Transacción</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= form.label :operation_type_id, "Tipo de Operación", class: "form-label required" %>
          <%= form.select :operation_type_id, 
                         options_from_collection_for_select(@operation_types, :id, :display_name, transaction.operation_type_id), 
                         { prompt: "Seleccione tipo de operación..." }, 
                         { class: "form-select", required: true } %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :start_date, "Fecha de Inicio", class: "form-label required" %>
          <%= form.date_field :start_date, 
                             class: "form-control", 
                             required: true %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :business_status_id, "Estado", class: "form-label" %>
          <%= form.select :business_status_id, 
                         options_from_collection_for_select(@business_statuses, :id, :display_name, transaction.business_status_id), 
                         {}, { class: "form-select" } %>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCIÓN 2: PROPIEDAD -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0"><i class="fas fa-home me-2"></i>2. Propiedad</h5>
    </div>
    <div class="card-body">
      <%= form.label :property_id, "Seleccionar Propiedad", class: "form-label required" %>
      <%= form.select :property_id, 
                     options_from_collection_for_select(@properties, :id, :address, transaction.property_id), 
                     { prompt: "Buscar por dirección..." },
                     { class: "form-select", required: true } %>
    </div>
  </div>

  <!-- SECCIÓN 3: CLIENTES -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">
      <h5 class="mb-0"><i class="fas fa-users me-2"></i>3. Clientes de la Transacción</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :offering_client_id, "Cliente Ofertante (Vendedor)", class: "form-label required" %>
          <%= form.select :offering_client_id, 
                         options_from_collection_for_select(@clients, :id, :display_name, transaction.offering_client_id), 
                         { prompt: "Seleccione cliente..." },
                         { class: "form-select", required: true } %>
          <small class="text-muted">Cliente que ofrece/vende la propiedad</small>
        </div>

        <div class="col-md-6 mb-3">
          <%= form.label :acquiring_client_id, "Cliente Adquiriente (Comprador)", class: "form-label" %>
          <%= form.select :acquiring_client_id, 
                         options_from_collection_for_select(@clients, :id, :display_name, transaction.acquiring_client_id), 
                         { prompt: "Seleccione cliente (opcional)..." },
                         { class: "form-select" } %>
          <small class="text-muted">Cliente que compra/adquiere (dejar vacío si aún no existe)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCIÓN 4: COPROPIEDAD -->
  <div class="card mb-4">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0"><i class="fas fa-users me-2"></i>4. Propietarios/Copropietarios</h5>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <%= form.label :co_ownership_type_id, "Tipo de Copropiedad", class: "form-label required" %>
          <%= form.select :co_ownership_type_id, 
                         options_from_collection_for_select(@co_ownership_types, :id, :display_name, transaction.co_ownership_type_id),
                         { prompt: "Seleccione tipo de copropiedad..." },
                         { class: "form-select", required: true } %>
        </div>
      </div>

      <!-- Lista de copropietarios existentes -->
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light">
            <tr>
              <th>Cliente/Nombre</th>
              <th>Porcentaje</th>
              <th>Rol</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% if transaction.business_transaction_co_owners.any? %>
              <% transaction.business_transaction_co_owners.each do |co_owner| %>
                <tr>
                  <td><%= co_owner.display_name %></td>
                  <td><%= co_owner.percentage %>%</td>
                  <td><span class="badge bg-secondary"><%= co_owner.role&.humanize %></span></td>
                  <td>
                    <%= link_to "Editar", "#", class: "btn btn-sm btn-outline-primary" %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="text-center text-muted">
                  <em>No hay copropietarios registrados</em>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SECCIÓN 5: DETALLES FINANCIEROS -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>5. Detalles Financieros</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :price, "Precio de Operación", class: "form-label required" %>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <%= form.number_field :price, 
                                 class: "form-control", 
                                 step: 0.01, 
                                 min: 0,
                                 required: true %>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <%= form.label :commission_percentage, "Comisión (%)", class: "form-label" %>
          <div class="input-group">
            <%= form.number_field :commission_percentage, 
                                 class: "form-control", 
                                 step: 0.01, 
                                 min: 0, 
                                 max: 100 %>
            <span class="input-group-text">%</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <%= form.label :notes, "Notas", class: "form-label" %>
          <%= form.text_area :notes, 
                            class: "form-control", 
                            rows: 3,
                            placeholder: "Notas adicionales sobre la transacción..." %>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTONES DE ACCIÓN -->
  <div class="d-flex justify-content-between mb-4">
    <%= link_to "Cancelar", transaction.persisted? ? business_transaction_path(transaction) : business_transactions_path, 
               class: "btn btn-secondary btn-lg" %>
    
    <%= form.submit transaction.persisted? ? "Actualizar Transacción" : "Crear Transacción", 
                   class: "btn btn-primary btn-lg px-5" %>
  </div>

<% end %>