<%= form_with model: transaction, local: true, class: "needs-validation", novalidate: true do |form| %>
    <% if transaction.errors.any? %>
      <div class="alert alert-danger">
        <h6><%= pluralize(transaction.errors.count, "error") %> impidieron guardar:</h6>
        <ul class="mb-0">
          <% transaction.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
  
    <div class="row">
      <!-- Información de la Propiedad -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Propiedad y Operación</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :property_id, "Propiedad", class: "form-label" %>
              <%= form.collection_select :property_id,
                  Property.joins(:user).where(users: { role: current_user.role }),
                  :id, :title,
                  { prompt: 'Selecciona propiedad' },
                  { class: "form-select" } %>
            </div>
  
            <div class="mb-3">
              <%= form.label :operation_type_id, "Tipo de Operación", class: "form-label" %>
              <%= form.collection_select :operation_type_id,
                  OperationType.active.order(:sort_order),
                  :id, :display_name,
                  { prompt: 'Selecciona operación' },
                  { class: "form-select" } %>
            </div>
  
            <div class="mb-3">
              <%= form.label :business_status_id, "Estado", class: "form-label" %>
              <%= form.collection_select :business_status_id,
                  BusinessStatus.active.order(:sort_order),
                  :id, :display_name,
                  { prompt: 'Selecciona estado' },
                  { class: "form-select" } %>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Información del Cliente -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Clientes</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :offering_client_id, "Cliente Ofertante", class: "form-label" %>
              <%= form.collection_select :offering_client_id,
                  Client.all,
                  :id, :name,
                  { prompt: 'Selecciona cliente' },
                  { class: "form-select" } %>
              <div class="form-text">Quien ofrece la propiedad</div>
            </div>
  
            <div class="mb-3">
              <%= form.label :acquiring_client_id, "Cliente Adquiriente", class: "form-label" %>
              <%= form.collection_select :acquiring_client_id,
                  Client.all,
                  :id, :name,
                  { prompt: 'Selecciona cliente (opcional)' },
                  { class: "form-select" } %>
              <div class="form-text">Quien está interesado (puede agregarse después)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="row">
      <!-- Términos Financieros -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Términos Financieros</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :price, "Precio", class: "form-label" %>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <%= form.number_field :price, class: "form-control", step: 0.01, min: 0 %>
              </div>
            </div>
  
            <div class="mb-3">
              <%= form.label :commission_percentage, "Comisión (%)", class: "form-label" %>
              <div class="input-group">
                <%= form.number_field :commission_percentage, class: "form-control", 
                    step: 0.01, min: 0, max: 100, value: transaction.commission_percentage || 3.0 %>
                <span class="input-group-text">%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Fechas -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Fechas</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :start_date, "Fecha de Inicio", class: "form-label" %>
              <%= form.date_field :start_date, class: "form-control", 
                  value: transaction.start_date || Date.current %>
            </div>
  
            <div class="mb-3">
              <%= form.label :estimated_completion_date, "Fecha Estimada de Cierre", class: "form-label" %>
              <%= form.date_field :estimated_completion_date, class: "form-control" %>
              <div class="form-text">Fecha estimada para completar la transacción</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Notas -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Información Adicional</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <%= form.label :notes, "Notas", class: "form-label" %>
          <%= form.text_area :notes, class: "form-control", rows: 4, 
              placeholder: "Notas, condiciones especiales, etc." %>
        </div>
      </div>
    </div>
  
    <!-- Botones -->
    <div class="d-flex gap-2">
      <%= form.submit transaction.persisted? ? "Actualizar Transacción" : "Crear Transacción", 
          class: "btn btn-primary" %>
      <%= link_to "Cancelar", transaction.persisted? ? transaction : business_transactions_path, 
          class: "btn btn-secondary" %>
    </div>
  <% end %>
  <div class="mb-3">
  <%= form.label :property_id, "Propiedad", class: "form-label" %>
  <%= form.collection_select :property_id,
      Property.includes(:business_transactions, :operation_type)
              .where(users: { role: current_user.role }),
      :id, 
      ->(property) { 
        "#{property.title} - #{property.address} " \
        "#{property.has_active_transaction_for?(OperationType.find(params[:operation_type_id] || 1)) ? '⚠️ (Operación activa)' : '✅'}"
      },
      { prompt: 'Selecciona propiedad' },
      { class: "form-select" } %>
  <div class="form-text">
    ⚠️ Las propiedades con "Operación activa" no permiten transacciones duplicadas del mismo tipo
  </div>
</div>
