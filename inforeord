--------------------------------------------
Archivo:  app/controllers/initial_contact_forms_controller.rb
--------------------------------------------
```ruby
# app/controllers/initial_contact_forms_controller.rb
class InitialContactFormsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_form, only: [:show, :edit, :update, :destroy, :convert_to_transaction, :suggest_acquisition_method, 
                                    :edit_property_modal, :update_property_from_modal,
                                    :edit_client_modal, :update_client_from_modal,
                                    :edit_co_owners_modal, :create_co_owner]
  before_action :authorize_form, except: [:index, :new, :create]

  def index
    # Base query con eager loading
    base_scope = InitialContactForm
      .includes(
        :agent,
        :client,
        :property,
        :business_transaction,
        :property_acquisition_method,
        :operation_type,
        :contract_signer_type
      )
    
    # Filtro por rol
    if current_user.superadmin? || current_user.admin?
      @forms = base_scope.all
    elsif current_user.agent.present?
      @forms = base_scope.where(agent_id: current_user.agent.id)
    else
      redirect_to root_path, alert: '‚ö†Ô∏è No tienes permisos para ver formularios.'
      return
    end
    
    # Filtro por agente (admin/superadmin)
    if params[:agent_id].present? && (current_user.superadmin? || current_user.admin?)
      @forms = @forms.where(agent_id: params[:agent_id])
    end
    
    # Filtro por estado
    if params[:status].present?
      @forms = @forms.where(status: params[:status])
    end
    
    # Filtro por m√©todo de adquisici√≥n
    if params[:acquisition_method_id].present?
      @forms = @forms.where(property_acquisition_method_id: params[:acquisition_method_id])
    end
    
    # Filtro por tipo de operaci√≥n
    if params[:operation_type_id].present?
      @forms = @forms.where(operation_type_id: params[:operation_type_id])
    end
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # Filtro por periodo - CORREGIDO
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if params[:period].present?
      @forms = @forms.where('created_at >= ?', case params[:period]
      when 'today'
        Time.current.beginning_of_day
      when 'week'
        Time.current.beginning_of_week
      when 'month'
        Time.current.beginning_of_month
      when 'quarter'
        3.months.ago
      when 'year'
        Time.current.beginning_of_year
      else
        0.years.ago
      end)
    end
    
    # B√∫squeda por nombre de propietario
    if params[:owner_name].present?
      @forms = @forms.where(
        "general_conditions->>'owner_or_representative_name' ILIKE ?", 
        "%#{params[:owner_name]}%"
      )
    end
    
    # B√∫squeda por identificador
    if params[:property_identifier].present?
      @forms = @forms.where(
        "opportunity_identifier ILIKE ?", 
        "%#{params[:property_identifier]}%"
      )
    end
    
    # Ordenamiento y paginaci√≥n
    @forms = @forms.order(created_at: :desc).page(params[:page]).per(20)
    
    # Datos para dropdowns (solo si es admin/superadmin)
    if current_user.superadmin? || current_user.admin?
      @agents = Agent.includes(:user).order('users.name')
    end
    
    @acquisition_methods = PropertyAcquisitionMethod.order(:name)
    @operation_types = OperationType.order(:name)
  end

  def new
    @initial_contact_form = InitialContactForm.new(agent: current_user.agent)
    load_form_data
  end
  
  def create
    @initial_contact_form = InitialContactForm.new(form_params)
    @initial_contact_form.agent = current_user.agent unless @initial_contact_form.agent.present?

    unless @initial_contact_form.agent.present?
      redirect_to root_path, alert: "No tienes un agente asignado. Contacta al administrador."
      return
    end

    # Detectar qu√© bot√≥n se presion√≥
    @initial_contact_form.status = case
                                    when params[:save_draft].present? then :draft
                                    when params[:complete].present? then :completed
                                    else :draft
                                    end





    if @initial_contact_form.save
      notice_message = @initial_contact_form.auto_generated_identifier ? 
                      "‚úÖ Formulario creado. Identificador: #{@initial_contact_form.opportunity_identifier}" :
                      "‚úÖ Formulario creado exitosamente"
      
      redirect_to @initial_contact_form, notice: notice_message
    else



      # ‚úÖ AQU√ç: Pasar la variable de instancia a la vista
      load_form_data
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    load_form_data
  end

  def update
    
    # üîß AUTO-VINCULAR PROPIEDAD SI NO TIENE
    if @initial_contact_form.property_id.blank? && @initial_contact_form.property_info.present?
      street = @initial_contact_form.property_info['street']
      ext_num = @initial_contact_form.property_info['exterior_number']
      int_num = @initial_contact_form.property_info['interior_number']
      neighborhood = @initial_contact_form.property_info['neighborhood']
      municipality = @initial_contact_form.property_info['municipality']
      state = @initial_contact_form.property_info['state']
      
      # Buscar propiedad por ubicaci√≥n
      property = Property.find_by_location(street, ext_num, int_num, neighborhood, municipality, state)
      
      if property.present?
        @initial_contact_form.property_id = property.id
        Rails.logger.info "‚úì Propiedad vinculada autom√°ticamente: #{property.property_id}"
      else
        Rails.logger.warn "‚ö† No se encontr√≥ propiedad para: #{street} #{ext_num} #{int_num}"
      end
    end
    
    # üîò DETECTAR QU√â BOT√ìN SE PRESION√ì
    @initial_contact_form.assign_attributes(form_params)
    @initial_contact_form.status = case
                                    when params[:save_draft].present? then :draft
                                    when params[:complete].present? then :completed
                                    else @initial_contact_form.status
                                    end
    
    # üíæ GUARDAR
    if @initial_contact_form.save
      notice_message = @initial_contact_form.auto_generated_identifier ? 
                        '‚úÖ Formulario actualizado. ‚ö†Ô∏è Identificador generado autom√°ticamente.' :
                        '‚úÖ Formulario actualizado exitosamente'
      redirect_to @initial_contact_form, notice: notice_message
    else
      load_form_data
      render :edit, status: :unprocessable_entity
    end
  end



  def destroy
    @form.destroy
    redirect_to initial_contact_forms_url, notice: '‚úÖ Formulario eliminado'
  end
  



  def convert_to_transaction

    @transaction = @form.convert_to_transaction!

    if @transaction
      redirect_to business_transaction_path(@transaction),
                  notice: '‚úÖ Convertido a Transacci√≥n de Negocio exitosamente'
    else
      redirect_to @form, alert: "‚ùå No se pudo convertir el formulario"
    end
  rescue StandardError => e
    Rails.logger.error "Error en convert_to_transaction: #{e.class} - #{e.message}"
    Rails.logger.error e.backtrace.join("\n")
    redirect_to @form, alert: "‚ùå Error inesperado: #{e.message}"
  end




  
  def suggest_acquisition_method
    suggestion = AcquisitionMethodSuggestion.create!(
      user: current_user,
      initial_contact_form: @form,
      suggested_name: params[:suggested_name],
      legal_basis: params[:legal_basis]
    )
    
    render json: { status: 'success', suggestion_id: suggestion.id }
  rescue StandardError => e
    render json: { status: 'error', message: e.message }, status: :unprocessable_entity
  end

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # MODALES - M√âTODOS P√öBLICOS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  def edit_property_modal
    @form_id = params[:id]
    respond_to do |format|
      format.turbo_stream
      format.html { render :edit_property_modal }
    end
  end
  
  
  def update_property_from_modal
    @form = InitialContactForm.find(params[:id])
    
    # Actualizar property_info
    @form.property_info = {
      'street' => params.dig(:property_info, :street),
      'exterior_number' => params.dig(:property_info, :exterior_number),
      'interior_number' => params.dig(:property_info, :interior_number),
      'neighborhood' => params.dig(:property_info, :neighborhood),
      'municipality' => params.dig(:property_info, :municipality),
      'city' => params.dig(:property_info, :city),
      'postal_code' => params.dig(:property_info, :postal_code),
      'country' => 'M√©xico'
    }
    
    # CORRECCI√ìN: Usar deep_merge en lugar de reemplazar
    current_acquisition_details = @form.acquisition_details || {}
    @form.acquisition_details = current_acquisition_details.merge({
      'state' => params.dig(:acquisition_details, :state),
      'land_use' => params.dig(:acquisition_details, :land_use)
    }.compact)  # compact elimina nils
    
    if @form.save
      redirect_to @form, notice: "‚úÖ Datos de propiedad actualizados"
    else
      render :edit_property_modal, status: :unprocessable_entity
    end
  end



  

  def edit_client_modal
    @form = InitialContactForm.find(params[:id])
    
    # En lugar de renderizar un modal, redirigir al CRUD de clientes
    redirect_to edit_client_path(@form.id), notice: 'Editar datos del cliente'
  end








  
  def edit_co_owners_modal
    @form_id = params[:id]
    @co_owners_count = @form.acquisition_details&.dig('co_owners_count')&.to_i
    @co_ownership_links = @form.business_transaction&.co_ownership_links || []
    
    respond_to do |format|
      format.turbo_stream
      format.html { render :edit_co_owners_modal }
    end
  end
  
  def create_co_owner
    # Validar entrada
    unless params[:co_owner_name].present? && params[:co_owner_email].present?
      return render json: { 
        errors: { base: 'Nombre y email del copropietario son requeridos' } 
      }, status: :unprocessable_entity
    end
    
    # Crear o encontrar cliente copropietario
    co_owner = Client.find_or_create_by(
      email: params[:co_owner_email]
    ) do |client|
      client.name = params[:co_owner_name]
      client.phone = params[:co_owner_phone]
      client.address = params[:co_owner_address]
      client.city = params[:co_owner_city]
      client.state = params[:co_owner_state]
    end
    
    if co_owner.save
      # Crear v√≠nculo de copropiedad
      link = CoOwnershipLink.new(
        primary_client: @form.client,
        co_owner_client: co_owner,
        initial_contact_form: @form,
        ownership_percentage: params[:ownership_percentage],
        relationship_type: params[:relationship_type],
        notes: params[:notes]
      )
      
      if link.save
        render json: { 
          id: link.id, 
          opportunity_id: link.co_owner_opportunity_id,
          status: 'success'
        }
      else
        render json: { 
          errors: link.errors.full_messages 
        }, status: :unprocessable_entity
      end
    else
      render json: { 
        errors: co_owner.errors.full_messages 
      }, status: :unprocessable_entity
    end
  end



  # Redirigir a CRUD de cliente
  def new_client_for_form
    @form = InitialContactForm.find(params[:id])
    
    # Crear un cliente asociado a este formulario
    # Por ahora, solo redirigir a nueva p√°gina de cliente
    # Luego se puede mejorar para pre-llenar datos
    
    redirect_to new_client_path(form_id: @form.id), notice: 'Edita los datos del cliente'
  end

  # Redirigir a CRUD de propiedad
  def new_property_for_form
    @form = InitialContactForm.find(params[:id])
    
    # Crear una propiedad asociada a este formulario
    # Por ahora, solo redirigir a nueva p√°gina de propiedad
    
    redirect_to new_property_path(form_id: @form.id), notice: 'Edita los datos de la propiedad'
  end

  # M√©todo antiguo para compatibilidad (opcional, puede eliminarse despu√©s)




  def update_client_from_modal
    @form = InitialContactForm.find(params[:id])
    general_conditions = @form.general_conditions || {}
    
    general_conditions['owner_or_representative_name'] = params.dig(:general_conditions, :owner_or_representative_name) || general_conditions['owner_or_representative_name']
    general_conditions['owner_phone'] = params.dig(:general_conditions, :owner_phone) || general_conditions['owner_phone']
    general_conditions['owner_email'] = params.dig(:general_conditions, :owner_email) || general_conditions['owner_email']
    general_conditions['civil_status'] = params.dig(:general_conditions, :civil_status) || general_conditions['civil_status']
    general_conditions['marriage_regime_id'] = params.dig(:general_conditions, :marriage_regime_id) || general_conditions['marriage_regime_id']
    general_conditions['notes'] = params.dig(:general_conditions, :notes) || general_conditions['notes']
    
    if @form.update(general_conditions: general_conditions)
      respond_to do |format|
        format.json { render json: { success: true, message: 'Cliente actualizado' } }
      end
    else
      respond_to do |format|
        format.json { render json: { success: false, errors: @form.errors }, status: :unprocessable_entity }
      end
    end
  end

  private

  def set_form
    @initial_contact_form = InitialContactForm.find(params[:id])
    @form = @initial_contact_form 
  end
  
  def authorize_form
    return if current_user.superadmin? || current_user.admin?
    
    unless @form.agent.user == current_user
      redirect_to root_path, alert: '‚ùå No tienes permiso para acceder'
    end
  end

  def load_form_data
    @acquisition_methods = PropertyAcquisitionMethod.active.order(:name)
    @contract_signers = ContractSignerType.active.order(:name)
    @marriage_regimes = MarriageRegime.active.order(:name)
    @operation_types = OperationType.active.order(:sort_order)
    
    # JSON seguro - escapar correctamente
    @acquisition_method_codes = JSON.generate(
      PropertyAcquisitionMethod.active.pluck(:id, :code).to_h
    )
  end

  def form_params
    params.require(:initial_contact_form).permit(
      :agent_id,
      :property_acquisition_method_id,
      :contract_signer_type_id,
      :operation_type_id,
      :client_id,
      :property_id,
      :status,
      :agent_notes,
      :form_source,
      :acquisition_clarification,
      :opportunity_identifier,
      
      general_conditions: [
        :first_names,
        :first_surname,
        :second_surname,
        :owner_or_representative_name,
        :owner_phone,
        :owner_email,
        :owner_address,
        :domicile_type,
        :civil_status,
        :marriage_regime_id,
        :current_civil_status,
        :current_marriage_regime_id,
        :notes
      ],
      
      acquisition_details: [
        :co_owners_count,
        :has_co_owners,
        :state,
        :land_use,
        :has_relationship,
        :relationship_type,
        :acquired_pre_2014,
        :heirs_count,
        :all_living,
        :deceased_count,
        :all_married,
        :single_heirs_count,
        :deceased_civil_status,
        :inheritance_from,
        :inheritance_from_other,
        :parents_were_married,
        :parents_marriage_regime,
        :has_testamentary_succession,
        :succession_planned_date,
        :succession_authority,
        :succession_type,
        :has_judicial_sentence,
        :has_notarial_deed,
        :document_type,
        :donor_name,
        :donor_relationship,
        :donor_relationship_other,
        :beneficiaries_count,
        :creditors_count
      ],
      
      property_info: [
        :address,
        :asking_price,
        :estimated_price,
        :bedrooms,
        :bathrooms,
        :built_area_m2,
        :lot_area_m2,
        :acquisition_date,
        :property_use,
        :has_improvements,
        :mortgage_bank,
        :street,
        :exterior_number,
        :interior_number,
        :neighborhood,
        :postal_code,
        :municipality,
        :city,
        :country
      ],
      
      current_status: [
        :has_active_mortgage,
        :mortgage_balance,
        :monthly_payment,
        :mortgage_payments_current,
        :in_collection_agency,
        :mortgage_notes,
        :has_extensions,
        :extensions_reported,
        :extensions_notes,
        :has_additions,
        :additions_registered,
        :additions_notes,
        :has_renovations,
        :knows_renovation_cost,
        :renovation_cost,
        :renovation_notes,
        :is_in_condominium,
        :condominium_regime,
        :has_condominium_rules,
        :has_maintenance_clearance,
        :has_rental_units,
        :rental_units_count,
        :apartment_units_count,
        :apartments_natural_light,
        :apartments_access,
        :apartments_have_kitchen,
        :apartments_finish_type,
        :commercial_units_count,
        :commercial_access,
        :commercial_shutters_count,
        :commercial_modifiable,
        :rental_units_notes
      ],
      
      tax_exemption: [
        :first_home_sale,
        :lived_last_5_years,
        :ine_matches_deed,
        :previous_sales_last_3_years,
        :previous_sale_date,
        :estimated_capital_gain,
        :qualifies_for_exemption
      ],
      
      promotion_preferences: [
        :allows_signage,
        :allows_flyers_with_address,
        :allows_open_house,
        :preferred_contact_method,
        :contact_hours,
        :special_instructions,
        signage_types: []
      ]
    )
  end

end
```
--------------------------------------------
Archivo:  app/models/business_transaction.rb
--------------------------------------------
```ruby
class BusinessTransaction < ApplicationRecord
  include FolioGenerator
  belongs_to :listing_agent, class_name: "User"
  belongs_to :current_agent, class_name: "User"
  belongs_to :selling_agent, class_name: "User", optional: true
  belongs_to :offering_client, class_name: "Client"
  belongs_to :acquiring_client, class_name: "Client", optional: true
  belongs_to :property
  belongs_to :operation_type
  belongs_to :business_status
  belongs_to :transaction_scenario, optional: true
  belongs_to :co_ownership_type, optional: true
  belongs_to :property_acquisition_method, optional: true
 
  after_create :assign_transaction_scenario_by_category
  after_commit :setup_documents_on_creation, on: :create
  before_destroy :check_active_offers  
  before_destroy :reset_initial_contact_form  

  has_one :initial_contact_form, dependent: :nullify

  has_many :document_submissions, dependent: :destroy
  has_many :agent_transfers, dependent: :destroy
  has_many :business_transaction_co_owners, inverse_of: :business_transaction, dependent: :destroy
  has_many :offers, dependent: :destroy
  alias_method :co_owners, :business_transaction_co_owners
  accepts_nested_attributes_for :business_transaction_co_owners,
                                allow_destroy: true,
                                reject_if: proc { |attributes| attributes['client_id'].blank? && attributes['person_name'].blank? }
  accepts_nested_attributes_for :property, allow_destroy: false, reject_if: :all_blank

  validates :start_date, presence: true
  validates :price, presence: true, numericality: { greater_than: 0 }
  validate :validate_acquisition_method_requirements
 
  scope :active, -> { joins(:business_status).where(business_statuses: { name: ["available", "reserved"] }) }
  scope :completed, -> { joins(:business_status).where(business_statuses: { name: ["sold", "rented"] }) }
  

  # M√©todo unificado para obtener el agente responsable
  def assigned_agent
    current_agent || selling_agent || listing_agent
  end

  # Helper para email con fallback
  def assigned_agent_email
    assigned_agent&.email || 'sin-agente@sistemainm.local'
  end

  # Helper para nombre completo
  def assigned_agent_name
    assigned_agent&.full_name || assigned_agent&.email || 'Sin agente asignado'
  end
def audit_trail
  []  # Retorna array vac√≠o por ahora
end

def co_ownership_notes
  nil  # O retorna un valor por defecto
end

  def transfer_to_agent!(new_agent, reason, transferred_by)
    transaction do
      agent_transfers.create!(
        from_agent: current_agent,
        to_agent: new_agent,
        transferred_by: transferred_by,
        reason: reason,
        transferred_at: Time.current
      )
      update!(current_agent: new_agent)
    end
  end
  def revenue
    return 0 unless completed?
    (price * (commission_percentage || 0) / 100).round(2)
  end

  def completed?
    %w[sold rented].include?(business_status.name)
  end

  def available?
    business_status.name == "available"
  end

  def total_ownership_percentage
    business_transaction_co_owners.active.sum(:percentage)
  end

  def is_single_owner?
    business_transaction_co_owners.active.count == 1
  end

  
def generate_property_identifier(operation_type_code, property_name)
  sanitized_name = StringNormalizer.unaccent(property_name)
    .strip
    .downcase
    .gsub(/[^a-z0-9\s-]/, '')
    .gsub(/[\s-]+/, '_')
    .gsub(/^_|_$/, '')

  "#{operation_type_code}_#{sanitized_name}"
end


 
  
  def create_required_documents_v2!(scenario)
    return unless scenario.present?

    Rails.logger.info "=" * 80
    Rails.logger.info "üìã CREANDO DOCUMENTOS REQUERIDOS - V2 (SIN DUPLICADOS)"
    Rails.logger.info "BT ID: #{id} | Scenario: #{scenario.name}"
    Rails.logger.info "=" * 80

    # Rastrear documentos creados para evitar duplicados en el mismo proceso
    created_doc_map = {}  # { "doc_type_id:party_type" => true }

    scenario.scenario_documents.each do |scenario_doc|
      doc_type = scenario_doc.document_type
      party_type = scenario_doc.party_type
      only_principal = scenario_doc.only_for_principal?

      # CLAVE DEDUPLICACI√ìN: Prevenir documentos duplicados
      # Si ya procesamos este tipo de documento para este tipo de parte en este loop, saltamos.
      doc_key = "#{doc_type.id}:#{party_type}"
      
      if created_doc_map[doc_key]
        Rails.logger.info "‚è≠Ô∏è  SALTANDO DUPLICADO: #{doc_type.name} (#{party_type}) - YA CREADO"
        next
      end

      Rails.logger.info "\nüîç Procesando: #{doc_type.name}"
      Rails.logger.info "   party_type: #{party_type}"
      Rails.logger.info "   only_principal: #{only_principal}"

      # Determinar copropietarios destino
      target_co_owners = if only_principal
                           business_transaction_co_owners.where(role: 'propietario')
                         else
                           map_party_type_to_co_owners(party_type)
                         end

      Rails.logger.info "   Creando para #{target_co_owners.count} copropietario(s):"

      target_co_owners.each do |co_owner|
        Rails.logger.info "      ‚Üí #{co_owner.person_name} (#{co_owner.role})"

        # CLAVE IDEMPOTENCIA: find_or_create_by previene duplicados en BD
        # Si se corre el proceso dos veces, no crea dobles.
        submission = DocumentSubmission.find_or_create_by!(
          business_transaction_id: id,
          business_transaction_co_owner_id: co_owner.id,
          document_type_id: doc_type.id
        ) do |sub|
          sub.party_type = party_type
          sub.notes = "Requerido por escenario: #{scenario.name}"
          # Si necesitas copiar m√°s atributos del scenario_doc, hazlo aqu√≠
        end

        Rails.logger.info "         ‚úÖ DocSub ID: #{submission.id}"
      end

      # Marcar como creado para esta combinaci√≥n
      created_doc_map[doc_key] = true
    end

    Rails.logger.info "\n" + "=" * 80
    Rails.logger.info "‚úÖ RESUMEN FINAL"
    Rails.logger.info "   Documento combinations procesadas: #{created_doc_map.count}"
    Rails.logger.info "   Total DocumentSubmissions: #{document_submissions.count}"
    Rails.logger.info "=" * 80
  end



  private


  def map_party_type_to_co_owners(party_type)
      case party_type
      when 'copropietario_principal', 'propietario', 'vendedor', 'due√±o'
        # Ajusta estos roles seg√∫n tu l√≥gica de negocio exacta
        business_transaction_co_owners.where(role: 'propietario')
      when 'adquiriente', 'comprador', 'arrendatario'
        # Generalmente los documentos de adquiriente se manejan diferente o no tienen co-owners,
        # pero si tienes co-owners tipo 'comprador', agr√©galos aqu√≠.
        # Si 'adquiriente' es solo la contraparte y no est√° en co_owners, retorna vac√≠o.
        [] 
      when 'copropietario'
        business_transaction_co_owners.where(role: ['propietario', 'copropietario'])
      when 'ambos', 'todos'
        business_transaction_co_owners
      else
        []
      end
    end



  # ============================================================
  # VALIDACI√ìN: No borrar si hay ofertas activas
  # ============================================================
  def check_active_offers
    if offers.active.exists?
      errors.add(:base, "No se puede borrar: hay ofertas activas en progreso. Rechaza o cancela todas las ofertas primero.")
      throw :abort
    end
  end


  # ============================================================
  # CALLBACK: Reestablecer InitialContactForm cuando se borra BT
  # ============================================================
  def reset_initial_contact_form
    return unless initial_contact_form.present?
    
    initial_contact_form.update!(
      status: :completed,
      business_transaction_id: nil
    )
    
    Rails.logger.info "‚úÖ InitialContactForm #{initial_contact_form.id} reestablecida a estado 'completed'"
  end
  
  def validate_acquisition_method_requirements
    return unless property_acquisition_method.present?
    
    if property_acquisition_method.requires_heirs? && 
       inheritance_details['heirs_count'].blank?
      errors.add(:inheritance_details, "es requerido para #{property_acquisition_method.name}")
    end
    
    if property_acquisition_method.requires_judicial_sentence? && 
       inheritance_details['judicial_sentence_number'].blank?
      errors.add(:inheritance_details, "debe incluir n√∫mero de sentencia judicial")
    end
  end


# ============================================================
# CALLBACK 1: Asignar TransactionScenario autom√°ticamente
# ============================================================
def assign_transaction_scenario_by_category
  return if transaction_scenario.present?  # Si ya tiene scenario, no hacer nada
  
  # Determinar category basado en operation_type.name
  category = determine_scenario_category
  return unless category
  
  # Buscar scenario por categor√≠a
  scenario = TransactionScenario.find_by(category: category, active: true)
  
  if scenario
    update_column(:transaction_scenario_id, scenario.id)
    Rails.logger.info "‚úÖ Scenario asignado autom√°ticamente: #{scenario.name}"
  else
    Rails.logger.warn "‚ö†Ô∏è  No se encontr√≥ scenario para categor√≠a: #{category}"
  end
rescue StandardError => e
  Rails.logger.error "‚ùå Error asignando scenario: #{e.message}"
end


# Determinar categor√≠a del scenario basado en operation_type
def determine_scenario_category
  return nil unless operation_type.present?
  
  case operation_type.name
  when 'sale'
    'compraventa'
  when 'rent'
    # Detectar si es habitacional o comercial
    if property&.property_type&.name.to_s.include?('apartment') || 
       property&.property_type&.name.to_s.include?('house')
      'renta_habitacional'
    else
      'renta_comercial'
    end
  else
    nil
  end
end


# ============================================================
# CALLBACK 2: Crear DocumentSubmissions requeridos
# ============================================================


  def setup_documents_on_creation
    return if initial_contact_form.present?
    return unless transaction_scenario.present?

    
    DocumentSetupService.new(self).setup_required_documents
  rescue StandardError => e
    Rails.logger.error "‚ùå Error creando documentos para transacci√≥n #{id}: #{e.message}"
    raise
  end


  def must_have_co_owners
    active_co_owners = if new_record?
                         business_transaction_co_owners.reject(&:marked_for_destruction?)
                       else
                         business_transaction_co_owners.where(active: true)
                       end

    if active_co_owners.empty?
      errors.add(:business_transaction_co_owners, "Debe tener al menos un propietario/copropietario")
    end
  end

  def ownership_percentages_sum_to_100
    return if business_transaction_co_owners.empty?

    active_co_owners = if new_record?
                         business_transaction_co_owners.reject(&:marked_for_destruction?)
                       else
                         business_transaction_co_owners.where(active: true)
                       end

    return if active_co_owners.empty?

    total = active_co_owners.sum(&:percentage)

    unless total.round(2) == 100.0
      errors.add(:business_transaction_co_owners, "Los porcentajes deben sumar exactamente 100% (actual: #{total.round(2)}%)")
    end
  end
end```
--------------------------------------------
Archivo:  app/models/document_submission.rb
--------------------------------------------
```ruby
# app/models/document_submission.rb
# VERSI√ìN LIMPIA: SIN validation_status ENUM - SOLO document_status
#
# ========================================================================
# CAMPOS DE VALIDACI√ìN (dos flujos posibles)
# ========================================================================
# validated_by_id    ‚Üí Usuario que APROB√ì/RECHAZ√ì el documento (acci√≥n final)
# validation_user_id ‚Üí Usuario que REVIS√ì el documento (auditor√≠a/supervisi√≥n)
# validated_at       ‚Üí Timestamp de la acci√≥n de validaci√≥n
# auto_validated     ‚Üí Boolean - ¬øfue aprobado autom√°ticamente por OCR?
# validation_notes   ‚Üí Notas de la validaci√≥n (motivo rechazo, observaciones)
# validated_notes    ‚Üí [LEGACY - Verificar si se usa. Candidata a deprecar]
#
# FLUJO MANUAL:   Admin revisa ‚Üí mark_as_validated!(admin)
#                  ‚Üí validated_by = admin, validation_user = admin
# FLUJO AUTO:     OCR aprueba ‚Üí mark_as_auto_validated!(result)
#                  ‚Üí validated_by = nil, auto_validated = true
# FLUJO MIXTO:    OCR pre-valida ‚Üí Admin confirma ‚Üí mark_as_validated!(admin)
#                  ‚Üí auto_validated queda true, validation_user = admin
# ========================================================================

class DocumentSubmission < ApplicationRecord
  # ========================================================================
  # RELACIONES
  # ========================================================================

  belongs_to :business_transaction
  belongs_to :document_type
  belongs_to :document_status, optional: true
  belongs_to :submitted_by, polymorphic: true, optional: true
  belongs_to :validated_by, class_name: 'User', optional: true
  belongs_to :uploaded_by, class_name: 'User', optional: true,
             foreign_key: 'uploaded_by_id'
  belongs_to :business_transaction_co_owner, optional: true
  belongs_to :validation_user, class_name: 'User', optional: true,
             foreign_key: 'validation_user_id'

  has_many :document_notes, dependent: :destroy
  has_many :document_reviews, dependent: :destroy

  # Active Storage
  has_one_attached :document_file do |attachable|
    attachable.variant :thumb, resize_to_limit: [200, 200]
    attachable.variant :medium, resize_to_limit: [800, 800]
  end

  # ========================================================================
  # VALIDACIONES
  # ========================================================================

  validates :document_type_id,
            uniqueness: {
              scope: [:business_transaction_id, :business_transaction_co_owner_id],
              message: 'ya fue asignado a este copropietario en esta transacci√≥n'
            },
            if: -> { business_transaction_co_owner_id.present? }

  validates :document_type_id,
            uniqueness: {
              scope: [:business_transaction_id, :party_type],
              message: 'ya fue asignado para este tipo de parte en esta transacci√≥n'
            },
            if: -> { business_transaction_co_owner_id.nil? }

  validates :party_type, presence: true, inclusion: {
    in: %w[oferente adquiriente copropietario copropietario_principal]
  }

  validates :business_transaction_co_owner_id,
    presence: true,
    if: -> { party_type.in?(%w[copropietario copropietario_principal]) }

  validates :analysis_status,
    inclusion: { in: %w[pending processing completed failed] },
    allow_nil: true

  validates :business_transaction_id, presence: true
  validates :document_type_id, presence: true

  validate :validate_document_file_type
  validate :validate_document_file_size

  # ========================================================================
  # SCOPES
  # ========================================================================

  # Por party_type
  scope :for_oferente, -> { where(party_type: 'oferente') }
  scope :for_adquiriente, -> { where(party_type: 'adquiriente') }
  scope :for_copropietario, -> { where(party_type: ['copropietario', 'copropietario_principal']) }
  scope :for_co_owner, ->(co_owner) { where(business_transaction_co_owner: co_owner) }
  scope :by_party, ->(party) { where(party_type: party) }

  # Por estado del documento
  scope :pending, -> {
    joins(:document_status).where(document_statuses: { name: 'pendiente_solicitud' })
  }
  scope :completed, -> {
    joins(:document_status).where(document_statuses: { name: 'validado_vigente' })
  }
  scope :validated, -> {
    joins(:document_status).where(document_statuses: { name: 'validado_vigente' })
  }
  scope :rejected, -> {
    joins(:document_status).where(document_statuses: { name: 'rechazado' })
  }

  # Por carga del documento
  scope :pending_upload, -> { where(submitted_at: nil) }
  scope :uploaded, -> { where.not(submitted_at: nil) }

  # Por an√°lisis
  scope :pending_analysis, -> { where(analysis_status: 'pending') }
  scope :analyzed, -> { where.not(analysis_status: 'pending') }
  scope :auto_validated, -> { where(auto_validated: true) }
  scope :pending_validation, -> {
    joins(:document_status).where(document_statuses: { name: 'pendiente_validacion' })
  }

  # Por fecha de expiraci√≥n
  scope :expired, -> { where('expiry_date < ?', Date.current) }
  scope :expiring_soon, -> { where('expiry_date BETWEEN ? AND ?', Date.current, 30.days.from_now) }
  scope :valid_date, -> { where('expiry_date IS NULL OR expiry_date >= ?', Date.current) }

  # ========================================================================
  # CALLBACKS
  # ========================================================================

  before_create :set_default_status
  after_create_commit :schedule_analysis, if: :document_file_attached?
  after_update :notify_status_change, if: :saved_change_to_document_status_id?

  # ========================================================================
  # M√âTODOS DE ESTADO
  # ========================================================================

  def analyzed?
    analysis_status.present? && analysis_status != 'pending'
  end

  def expired?
    return false unless expiry_date.present?
    expiry_date < Date.current
  end

  def expiring_soon?
    return false unless expiry_date.present?
    days_until_expiry = (expiry_date - Date.current).to_i
    days_until_expiry >= 0 && days_until_expiry <= 30
  end

  def validated?
    validated_at.present? && document_status&.name == 'validado_vigente'
  end

  def valid_for_use?
    uploaded? && validated? && !expired?
  end

  def pending?
    document_status&.name == 'pendiente_solicitud'
  end

  def completed?
    document_status&.name.in?(['validado_vigente', 'validado'])
  end

  def uploaded?
    submitted_at.present?
  end

  def pending_validation?
    uploaded? && document_status&.name == 'pendiente_validacion'
  end

  def has_files?
    document_file.attached?
  end

  # ========================================================================
  # HELPERS DE VALIDACI√ìN
  # Qui√©n valid√≥, por qu√© flujo, para mostrar en vistas y auditor√≠a
  # ========================================================================

  # ¬øQui√©n es el responsable final? (priorizar revisi√≥n humana)
  def validator
    validation_user || validated_by
  end

  def human_validated?
    validation_user.present?
  end

  def auto_validated_only?
    auto_validated? && validation_user.nil?
  end

  def validator_name
    if validation_user.present?
      "#{validation_user.name} (revisi√≥n manual)"
    elsif validated_by.present?
      validated_by.name
    elsif auto_validated?
      "Validaci√≥n autom√°tica (OCR)"
    else
      "Sin validar"
    end
  end

  # ========================================================================
  # M√âTODOS DE LEGIBILIDAD Y AN√ÅLISIS
  # ========================================================================

  def legibility_status
    return 'unknown' if legibility_score.nil? || legibility_score.zero?

    case legibility_score
    when 0...40 then 'poor'
    when 40...70 then 'fair'
    when 70...90 then 'good'
    else 'excellent'
    end
  end

  def analysis_status_label
    case analysis_status
    when 'pending' then 'Pendiente'
    when 'processing' then 'Procesando'
    when 'completed' then 'Completado'
    when 'failed' then 'Error'
    else 'Desconocido'
    end
  end

  # ========================================================================
  # M√âTODOS DE CAMBIO DE ESTADO
  # ========================================================================

  def mark_as_received!
    return unless document_status

    update!(
      document_status: DocumentStatus.find_by(name: 'recibido_revision'),
      submitted_at: Time.current
    )
  end

  # Validaci√≥n HUMANA ‚Äî Admin/Superadmin aprueba el documento
  def mark_as_validated!(user, notes: nil)
    update!(
      document_status: DocumentStatus.find_by(name: 'validado_vigente'),
      validated_by: user,
      validation_user: user,
      validated_at: Time.current,
      validation_notes: notes
    )
  end

  # Validaci√≥n AUTOM√ÅTICA ‚Äî OCR/AI aprueba sin intervenci√≥n humana
  def mark_as_auto_validated!(analysis_result = nil)
    update!(
      document_status: DocumentStatus.find_by(name: 'validado_vigente'),
      validated_at: Time.current,
      auto_validated: true,
      analysis_result: analysis_result
    )
    # validated_by y validation_user quedan nil intencionalmente
    # Esto permite que un admin revise despu√©s si lo requiere
  end

  # Rechazo ‚Äî Siempre humano, crea review para auditor√≠a
  def reject!(reason, user)
    document_reviews.create!(
      user: user,
      action: 'rechazado',
      notes: reason
    )

    update!(
      document_status: DocumentStatus.find_by(name: 'rechazado'),
      validated_by: user,
      validation_user: user,
      validated_at: Time.current,
      validation_notes: reason
    )
  end

  # ========================================================================
  # M√âTODOS DE VISUALIZACI√ìN
  # ========================================================================

  def status_badge_class
    return 'bg-secondary' unless uploaded?

    case document_status&.name
    when 'validado_vigente' then 'bg-success'
    when 'rechazado' then 'bg-danger'
    when 'vencido' then 'bg-dark'
    when 'pendiente_solicitud' then 'bg-warning'
    when 'recibido_revision' then 'bg-info'
    when 'solicitado_cliente' then 'bg-info'
    when 'observaciones' then 'bg-warning'
    else 'bg-secondary'
    end
  end

  def party_display_name
    case party_type
    when 'oferente'
      business_transaction_co_owner.present? ?
        "#{business_transaction_co_owner.person_name} (Copropietario)" :
        'Oferente'
    when 'adquiriente'
      'Adquiriente'
    when 'copropietario', 'copropietario_principal'
      business_transaction_co_owner.present? ?
        business_transaction_co_owner.person_name :
        'Copropietario'
    else
      party_type.titleize
    end
  end

  def download_url
    return unless uploaded?

    Rails.application.routes.url_helpers.rails_blob_path(
      document_file,
      disposition: 'attachment'
    )
  end

  def can_reupload?
    document_status&.name.in?(['rechazado', 'expirado']) || submitted_at.blank?
  end

  # ========================================================================
  # NOTAS Y REVIEWS
  # ========================================================================

  def latest_review
    document_reviews.recent.first
  end

  def reviews_count
    document_reviews.count
  end

  def reviewed_by?(user)
    document_reviews.exists?(user: user)
  end

  def review_history
    document_reviews.recent.includes(:user)
  end

  def last_note
    document_notes.recent.first
  end

  def add_note(user, content, note_type = 'comment')
    document_notes.create!(
      user: user,
      content: content,
      note_type: note_type
    )
  end

  # ========================================================================
  # PRIVADOS
  # ========================================================================

  private

  def validate_document_file_type
    return unless document_file.attached?

    allowed_types = %w[image/png image/jpg image/jpeg application/pdf image/heic]
    unless allowed_types.include?(document_file.content_type)
      errors.add(:document_file, 'debe ser PNG, JPG, HEIC o PDF')
    end
  end

  def validate_document_file_size
    return unless document_file.attached?

    if document_file.byte_size > 10.megabytes
      errors.add(:document_file, 'no debe exceder 10MB')
    end
  end

  def schedule_analysis
    DocumentAnalysisJob.perform_later(id) if defined?(DocumentAnalysisJob)
  end

  def document_file_attached?
    document_file.attached?
  end

  def set_default_status
    self.document_status ||= DocumentStatus.find_by(name: 'pendiente_solicitud')
    self.analysis_status ||= 'pending'
  end

  def notify_status_change
    # DocumentStatusNotificationJob.perform_later(self.id)
  end
end
```
--------------------------------------------
Archivo:  app/models/properties.rb
--------------------------------------------
```ruby
```
--------------------------------------------
Archivo:  app/models/property_types.rb
--------------------------------------------
```ruby
```
--------------------------------------------
Archivo:  app/models/initial_contact_form.rb
--------------------------------------------
```ruby
# app/models/initial_contact_form.rb
# REFACTORIZACI√ìN FASE 2A
# ‚úÖ M√©todos zombie eliminados
# ‚úÖ Callbacks consolidados (11 ‚Üí 7)
# ‚úÖ StringNormalizer extra√≠do
# ‚úÖ Identificador regenerable si cambian datos
# ‚úÖ Cat√°logos de BD en lugar de hardcodeo
# Fecha: 2026-02-10

class InitialContactForm < ApplicationRecord
  include FolioGenerator
  # ============================================================
  # RELACIONES
  # ============================================================
  belongs_to :agent
  belongs_to :client, optional: true
  belongs_to :property, optional: true
  belongs_to :business_transaction, optional: true
  belongs_to :property_acquisition_method, optional: true
  belongs_to :operation_type, optional: true
  belongs_to :contract_signer_type, optional: true
  has_one :acquisition_suggestion, class_name: 'AcquisitionMethodSuggestion', dependent: :nullify

  # ============================================================
  # ENUMS
  # ============================================================
  enum :status, { draft: 0, completed: 1, converted: 2, archived: 3 }, default: :draft
  enum :form_source, { web: 0, mobile: 1, paper: 2, phone: 3 }, default: :web

  # ============================================================
  # VALIDACIONES
  # ============================================================
  validates :agent_id, presence: true
  validates :status, presence: true

  with_options if: :completed? do
    validate :general_conditions_complete
    validate :property_info_complete
  end

  validate :ensure_operation_type_present, if: :completed?
  validate :ensure_acquisition_method_present, if: :completed?
  validate :validate_acquisition_method_requirements, if: -> { completed? }

  # ============================================================
  # SCOPES
  # ============================================================
  scope :pending_conversion, -> { where(status: :completed, business_transaction_id: nil) }
  scope :by_agent, ->(agent_id) { where(agent_id: agent_id) }
  scope :recent, -> { order(created_at: :desc) }
  scope :this_month, -> { where('created_at >= ?', Time.current.beginning_of_month) }
  scope :with_owner_name, ->(name) { where("general_conditions->>'owner_or_representative_name' ILIKE ?", "%#{name}%") }
  scope :by_state, ->(state) { where("acquisition_details->>'state' = ?", state) }
  scope :by_acquisition_method, ->(method_id) { where(property_acquisition_method_id: method_id) }
  scope :with_active_mortgage, -> { where("current_status->>'has_active_mortgage' = ?", 'true') }
  scope :pending_documents, -> { completed.where.not(status: :converted) }

  attr_accessor :auto_generated_identifier

  # ============================================================
  # CALLBACKS - CONSOLIDADOS (antes eran 11, ahora son 7)
  # ============================================================
  after_initialize :initialize_acquisition_details
  before_validation :ensure_identifiers_generated
  before_validation :validate_acquisition_method_details
  before_save :auto_generate_property_id
  before_save :ensure_co_owners_count_is_integer
  before_save :set_completed_at, if: -> { status_changed? && completed? }
  before_save :set_converted_at, if: -> { status_changed? && converted? }

  # ============================================================
  # M√âTODOS P√öBLICOS - HELPERS PARA VISTAS
  # ============================================================

  def acquisition_method_display
    return unless property_acquisition_method
    property_acquisition_method.name
  end

  def requires_clarification?
    property_acquisition_method&.requires_heirs? ||
    property_acquisition_method&.requires_judicial_sentence?
  end

  def suggest_new_acquisition_method!(name, legal_basis)
    AcquisitionMethodSuggestion.create!(
      user: agent.user,
      initial_contact_form: self,
      suggested_name: name,
      legal_basis: legal_basis
    )
  end

  def is_inheritance?
    general_conditions['property_acquisition_method'] == 'herencia' ||
    inheritance_info['is_inheritance'] == true
  end

  def has_co_owners?
    (acquisition_details['co_owners_count']&.to_i || 1) > 1
  end

  def co_owners_count
    acquisition_details['co_owners_count'] || 1
  end

  def has_mortgage?
    current_status['has_active_mortgage'] == true ||
    current_status['has_active_mortgage'] == 'true'
  end

  def qualifies_for_tax_exemption?
    tax_exemption['qualifies_for_exemption'] == true
  end

  def completion_percentage
    total_fields = 6
    completed_sections = 0

    completed_sections += 1 if general_conditions.present? && general_conditions.any?
    completed_sections += 1 if property_info.present? && property_info.any?
    completed_sections += 1 if inheritance_info.present? && inheritance_info.any?
    completed_sections += 1 if current_status.present? && current_status.any?
    completed_sections += 1 if tax_exemption.present? && tax_exemption.any?
    completed_sections += 1 if promotion_preferences.present? && promotion_preferences.any?

    ((completed_sections.to_f / total_fields) * 100).round(0)
  end

  def conversion_requirements_status
    {
      completed: completed?,
      has_owner_name: general_conditions['owner_or_representative_name'].present?,
      has_acquisition_method: property_acquisition_method_id.present?,
      has_operation_type: operation_type_id.present?,
      has_state: acquisition_details['state'].present?,
      has_land_use: acquisition_details['land_use'].present?,
      has_co_owners_count: acquisition_details['co_owners_count'].present?
    }
  end

  def normalize_for_search(text)
    text.to_s.downcase.gsub(/[^a-z0-9]/, '')
  end

  # ============================================================
  # REGENERACI√ìN DE IDENTIFICADOR
  # Permite actualizar el opportunity_identifier cuando cambian
  # datos que lo componen (ej: error en n√∫mero exterior)
  # ============================================================
  def regenerate_opportunity_identifier!
    self.opportunity_identifier = nil
    self.opportunity_identifier_generated_at = nil
    generate_opportunity_identifier_simple
    save!
  end

  # ============================================================
  # M√âTODOS P√öBLICOS - L√ìGICA DE CONVERSI√ìN
  # ============================================================

  def detect_transaction_scenario
    return nil unless operation_type.present?

    # Buscar escenario desde cat√°logos de BD, no hardcodeado
    scenario = find_scenario_from_catalogs
    return scenario if scenario.present?

    # Fallback: buscar por categor√≠a de operaci√≥n
    scenario = TransactionScenario
      .where(active: true, category: operation_type.name.downcase)
      .first

    Rails.logger.info "‚úÖ Escenario detectado: #{scenario&.name}" if scenario
    scenario
  end

  def valid_for_conversion?
    return false unless completed?
    return false unless general_conditions.present? &&
                        general_conditions['owner_or_representative_name'].present?
    return false unless property_acquisition_method_id.present?
    return false unless operation_type_id.present?
    return false unless acquisition_details.present? &&
                        acquisition_details['state'].present? &&
                        acquisition_details['land_use'].present? &&
                        acquisition_details['co_owners_count'].present?
    return false unless property_info.present? &&
                        property_info['street'].present? &&
                        property_info['exterior_number'].present? &&
                        property_info['neighborhood'].present? &&
                        property_info['postal_code'].present? &&
                        property_info['municipality'].present? &&
                        property_info['city'].present?
    true
  end

  def find_or_create_client!
    return client if client.present?

    gc = general_conditions || {}

    first_names    = gc['first_names'].to_s.strip.presence
    first_surname  = gc['first_surname'].to_s.strip.presence
    second_surname = gc['second_surname'].to_s.strip.presence
    email          = gc['owner_email'].to_s.strip.presence
    phone          = gc['owner_phone'].to_s.strip.presence
    civil_status   = gc['civil_status'].to_s.strip.downcase.presence || 'soltero'

    unless email.present?
      Rails.logger.error "‚ùå [ICF##{id}] Falta email del propietario"
      return false
    end

    unless first_names.present?
      Rails.logger.error "‚ùå [ICF##{id}] Falta nombre (first_names) del propietario"
      return false
    end

    unless first_surname.present?
      Rails.logger.error "‚ùå [ICF##{id}] Falta primer apellido (first_surname) del propietario"
      return false
    end

    existing_client = Client.where('LOWER(email) = ?', email.downcase).first
    if existing_client.present?
      Rails.logger.info "‚úÖ [ICF##{id}] Cliente existente encontrado: ID #{existing_client.id}"
      return existing_client
    end

    begin
      new_client = Client.create!(
        first_names:    first_names,
        first_surname:  first_surname,
        second_surname: second_surname,
        email:          email,
        phone:          phone,
        civil_status:   civil_status
      )

      Rails.logger.info "‚úÖ [ICF##{id}] Cliente CREADO: ID #{new_client.id}"
      new_client

    rescue ActiveRecord::RecordInvalid => e
      Rails.logger.error "‚ùå [ICF##{id}] VALIDACI√ìN FALLIDA al crear cliente"
      Rails.logger.error "   Errores: #{e.record.errors.full_messages.join(', ')}"
      false

    rescue StandardError => e
      Rails.logger.error "‚ùå [ICF##{id}] ERROR INESPERADO: #{e.class} - #{e.message}"
      Rails.logger.error "   #{e.backtrace.first(3).join("\n   ")}"
      false
    end
  end

  def find_or_create_property!(client)
    return property if property.present?

    street = property_info['street'].to_s.strip
    exterior = property_info['exterior_number'].to_s.strip
    interior = property_info['interior_number'].to_s.strip
    neighborhood = property_info['neighborhood'].to_s.strip
    postal_code = property_info['postal_code'].to_s.strip
    municipality = property_info['municipality'].to_s.strip
    city = property_info['city'].to_s.strip
    country = property_info['country'].to_s.strip

    Property.create_or_find_by!(
      street: street,
      exterior_number: exterior,
      postal_code: postal_code
    ) do |property|
      property.interior_number = interior
      property.neighborhood = neighborhood
      property.municipality = municipality
      property.city = city
      property.country = country
      property.client = client
    end
  rescue ActiveRecord::RecordNotUnique
    Property.find_by!(street: street, exterior_number: exterior, postal_code: postal_code)
  end

  def convert_to_transaction!
    return false if converted? || business_transaction.present?

    Rails.logger.info "üîÑ [#{id}] Iniciando conversi√≥n a transacci√≥n..."

    begin
      ActiveRecord::Base.transaction do
        client = find_or_create_client!
        raise "‚ùå No se pudo obtener cliente" unless client.present?

        prop = find_or_create_property!(client)
        raise "‚ùå No se pudo obtener propiedad" unless prop.present?

        transaction = create_business_transaction!(client, prop)
        raise "‚ùå No se pudo crear transacci√≥n" unless transaction.present?

        update!(
          status: :converted,
          converted_at: Time.current,
          client: client,
          property: prop,
          business_transaction: transaction
        )

        Rails.logger.info "‚úÖ [#{id}] Conversi√≥n exitosa: TX #{transaction.id}"
        transaction
      end
    rescue ActiveRecord::RecordInvalid => e
      Rails.logger.error "‚ùå [#{id}] Validaci√≥n fall√≥: #{e.message}"
      false
    rescue StandardError => e
      Rails.logger.error "‚ùå [#{id}] Error en conversi√≥n: #{e.class} - #{e.message}"
      Rails.logger.error e.backtrace.join("\n")
      false
    end
  end

  # ============================================================
  # M√âTODOS PRIVADOS - CALLBACKS CONSOLIDADOS
  # ============================================================
  private

# ============================================================
# M√âTODOS PRIVADOS - GENERACI√ìN DE FOLIO
# ============================================================

  def generate_folio_if_missing
    return if initial_contact_folio.present?
    return unless agent.present? && agent.user.present?
    
    initials = extract_initials_from_name(agent.user.name || agent.user.email)
    date = (created_at || Time.current)
    self.initial_contact_folio = generate_contact_folio(initials, date)
  end

  def generate_contact_folio(initials, date)
    date_str = date.strftime('%d%m%y')
    base_folio = "#{initials}#{date_str}"
    
    # Buscar el √∫ltimo folio con ese prefijo
    last_folio = InitialContactForm
      .where("initial_contact_folio LIKE ?", "#{base_folio}%")
      .maximum(:initial_contact_folio)
    
    sequence = if last_folio.present?
                 last_folio.split('-').last.to_i + 1.to_s.rjust(2, '0')
               else
                 '01'
               end
    
    "#{base_folio}-#{sequence}"
  end

  def extract_initials_from_name(full_name)
    return full_name.split.first.upcase[0..2] if full_name.include?('@')
    
    parts = full_name.strip.split
    case parts.length
    when 1 then parts[0].upcase[0..2]
    when 2 then "#{parts[0][0]}#{parts[1][0]}#{parts[0][1]}".upcase
    else "#{parts[0][0]}#{parts[1][0]}#{parts[2][0]}".upcase
    end
  end



  # Callback consolidado: antes eran 5 before_validation separados
  def ensure_identifiers_generated
    build_owner_or_representative_name
    generate_folio_if_missing
    generate_opportunity_identifier_consolidated
  end

  def generate_opportunity_identifier_consolidated
    # CAMBIO CLAVE: Si cambiaron datos que componen el identificador,
    # regenerar aunque ya exista uno
    if opportunity_identifier.present? && !identifier_source_data_changed?
      return
    end

    if general_conditions_available_for_simple_identifier?
      generate_opportunity_identifier_simple
    end
  end

  # Detecta si cambiaron los datos que componen el identificador
  def identifier_source_data_changed?
    return false unless persisted?

    # Si cambiaron property_info o acquisition_details, regenerar
    property_info_changed? || acquisition_details_changed?
  end

  def property_info_complete_for_full_identifier?
    property_info.present? &&
    property_info['street'].present? &&
    property_info['exterior_number'].present? &&
    acquisition_details.present? &&
    acquisition_details['state'].present?
  end

  def general_conditions_available_for_simple_identifier?
    general_conditions.present? &&
    general_conditions['first_surname'].present? &&
    property_info.present? &&
    property_info['street'].present? &&
    property_info['exterior_number'].present?
  end

  # ============================================================
  # M√âTODOS PRIVADOS - GENERACI√ìN DE IDENTIFICADORES
  # ============================================================

  def generate_opportunity_identifier_from_property
    state_code = extract_state_code_for_property
    municipality_code = extract_municipality_code
    street_code = extract_full_street_code
    exterior = property_info['exterior_number'].to_s.rjust(5, '0')
    interior = property_info['interior_number'].to_s.rjust(5, '0')
    neighborhood_code = extract_neighborhood_code

    base_id = [
      state_code,
      municipality_code,
      neighborhood_code,
      street_code,
      exterior,
      interior
    ].compact.join('-')

    counter = 0
    final_id = base_id

    while InitialContactForm
      .where(opportunity_identifier: final_id)
      .where.not(id: id)
      .exists?
      counter += 1
      final_id = "#{base_id}-#{counter}"
    end

    self.opportunity_identifier = final_id
    self.opportunity_identifier_generated_at = Time.current

    Rails.logger.info "‚úÖ Property ID: #{final_id}"
    Rails.logger.info "   Ubicaci√≥n: #{full_address}"
  end

  def generate_opportunity_identifier_simple
    first_surname = general_conditions['first_surname'].to_s.strip
    street = property_info['street'].to_s.strip
    exterior = property_info['exterior_number'].to_s.strip

    return unless first_surname.present? && street.present? && exterior.present?

    op_code = extract_operation_code

    last_name_clean = StringNormalizer.to_code(first_surname, max_length: 11)
    street_clean = StringNormalizer.to_code(street, max_length: 16)
    exterior_clean = exterior[0..5]
    interior_clean = property_info['interior_number'].to_s.strip[0..3]
    date_str = Date.today.strftime('%Y%m%d')

    identifier = "#{op_code}-#{last_name_clean}-#{street_clean}-#{exterior_clean}"
    identifier += "-#{interior_clean}" if interior_clean.present?
    identifier += "-#{date_str}"

    self.opportunity_identifier = identifier
    self.auto_generated_identifier = true

    Rails.logger.info "‚úÖ AUTO-GENERATED IDENTIFIER: #{identifier}"
  end

  def initialize_acquisition_details
    if self.acquisition_details.blank?
      self.acquisition_details = { 'co_owners_count' => 1 }
    elsif self.acquisition_details['co_owners_count'].blank?
      self.acquisition_details['co_owners_count'] = 1
    end
  end

  def ensure_co_owners_count_is_integer
    if acquisition_details.present? && acquisition_details['co_owners_count'].present?
      acquisition_details['co_owners_count'] = acquisition_details['co_owners_count'].to_i
    end
  end

  def build_owner_or_representative_name
    return unless general_conditions.present?

    if general_conditions['owner_or_representative_name'].blank?
      first_names = general_conditions['first_names'].to_s.strip
      first_surname = general_conditions['first_surname'].to_s.strip
      second_surname = general_conditions['second_surname'].to_s.strip

      full_name = [first_names, first_surname, second_surname]
        .compact
        .reject(&:empty?)
        .join(' ')
        .strip

      if full_name.present?
        general_conditions['owner_or_representative_name'] = full_name
      end
    end
  end



  def set_completed_at
    self.completed_at = Time.current
  end

  def set_converted_at
    self.converted_at = Time.current
  end

  # ============================================================
  # M√âTODOS PRIVADOS - RESOLUCI√ìN DE ESCENARIO DESDE CAT√ÅLOGOS
  # ============================================================
  def find_scenario_from_catalogs
    return nil unless operation_type.present?

    normalized_category = operation_type.name.to_s.downcase
      .gsub(/renta|rent|arrendamiento/, 'renta')
      .gsub(/venta|sale/, 'venta')

    scenario = TransactionScenario
      .where(active: true)
      .where("LOWER(category) = ?", normalized_category)
      .first

    return scenario if scenario.present?

    # Fallback por nombre construido
    scenario_name = build_scenario_name(normalized_category, property_acquisition_method&.code.to_s)
    TransactionScenario.find_by(name: scenario_name, active: true) if scenario_name
  end


  def build_scenario_name(op_name, acquisition_code)
    case op_name
    when /venta|sale/
      case acquisition_code
      when 'compraventa', 'compra_directa' then 'Venta por Compra Directa'
      when 'herencia' then 'Venta por Herencia'
      else nil
      end
    when /renta|rent|arrendamiento/
      land_use_code = acquisition_details['land_use']
      case land_use_code
      when 'COM', 'COM_LOCAL' then 'Renta Local Comercial'
      when 'IND', 'IND_BODEGA' then 'Renta Bodega Industrial'
      when 'HAB', 'HAB_PLURI' then 'Renta Apartamento'
      when 'HAB_UNI' then 'Renta Casa Habitacional'
      else 'Renta Casa Habitacional'
      end
    end
  end

  # ============================================================
  # M√âTODOS PRIVADOS - UTILIDADES (StringNormalizer)
  # ============================================================

  def extract_full_street_code
    street = property_info['street'].to_s.strip
    return 'STREET' if street.blank?

    clean_street = StringNormalizer.unaccent(street).upcase

    nomenclaturas = ['AVENIDA', 'AV', 'PASEO', 'CALZADA', 'CALLE', 'BOULEVARD',
                     'BLVD', 'CIRCUITO', 'PROLONGACION', 'CARRERA', 'PLAZA',
                     'PASAJE', 'CERRADA', 'ANDADOR', 'BOSQUE', 'LOMA', 'LOMAS']

    words = clean_street.split(/\s+/).compact
    start_idx = nomenclaturas.include?(words[0]) ? 1 : 0

    significant = words[start_idx..-1]&.join('') || 'STREET'
    significant.gsub(/[^A-Z0-9]/, '').slice(0, 30).presence || 'STREET'
  end

  def extract_municipality_code
    municipality = property_info['municipality'].to_s.strip
    return 'MUN' if municipality.blank?

    StringNormalizer.to_padded_code(municipality, max_length: 8)
  end

  def extract_state_code_for_property
    state = acquisition_details['state'].to_s.strip
    return 'EDO' if state.blank?

    # Usar cat√°logo mexican_states si est√° disponible
    mexican_state = MexicanState.find_by(name: state) ||
                    MexicanState.find_by(full_name: state)

    return mexican_state.code if mexican_state.present?

    # Fallback si no se encuentra en cat√°logo
    StringNormalizer.to_code(state, max_length: 6)
  rescue NameError
    # Si MexicanState no existe como modelo, usar normalizaci√≥n directa
    StringNormalizer.to_code(state, max_length: 6)
  end

  def extract_neighborhood_code
    neighborhood = property_info['neighborhood'].to_s.strip
    return 'NEIGH' if neighborhood.blank?

    StringNormalizer.to_padded_code(neighborhood, max_length: 8)
  end

  def extract_operation_code
    return 'X' unless operation_type.present?

    case operation_type.name.to_s.downcase
    when /venta|sale/          then 'V'
    when /renta|rental|rent/   then 'R'
    when /traspaso/            then 'T'
    when /permuta|exchange/    then 'P'
    else 'X'
    end
  rescue
    'X'
  end

  def clean_for_identifier(text)
    StringNormalizer.to_code(text, max_length: 50)
  end


  def extract_client_code
    name = general_conditions['owner_or_representative_name'].to_s.strip
    return 'XXXX' if name.blank?

    clean_name = StringNormalizer.unaccent(name).downcase.gsub(/\s+/, ' ').strip

    parts = clean_name.split(' ')
    return 'XXXX' if parts.empty?

    code = if parts.length == 1
             parts[0][0..3]
           elsif parts.length == 2
             parts[0][0] + parts[1][0..2]
           else
             first_surname = parts[1]
             second_char = 'X'
             (2...parts.length).each do |i|
               unless ['de', 'la', 'las', 'los', 'el', 'y'].include?(parts[i])
                 second_char = parts[i][0]
                 break
               end
             end
             parts[0][0] + first_surname[0..2] + second_char
           end

    code.upcase.ljust(6, 'X')[0..5]
  end

  def determine_property_type
    land_use = acquisition_details['land_use']
    case land_use
    when 'VIVIENDA_UNIFAMILIAR', 'CASA' then 'casa'
    when 'VIVIENDA_MULTIFAMILIAR', 'DEPARTAMENTOS', 'EDIFICIO' then 'apartment'
    when 'LOCAL_COMERCIAL', 'COMERCIO' then 'comercial'
    when 'OFICINA' then 'oficina'
    when 'BODEGA', 'INDUSTRIAL', 'NAVE' then 'industrial'
    when 'TERRENO', 'LOTE' then 'lote'
    when 'ESTACIONAMIENTO' then 'estacionamiento'
    when 'HOTEL', 'MOTEL' then 'hotel'
    else 'otros'
    end
  end

  def build_property_address(street, exterior, interior, neighborhood, municipality)
    parts = [street, exterior]
    parts << "Apt/Int: #{interior}" if interior.present?
    parts << neighborhood if neighborhood.present?
    parts << municipality if municipality.present?
    parts.compact.join(', ')
  end

  def generate_property_title
    street = property_info['street'].to_s
    number = [property_info['exterior_number'].to_s,
              property_info['interior_number'].to_s]
              .reject(&:blank?)
              .join('-')
    city = property_info['city'].to_s
    "#{street} #{number} - #{city}"
  end

  def generate_property_description
    desc_parts = []

    desc_parts << "**M√©todo:** #{property_acquisition_method.name}" if property_acquisition_method
    desc_parts << "‚Ä¢ Hipoteca activa" if current_status['has_active_mortgage'] == 'true'
    desc_parts << "‚Ä¢ Condominio" if current_status['is_in_condominium'] == 'true'
    desc_parts << "‚Ä¢ Ampliaciones" if current_status['has_extensions'] == 'true'
    desc_parts << "‚Ä¢ Remodelaciones" if current_status['has_renovations'] == 'true'

    desc_parts.empty? ? 'Propiedad sin caracter√≠sticas especiales' : desc_parts.join("\n")
  end

  def compile_property_notes
    notes = []
    notes << "üìã Desde ICF ##{id}"
    notes << "üè∑Ô∏è ID: #{opportunity_identifier}"
    notes << "üë§ Agente: #{agent.user.name}"
    notes.join("\n")
  end

  def full_address
    parts = [
      property_info['street'],
      "N√∫m. #{property_info['exterior_number']}"
    ]

    parts << "Int. #{property_info['interior_number']}" if property_info['interior_number'].present?

    parts += [
      property_info['neighborhood'],
      "C.P. #{property_info['postal_code']}",
      property_info['municipality'],
      acquisition_details['state'],
      property_info['country'] || 'M√©xico'
    ]

    parts.compact.join(', ')
  end

  # ============================================================
  # M√âTODOS PRIVADOS - AUTO GENERACI√ìN DE PROPERTY ID
  # ============================================================

  def auto_generate_property_id
    return if property_id.present?
    return unless property_info.present? && acquisition_details.present?

    street = property_info['street'].to_s.strip
    exterior = property_info['exterior_number'].to_s.strip
    interior = property_info['interior_number'].to_s.strip
    neighborhood = property_info['neighborhood'].to_s.strip
    municipality = property_info['municipality'].to_s.strip
    state = acquisition_details['state'].to_s.strip

    return unless street.present? && exterior.present? && municipality.present?

    Rails.logger.info "üîç BUSCANDO PROPIEDAD: #{street} #{exterior}, #{interior}, #{municipality}"

    existing_property = Property.where(
      street: street,
      exterior_number: exterior,
      interior_number: interior,
      neighborhood: neighborhood,
      municipality: municipality
    ).first

    if existing_property.present?
      self.property_id = existing_property.id
      Rails.logger.info "‚úÖ PROPERTY LINKED (EXISTENTE): #{existing_property.id} - #{existing_property.address}"
      return
    end

    begin
      Rails.logger.info "‚ûï CREANDO NUEVA PROPIEDAD..."

      property_type_name = determine_property_type
      property_type_obj = PropertyType.find_by(name: property_type_name) || PropertyType.first

      unless property_type_obj
        Rails.logger.warn "‚ö†Ô∏è No hay PropertyType en BD. Creando 'otros'..."
        property_type_obj = PropertyType.create!(name: 'otros', description: 'Otros tipos')
      end

      default_price = 1.0
      default_area = 1.0
      default_land_use = acquisition_details['land_use'].to_s.presence || 'HAB'

      new_property = Property.create!(
        user_id: agent&.user_id,
        property_type: property_type_obj,
        address: build_property_address(street, exterior, interior, neighborhood, municipality),
        street: street,
        exterior_number: exterior,
        interior_number: interior,
        neighborhood: neighborhood,
        city: property_info['city'].to_s,
        municipality: municipality,
        state: state,
        postal_code: property_info['postal_code'].to_s,
        country: property_info['country'].to_s || 'M√©xico',
        price: default_price,
        built_area_m2: default_area,
        lot_area_m2: default_area,
        bedrooms: 0,
        bathrooms: 0,
        title: "Propiedad en #{street} #{exterior}",
        description: "Propiedad capturada desde Formulario de Contacto Inicial #{self.opportunity_identifier}",
        land_use: LandUseType.find_by(code: default_land_use)&.property_category || 'habitacional',
        contact_email: general_conditions['owner_email'].to_s,
        contact_phone: general_conditions['owner_phone'].to_s
      )

      self.property_id = new_property.id
      Rails.logger.info "‚úÖ PROPERTY CREATED (NUEVA): #{new_property.id} - #{new_property.address}"

    rescue ActiveRecord::RecordInvalid => e
      Rails.logger.error "‚ùå ERROR VALIDACI√ìN PROPIEDAD: #{e.message}"
      Rails.logger.error e.record.errors.full_messages.inspect
    rescue StandardError => e
      Rails.logger.error "‚ö†Ô∏è ERROR CREANDO PROPIEDAD: #{e.class} - #{e.message}"
      Rails.logger.error e.backtrace.first(5).join("\n")
    end
  end

  # ============================================================
  # M√âTODOS PRIVADOS - VALIDACIONES
  # ============================================================

  def general_conditions_complete
    errors.add(:general_conditions, "falta nombre del propietario") if general_conditions['owner_or_representative_name'].blank?
    errors.add(:acquisition_details, "debe especificar estado") if acquisition_details['state'].blank?
    errors.add(:acquisition_details, "debe especificar uso de suelo") if acquisition_details['land_use'].blank?
    errors.add(:base, "debe seleccionar m√©todo de adquisici√≥n") if property_acquisition_method_id.blank?
    errors.add(:base, "debe seleccionar qui√©n firmar√°") if contract_signer_type_id.blank?
  end

  def property_info_complete
    if acquisition_details['co_owners_count'].blank? || acquisition_details['co_owners_count'].to_i < 1
      errors.add(:base, 'especifique copropietarios (m√≠nimo 1)')
    end
  end

  def ensure_operation_type_present
    errors.add(:operation_type, "debe estar especificado") if operation_type_id.blank?
  end

  def ensure_acquisition_method_present
    errors.add(:property_acquisition_method, "debe estar especificado") if property_acquisition_method_id.blank?
  end

  def validate_acquisition_method_requirements
    return unless property_acquisition_method.present?

    if property_acquisition_method.requires_heirs? &&
       acquisition_details['heirs_count'].blank?
      errors.add(:base, "El m√©todo #{property_acquisition_method.name} requiere informaci√≥n de herederos")
    end
  end

  def validate_acquisition_method_details
    method = property_acquisition_method
    return unless method.present? && completed?

    case method.code.to_s.upcase
    when 'COMPRAVENTA'
      if acquisition_details['co_owners_count'].blank? || acquisition_details['co_owners_count'].to_i < 1
        errors.add(:acquisition_details, 'requiere n√∫mero v√°lido de copropietarios')
      end
    when 'HERENCIA'
      if acquisition_details['heirs_count'].blank? || acquisition_details['heirs_count'].to_i < 1
        errors.add(:acquisition_details, 'requiere n√∫mero v√°lido de herederos')
      end
    when 'DONACION'
      if acquisition_details['donor_name'].blank?
        errors.add(:acquisition_details, 'requiere nombre completo del donante')
      end
    end
  end

  # ============================================================
  # M√âTODOS PRIVADOS - TRANSACCIONES Y DOCUMENTOS
  # ============================================================

  def create_business_transaction!(client, property)
    scenario = detect_transaction_scenario

    bt = BusinessTransaction.create!(
      listing_agent_id: agent&.user_id,
      current_agent_id: agent&.user_id,
      offering_client: client,
      property: property,
      operation_type_id: operation_type_id,
      business_status: BusinessStatus.find_by(name: 'prospecto') || BusinessStatus.first,
      transaction_scenario: scenario,
      price: property_info['asking_price'] || property.price || 1,
      commission_percentage: 0,
      start_date: Date.current,
      property_acquisition_method_id: property_acquisition_method_id,
      acquisition_legal_act: property_acquisition_method&.name,
      initial_contact_folio: initial_contact_folio,
      notes: compile_transaction_notes,
      inheritance_details: build_inheritance_details,
      property_status: build_property_status,
      tax_information: build_tax_information,
      legal_representation: build_legal_representation
    )

    create_co_owners!(bt, client)
    create_required_documents!(bt, scenario) if scenario
    Rails.logger.info "‚úÖ BT creada (ID: #{bt.id})"
    bt
  end

  def create_co_owners!(business_transaction, primary_client)
    is_heritage = business_transaction.property_acquisition_method&.code == 'herencia'

    count = if is_heritage
              (acquisition_details['heirs_count'] || 1).to_i
            else
              (acquisition_details['co_owners_count'] || 1).to_i
            end

    owner_type = is_heritage ? 'heredero' : 'copropietario'

    percentage_each = (100.0 / count).round(2)
    is_mancomunado = !is_heritage && (general_conditions['marriage_regime_id'].to_i == 4)
    owner_percentage = is_mancomunado ? (percentage_each / 2).round(2) : percentage_each

    # Copropietario principal (quien act√∫a ante la inmobiliaria)
    business_transaction.business_transaction_co_owners.create!(
      client: primary_client,
      person_name: general_conditions['owner_or_representative_name'],
      percentage: owner_percentage,
      role: 'propietario',
      active: true
    )

    # C√≥nyuge del principal (solo si NO es herencia + mancomunado)
    if is_mancomunado
      business_transaction.business_transaction_co_owners.create!(
        client: primary_client,
        person_name: "C√≥nyuge de #{general_conditions['owner_or_representative_name']}",
        percentage: owner_percentage,
        role: 'copropietario',
        active: true
      )
    end

    # Resto de copropietarios/herederos
    (count - 1).times do |i|
      business_transaction.business_transaction_co_owners.create!(
        person_name: "#{owner_type.capitalize} #{i + 2} - Por definir",
        percentage: percentage_each,
        role: owner_type,
        active: true
      )
    end
  end

  def create_required_documents!(business_transaction, scenario)
    return unless scenario.present?

    # Delegar a BusinessTransaction que usa create_required_documents_v2!
    business_transaction.create_required_documents_v2!(scenario)
  end

  def compile_transaction_notes
    notes = "=== ICF ===\nFolio: #{initial_contact_folio}\n"
    notes += "ID: #{opportunity_identifier}\n"
    notes += "Completado: #{completed_at&.strftime('%d/%m/%Y %H:%M')}\n\n"
    notes += "=== NOTAS ===\n#{agent_notes}" if agent_notes.present?
    notes
  end

  def build_inheritance_details
    return {} unless property_acquisition_method&.code == 'herencia'

    {
      'heirs_count' => acquisition_details['heirs_count']&.to_i,
      'all_living' => convert_to_bool(acquisition_details['all_living']),
      'deceased_count' => acquisition_details['deceased_count']&.to_i,
      'all_married' => convert_to_bool(acquisition_details['all_married']),
      'single_heirs_count' => acquisition_details['single_heirs_count']&.to_i,
      'deceased_civil_status' => acquisition_details['deceased_civil_status'],
      'inheritance_from' => acquisition_details['inheritance_from'],
      'inheritance_from_other' => acquisition_details['inheritance_from_other'],
      'parents_were_married' => convert_to_bool(acquisition_details['parents_were_married']),
      'parents_marriage_regime' => acquisition_details['parents_marriage_regime'],
      'has_testamentary_succession' => convert_to_bool(acquisition_details['has_testamentary_succession']),
      'succession_planned_date' => acquisition_details['succession_planned_date'],
      'succession_authority' => acquisition_details['succession_authority'],
      'succession_type' => acquisition_details['succession_type']
    }.reject { |_, v| v.blank? }
  end

  def build_property_status
    {
      'has_active_mortgage' => current_status['has_active_mortgage'],
      'mortgage_balance' => current_status['mortgage_balance'],
      'is_in_condominium' => current_status['is_in_condominium'],
      'has_extensions' => current_status['has_extensions'],
      'has_renovations' => current_status['has_renovations'],
      'has_rental_units' => current_status['has_rental_units']
    }.compact
  end

  def build_tax_information
    {
      'first_home_sale' => tax_exemption['first_home_sale'],
      'lived_last_5_years' => tax_exemption['lived_last_5_years'],
      'qualifies_for_exemption' => tax_exemption['qualifies_for_exemption']
    }.compact
  end

  def build_legal_representation
    {
      'owner_name' => general_conditions['owner_or_representative_name'],
      'civil_status' => general_conditions['civil_status'],
      'contract_signer_type' => contract_signer_type&.name
    }.compact
  end

  def map_party_type_to_co_owners(business_transaction, party_type)
    case party_type
    when 'copropietario_principal'
      business_transaction.business_transaction_co_owners.where(role: 'propietario')
    when 'copropietario'
      business_transaction.business_transaction_co_owners
                          .where(role: ['propietario', 'copropietario'])
    when 'ambos'
      business_transaction.business_transaction_co_owners
    when 'adquiriente'
      []
    else
      []
    end
  end

  def convert_to_bool(value)
    return value if [true, false].include?(value)
    value.to_s.strip.downcase == 'true'
  end

end
```
--------------------------------------------
Archivo:  app/models/transaction_scenario.rb
--------------------------------------------
```ruby
# app/models/transaction_scenario.rb
class TransactionScenario < ApplicationRecord
  include AutoSluggable

  # ============================================================
  # CONSTANTES - Nombres can√≥nicos de escenarios
  # Si un admin cambia el nombre en BD, actualizar aqu√≠ tambi√©n.
  # Estos son los escenarios base del sistema.
  # ============================================================
  SCENARIOS = {
    venta_compra_directa:    'Venta por Compra Directa',
    venta_herencia:          'Venta por Herencia',
    venta_donacion:          'Venta por Donaci√≥n',
    renta_local_comercial:   'Renta Local Comercial',
    renta_bodega_industrial: 'Renta Bodega Industrial',
    renta_apartamento:       'Renta Apartamento',
    renta_casa:              'Renta Casa Habitacional'
  }.freeze

  # ============================================================
  # RELACIONES
  # ============================================================
  has_many :scenario_documents, dependent: :destroy
  has_many :document_types, through: :scenario_documents
  has_many :business_transactions

  # ============================================================
  # VALIDACIONES
  # ============================================================
  validates :name, presence: true, uniqueness: true
  validates :category, presence: true, inclusion: {
    in: %w[compraventa renta_comercial renta_habitacional]
  }

  # ============================================================
  # SCOPES
  # ============================================================
  scope :active, -> { where(active: true) }
  scope :for_category, ->(category) { where(category: category) }

  # ============================================================
  # B√öSQUEDA SEGURA DE ESCENARIOS
  # Usa find_by + log de advertencia si no existe.
  # NO lanza excepci√≥n porque el admin puede no haber creado
  # todos los escenarios a√∫n.
  # ============================================================
  SCENARIOS.each do |method_name, scenario_name|
    define_method("self.#{method_name}") do
      # No funciona con define_method para class methods
    end

    # Definir class methods din√°micamente
    singleton_class.define_method(method_name) do
      scenario = find_by(name: scenario_name)
      unless scenario
        Rails.logger.warn "‚ö†Ô∏è Escenario '#{scenario_name}' no encontrado en BD. " \
                          "Verificar seeds o crear desde panel admin."
      end
      scenario
    end
  end

  # ============================================================
  # M√âTODOS PARA DOCUMENTOS POR TIPO DE PARTICIPANTE
  # ============================================================

  # Documentos requeridos para un party_type espec√≠fico
  def required_documents_for_party(party_type)
    scenario_documents.joins(:document_type)
                      .where(party_type: [party_type, 'ambos'], required: true)
                      .includes(:document_type)
  end

  def document_count_for_party(party_type)
    required_documents_for_party(party_type).count
  end

  # Documentos que SOLO aplican al copropietario principal
  # (inherentes a la transacci√≥n, no a la persona)
  def transaction_inherent_documents
    scenario_documents.joins(:document_type)
                      .where(party_type: 'copropietario_principal', required: true)
                      .includes(:document_type)
  end

  # Documentos que aplican a TODOS los copropietarios
  def shared_copropietario_documents
    scenario_documents.joins(:document_type)
                      .where(party_type: ['copropietario', 'ambos'], required: true)
                      .includes(:document_type)
  end

  # Resumen de documentos por party_type (√∫til para vista admin)
  def documents_summary
    scenario_documents.group(:party_type).count
  end
end
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/_conditional_fields.html.erb
--------------------------------------------
```ruby
<!-- app/views/initial_contact_forms/_conditional_fields.html.erb -->
<!-- CAMPOS CONDICIONALES POR M√âTODO DE ADQUISICI√ìN -->
<!-- CORRECCI√ìN: Usar data-originally-required en lugar de required -->

<div data-controller="initial-contact-form-conditional-fields">

  <!-- COMPRAVENTA -->
  <div id="compraventa-fields" class="conditional-section" style="display: none;">
  <div class="card">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">üìã Detalles de Compraventa</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <strong>Compraventa:</strong> Informaci√≥n b√°sica del contrato de compraventa
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details_co_owners_count', 'N√∫mero de copropietarios *', class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[acquisition_details][co_owners_count]',
                              form.acquisition_details['co_owners_count'] || 1,
                              class: 'form-control', min: 1,
                              data: { originally_required: 'true' } %>
        </div>
      </div>
      
      <div class="mb-3">
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[acquisition_details][has_relationship]', '1',
                            form.acquisition_details['has_relationship'],
                            class: 'form-check-input', id: 'has_relationship_check' %>
          <%= label_tag 'has_relationship_check', '¬øLos copropietarios tienen parentesco?',
                        class: 'form-check-label' %>
        </div>
      </div>
      
      <div id="relationship-field" style="<%= 'display:none;' unless form.acquisition_details['has_relationship'] %>">
        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details[relationship_type]', 'Especifique el parentesco', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][relationship_type]',
              options_from_collection_for_select(
                RelationshipType.active.where(category: 'copropietario').ordered,
                :name,
                :display_name,
                form.acquisition_details['relationship_type']
              ),
              prompt: 'Seleccione...',
              class: 'form-select' %>
        </div>
      </div>
      
      <div class="mb-3">
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[acquisition_details][acquired_pre_2014]', '1',
                            form.acquisition_details['acquired_pre_2014'],
                            class: 'form-check-input' %>
          <%= label_tag 'acquired_pre_2014', '¬øSe adquiri√≥ antes de 2014?',
                        class: 'form-check-label' %>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- HERENCIA -->
  <div id="herencia-fields" class="conditional-section" style="display: none;">
  <div class="card">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Detalles de Herencia</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-warning">
        <strong>Herencia:</strong> Informaci√≥n sobre los herederos y la sucesi√≥n
      </div>
      
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= label_tag 'acquisition_details_heirs_count', 'N√∫mero de herederos directos *',
                        class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[acquisition_details][heirs_count]',
                              form.acquisition_details['heirs_count'],
                              class: 'form-control', min: 1,
                              data: { originally_required: 'true' } %>
        </div>
        
        <div class="col-md-4 mb-3">
          <%= label_tag 'acquisition_details_all_living', '¬øTodos viven?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][all_living]',
                          options_for_select([['S√≠', 'true'], ['No', 'false']],
                                            form.acquisition_details['all_living']),
                          class: 'form-select', id: 'all_living_select' %>
        </div>
        
        <div class="col-md-4 mb-3" id="deceased-count-field"
              style="<%= 'display:none;' unless form.acquisition_details['all_living'] == 'false' %>">
          <%= label_tag 'acquisition_details_deceased_count', '¬øCu√°ntos han fallecido?',
                        class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[acquisition_details][deceased_count]',
                              form.acquisition_details['deceased_count'],
                              class: 'form-control', min: 0 %>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details_all_married', '¬øTodos est√°n casados?',
                        class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][all_married]',
                          options_for_select([['S√≠', 'true'], ['No', 'false']],
                                            form.acquisition_details['all_married']),
                          class: 'form-select', id: 'all_married_select' %>
        </div>
        
        <div class="col-md-6 mb-3" id="single-count-field"
              style="<%= 'display:none;' unless form.acquisition_details['all_married'] == 'false' %>">
          <%= label_tag 'acquisition_details_single_heirs_count', '¬øCu√°ntos solteros?',
                        class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[acquisition_details][single_heirs_count]',
                              form.acquisition_details['single_heirs_count'],
                              class: 'form-control', min: 0 %>
        </div>
      </div>
      
      <div class="mb-3">
        <%= label_tag 'acquisition_details[deceased_civil_status]', 'Estado civil del finado(a) *', class: 'form-label' %>
        <%= select_tag 'initial_contact_form[acquisition_details][deceased_civil_status]',
            options_from_collection_for_select(
              CivilStatus.active.order(:sort_order),
              :name,
              :display_name,
              form.acquisition_details['deceased_civil_status']
            ),
            prompt: 'Seleccione...',
            class: 'form-select',
            data: { 'originally-required': 'true' } %>
      </div>

      <div class="mb-3">
        <%= label_tag 'acquisition_details[inheritance_from]', '¬øDe qui√©n es la herencia? *', class: 'form-label' %>
        <%= select_tag 'initial_contact_form[acquisition_details][inheritance_from]',
            options_from_collection_for_select(
              RelationshipType.active.where(category: 'herencia').ordered,
              :name,
              :display_name,
              form.acquisition_details['inheritance_from']
            ),
            prompt: 'Seleccione...',
            id: 'inheritance-from-select',
            class: 'form-select',
            data: { 'originally-required': 'true' } %>
      </div>
      
      <div id="inheritance-other-field"
            style="<%= 'display:none;' unless form.acquisition_details['inheritance_from'] == 'otro' %>">
        <div class="mb-3">
          <%= label_tag 'acquisition_details_inheritance_from_other', 'Especifique',
                        class: 'form-label' %>
          <%= text_field_tag 'initial_contact_form[acquisition_details][inheritance_from_other]',
                            form.acquisition_details['inheritance_from_other'],
                            class: 'form-control', maxlength: 100,
                            placeholder: 'Ej: Hermano, t√≠o, abuelo...' %>
        </div>
      </div>
      
      <div class="mb-3">
        <%= label_tag 'acquisition_details_parents_were_married', '¬øLos padres estaban casados?',
                      class: 'form-label' %>
        <%= select_tag 'initial_contact_form[acquisition_details][parents_were_married]',
                        options_for_select([['S√≠', 'true'], ['No', 'false']],
                                          form.acquisition_details['parents_were_married']),
                        class: 'form-select', id: 'parents_married_select' %>
      </div>
      
      <div id="parents-regime-field" style="display: none;">
        <div class="mb-3">
          <%= label_tag 'acquisition_details_parents_marriage_regime',
                        'R√©gimen matrimonial de los padres', class: 'form-label' %>
          <%= collection_select 'initial_contact_form[acquisition_details]', :parents_marriage_regime,
                                MarriageRegime.active.ordered,
                                :name, :display_name,
                                { prompt: 'Seleccione...' },
                                { class: 'form-select' } %>
        </div>
      </div>
      
      <div class="mb-3">
        <%= label_tag 'acquisition_details_has_testamentary', '¬øTiene sucesi√≥n testamentaria? *',
                      class: 'form-label' %>
        <%= select_tag 'initial_contact_form[acquisition_details][has_testamentary_succession]',
                        options_for_select([['S√≠', 'true'], ['No', 'false']],
                                          form.acquisition_details['has_testamentary_succession']),
                        class: 'form-select', id: 'has_testamentary_select',
                        data: { originally_required: 'true' } %>
      </div>
      
      <div id="no-testamentary-field" style="display: none;">
        <div class="mb-3">
          <%= label_tag 'acquisition_details_succession_planned_date', '¬øCu√°ndo planea hacerla?',
                        class: 'form-label' %>
          <%= date_field_tag 'initial_contact_form[acquisition_details][succession_planned_date]',
                            form.acquisition_details['succession_planned_date'],
                            class: 'form-control' %>
        </div>
      </div>
      
      <div id="yes-testamentary-field" style="display: none;">
        <div class="mb-3">
          <%= label_tag 'acquisition_details[succession_authority]', '¬øPor juzgado o notar√≠a? *', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][succession_authority]',
              options_from_collection_for_select(
                SuccessionAuthority.active.ordered,
                :name,
                :display_name,
                form.acquisition_details['succession_authority']
              ),
              prompt: 'Seleccione...',
              class: 'form-select',
              data: { 'originally-required': 'true' } %>
        </div>
        
        <div class="col-md-6 mb-3">
          <%= label_tag 'succession_type', '¬øC√≥mo se llev√≥ a cabo la sucesi√≥n? *', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][succession_type]',
              options_from_collection_for_select(
                SuccessionType.active.ordered,
                :name,
                :display_name,
                form.acquisition_details['succession_type']
              ),
              prompt: 'Seleccione...',
              id: 'succession-type-select',
              class: 'form-select',
              data: { 'originally-required': 'true' } %>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- USUCAPI√ìN Y PRESCRIPCI√ìN NEGATIVA -->
  <div id="usucapion-fields" class="conditional-section" style="display: none;">
  <div class="card">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">‚öñÔ∏è Detalles de Usucapi√≥n/Prescripci√≥n</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <strong>Usucapi√≥n / Prescripci√≥n:</strong> Documentos judiciales y notariales
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="form-check">
            <%= check_box_tag 'initial_contact_form[acquisition_details][has_judicial_sentence]', '1',
                              form.acquisition_details['has_judicial_sentence'],
                              class: 'form-check-input' %>
            <%= label_tag 'has_judicial_sentence', '¬øTiene sentencia del juez?',
                          class: 'form-check-label' %>
          </div>
        </div>
        
        <div class="col-md-6 mb-3">
          <div class="form-check">
            <%= check_box_tag 'initial_contact_form[acquisition_details][has_notarial_deed]', '1',
                              form.acquisition_details['has_notarial_deed'],
                              class: 'form-check-input' %>
            <%= label_tag 'has_notarial_deed', '¬øTiene escritura ante notario?',
                          class: 'form-check-label' %>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- DACI√ìN EN PAGO -->
  <div id="dacion-pago-fields" class="conditional-section" style="display: none;">
  <div class="card">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">üí∞ Detalles de Daci√≥n en Pago</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <strong>Daci√≥n en Pago:</strong> Documentaci√≥n de la daci√≥n
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details_document_type',
                        '¬øCon qu√© documento avala la propiedad? *', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][document_type]',
                          options_for_select([
                            ['Escritura P√∫blica', 'escritura_publica'],
                            ['Sentencia Judicial', 'sentencia_judicial'],
                            ['Ambos', 'ambos']
                          ], form.acquisition_details['document_type']),
                          class: 'form-select',
                          data: { originally_required: 'true' } %>
        </div>
        
        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details_creditors_count', 'N√∫mero de copropietarios',
                        class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[acquisition_details][creditors_count]',
                              form.acquisition_details['creditors_count'] || 1,
                              class: 'form-control', min: 1 %>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- DONACI√ìN -->
  <div id="donacion-fields" class="conditional-section" style="display: none;">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üéÅ Detalles de Donaci√≥n</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <strong>Donaci√≥n:</strong> Informaci√≥n del donante y beneficiarios
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details_donor_name', 'Nombre completo del donante *',
                        class: 'form-label' %>
          <%= text_field_tag 'initial_contact_form[acquisition_details][donor_name]',
                            form.acquisition_details['donor_name'],
                            class: 'form-control',
                            placeholder: 'Ej: Juan P√©rez Garc√≠a',
                            data: { originally_required: 'true' } %>
        </div>

        <div class="col-md-6 mb-3">
          <%= label_tag 'acquisition_details[donor_relationship]', 'Relaci√≥n con el donante *', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[acquisition_details][donor_relationship]',
              options_from_collection_for_select(
                RelationshipType.active.where(category: 'herencia').ordered,
                :name,
                :display_name,
                form.acquisition_details['donor_relationship']
              ),
              prompt: 'Seleccione...',
              id: 'donor-relationship-select',
              class: 'form-select',
              data: { 'originally-required': 'true' } %>
        </div>
      </div>
      
      <div id="donor-other-field"
            style="<%= 'display:none;' unless form.acquisition_details['donor_relationship'] == 'otro' %>">
        <div class="mb-3">
          <%= label_tag 'acquisition_details_donor_relationship_other', 'Especifique relaci√≥n',
                        class: 'form-label' %>
          <%= text_field_tag 'initial_contact_form[acquisition_details][donor_relationship_other]',
                            form.acquisition_details['donor_relationship_other'],
                            class: 'form-control', maxlength: 100 %>
        </div>
      </div>
      
      <div class="mb-3">
        <%= label_tag 'acquisition_details_beneficiaries_count',
                      'N√∫mero de beneficiarios de la donaci√≥n *', class: 'form-label' %>
        <%= number_field_tag 'initial_contact_form[acquisition_details][beneficiaries_count]',
                            form.acquisition_details['beneficiaries_count'] || 1,
                            class: 'form-control', min: 1,
                            data: { originally_required: 'true' } %>
        <small class="text-muted">Los nombres completos se capturar√°n en la Business Transaction</small>
      </div>
    </div>
  </div>
  </div>
</div>


<script>
function initializeConditionalFields() {
  // HERENCIA: Campos condicionales
  const allLivingSelect = document.getElementById('all_living_select');
  const deceasedCountField = document.getElementById('deceased-count-field');

  if (allLivingSelect) {
    allLivingSelect.addEventListener('change', function() {
      deceasedCountField.style.display = this.value === 'false' ? 'block' : 'none';
    });
  }

  const allMarriedSelect = document.getElementById('all_married_select');
  const singleCountField = document.getElementById('single-count-field');

  if (allMarriedSelect) {
    allMarriedSelect.addEventListener('change', function() {
      singleCountField.style.display = this.value === 'false' ? 'block' : 'none';
    });
  }

  const inheritanceFromSelect = document.getElementById('inheritance-from-select');
  const inheritanceOtherField = document.getElementById('inheritance-other-field');

  if (inheritanceFromSelect) {
    inheritanceFromSelect.addEventListener('change', function() {
      inheritanceOtherField.style.display = this.value === 'otro' ? 'block' : 'none';
    });
  }

  const parentsMarriedSelect = document.getElementById('parents_married_select');
  const parentsRegimeField = document.getElementById('parents-regime-field');

  if (parentsMarriedSelect) {
    parentsMarriedSelect.addEventListener('change', function() {
      parentsRegimeField.style.display = this.value === 'true' ? 'block' : 'none';
    });
  }

  const hasTestamentarySelect = document.getElementById('has_testamentary_select');
  const noTestamentaryField = document.getElementById('no-testamentary-field');
  const yesTestamentaryField = document.getElementById('yes-testamentary-field');

  if (hasTestamentarySelect) {
    hasTestamentarySelect.addEventListener('change', function() {
      noTestamentaryField.style.display = this.value === 'false' ? 'block' : 'none';
      yesTestamentaryField.style.display = this.value === 'true' ? 'block' : 'none';
    });
  }

  // COMPRAVENTA: Parentesco
  const hasRelationshipCheck = document.getElementById('has_relationship_check');
  const relationshipField = document.getElementById('relationship-field');

  if (hasRelationshipCheck) {
    hasRelationshipCheck.addEventListener('change', function() {
      relationshipField.style.display = this.checked ? 'block' : 'none';
    });
  }

  // DONACI√ìN: Relaci√≥n otro
  const donorRelationshipSelect = document.getElementById('donor-relationship-select');
  const donorOtherField = document.getElementById('donor-other-field');

  if (donorRelationshipSelect) {
    donorRelationshipSelect.addEventListener('change', function() {
      donorOtherField.style.display = this.value === 'otro' ? 'block' : 'none';
    });
  }
  // Ejecutar cambios iniciales para mostrar campos seg√∫n valores guardados
  if (hasTestamentarySelect && hasTestamentarySelect.value) {
    hasTestamentarySelect.dispatchEvent(new Event('change'));
  }
  if (allLivingSelect && allLivingSelect.value) {
    allLivingSelect.dispatchEvent(new Event('change'));
  }
  if (allMarriedSelect && allMarriedSelect.value) {
    allMarriedSelect.dispatchEvent(new Event('change'));
  }
  if (inheritanceFromSelect && inheritanceFromSelect.value) {
    inheritanceFromSelect.dispatchEvent(new Event('change'));
  }
  if (parentsMarriedSelect && parentsMarriedSelect.value) {
    parentsMarriedSelect.dispatchEvent(new Event('change'));
  }
  if (donorRelationshipSelect && donorRelationshipSelect.value) {
    donorRelationshipSelect.dispatchEvent(new Event('change'));
  }
  if (hasRelationshipCheck && hasRelationshipCheck.checked) {
    hasRelationshipCheck.dispatchEvent(new Event('change'));
  }
  
  };

// Ejecutar al cargar inicial
document.addEventListener('DOMContentLoaded', initializeConditionalFields);

// Ejecutar cuando Turbo carga nuevo contenido
document.addEventListener('turbo:load', initializeConditionalFields);


</script>```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/_form.html.erb
--------------------------------------------
```ruby
<!-- app/views/initial_contact_forms/_form.html.erb -->
<!-- FORMULARIO REFACTORIZADO - 4 SECCIONES -->

<%= form_with(model: form, local: true, html: { class: 'initial-contact-form', id: 'contactForm' }) do |f| %>

  <%# ‚úÖ CAMPO OCULTO PARA AGENTE %>
  <%= f.hidden_field :agent_id, value: form.agent_id || current_user.agent&.id %>
  
  <% if form.errors.any? %>
    <div class="alert alert-danger">
      <h5>Errores en el formulario:</h5>
      <ul>
        <% form.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="bi bi-person-badge"></i>
        Formulario de Contacto Inicial
      </h2>
      <p class="mb-0 text-muted">
        <strong>Agente:</strong>
        <%= form.agent && form.agent.user ? form.agent.user.name : "No asignado" %>
      </p>
      <p class="mb-0 text-muted">
        <strong>Folio:</strong>
        <%= form.initial_contact_folio || "Sin folio" %>
      </p>
      <p class="mb-0 text-muted">
        <strong>Identificador:</strong>
        <%= form.opportunity_identifier || "Sin identificador" %>
      </p>
    </div>
  </div>



  <!-- IDENTIFICADOR DE LA OPORTUNIDAD -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-tag"></i> Identificador de la Oportunidad
      </h5>
    </div>
    <div class="card-body">
      <div class="row">

        <div class="col-md-12 mb-3">
          <%= f.label :opportunity_identifier, 'Nombre de la oportunidad *', class: 'form-label fw-bold' %>
          
          <%# Campo visible que muestra el identificador generado autom√°ticamente %>
          <div class="input-group">
            <span class="input-group-text" id="identifier-prefix">
              <i class="bi bi-tag"></i>
            </span>
            <% if form.opportunity_identifier.present? %>
              <%= f.text_field :opportunity_identifier,
                               class: 'form-control form-control-lg',
                               value: form.opportunity_identifier,
                               readonly: true %>
            <% else %>
              <%= f.text_field :opportunity_identifier,
                               class: 'form-control form-control-lg',
                               placeholder: 'Se generar√° autom√°ticamente al completar los datos',
                               readonly: false %>
            <% end %>
          </div>
          
          <small class="text-muted mt-2 d-block">
            <i class="bi bi-lightbulb"></i>
            <strong>Importante:</strong> Este identificador se genera autom√°ticamente a partir de:
            <br>
            <strong>Operaci√≥n</strong> (V=Venta, R=Renta) + <strong>Apellido</strong> + <strong>Calle</strong> + <strong>N√∫mero</strong> + <strong>Fecha</strong>
            <br>
            <strong>Ejemplo:</strong> V-CALDERON-INSURGENTES-1500-301-20251204
          </small>
        </div>


      </div>
      

  <!-- IDENTIFICADORES Y BOTONES DE EDICI√ìN -->
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-tag"></i> Identificadores y Datos Asociados
      </h5>
    </div>
    <div class="card-body">
      
      <!-- SECTION 1: OPORTUNIDAD -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h6 class="text-secondary">
            <i class="bi bi-bookmark"></i> Identificador de Oportunidad
          </h6>
          <div class="font-monospace bg-light p-3 rounded border border-secondary">
            <strong><%= form.opportunity_identifier || "Se genera autom√°ticamente" %></strong>
          </div>
          <small class="text-muted">
            Identifica ESTA OPORTUNIDAD (cliente + operaci√≥n + fecha)
            <br>
            Cambia si: El propietario o la fecha cambian
          </small>
        </div>
        
        <div class="col-md-6">
          <h6 class="text-secondary">
            <i class="bi bi-geo-alt"></i> Identificador de Propiedad
          </h6>
          <div class="font-monospace bg-light p-3 rounded border border-success">
            <strong><%= form.property&.property_id || "Pendiente" %></strong>
          </div>
          <small class="text-muted">
            Identifica LA PROPIEDAD (ubicaci√≥n permanente)
            <br>
            NO cambia aunque cambien clientes o propietarios
          </small>
        </div>
      </div>
      
      <hr class="my-4">
      
      
        <!-- SECTION 2: PROPIEDAD CON BOT√ìN -->
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="text-info mb-3">
              <i class="bi bi-house-fill"></i> Datos de la Propiedad
            </h6>
            
            <% if form.property_info.present? %>
              <div class="alert alert-success">
                <strong>‚úì Completado</strong>
                <br>
                <small>
                  <%= form.property_info['street'] %> <%= form.property_info['exterior_number'] %>
                  <br>
                  <%= form.property_info['neighborhood'] %>, <%= form.property_info['municipality'] %>
                </small>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Pendiente</strong>
                <br>
                <small>No hay datos de propiedad</small>
              </div>
            <% end %>

            <% if form.persisted? %>
              <%= button_to "Editar Propiedad", 
                  new_property_for_form_initial_contact_form_path(form),
                  method: :get,
                  class: 'btn btn-primary btn-sm w-100' %>
            <% else %>
              <button class="btn btn-primary btn-sm w-100" disabled>
                Guardar primero para editar propiedad
              </button>
            <% end %>
          </div>
          
          <!-- SECTION 3: CLIENTE CON BOT√ìN -->
          <div class="col-md-6">
            <h6 class="text-info mb-3">
              <i class="bi bi-person-fill"></i> Datos del Cliente/Propietario
            </h6>
            
            <% if form.general_conditions['owner_or_representative_name'].present? %>
              <div class="alert alert-success">
                <strong>‚úì Completado</strong>
                <br>
                <small>
                  <%= form.general_conditions['owner_or_representative_name'] %>
                  <br>
                  <%= form.general_conditions['owner_email'] %>
                </small>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Pendiente</strong>
                <br>
                <small>No hay datos del cliente</small>
              </div>
            <% end %>
            
            <% if form.persisted? %>
              <%= button_to "Editar Cliente", 
                  new_client_for_form_initial_contact_form_path(form),
                  method: :get,
                  class: 'btn btn-primary btn-sm w-100' %>
            <% else %>
              <button class="btn btn-primary btn-sm w-100" disabled>
                Guardar primero para editar cliente
              </button>
            <% end %>
          </div>
        </div>

        <hr class="my-4">


      
      <hr class="my-4">
      
      <!-- SECTION 4: COPROPIETARIOS -->
      <div class="row">
        <div class="col-12">
          <h6 class="text-warning mb-3">
            <i class="bi bi-people-fill"></i> Copropietarios 
            <% if form.acquisition_details['co_owners_count'].to_i > 1 %>
              (<%= form.acquisition_details['co_owners_count'] %> registrados)
            <% end %>
          </h6>
          
          <% if form.acquisition_details['co_owners_count'].to_i > 1 %>
            <div class="alert alert-info">
              <strong>‚ÑπÔ∏è Informaci√≥n Importante</strong>
              <br>
              <small>
                Hay <%= form.acquisition_details['co_owners_count'] %> copropietarios registrados.
                <br>
                Cada uno necesita un identificador de oportunidad y datos completos.
                <br>
                Los copropietarios son CLIENTES tambi√©n (aunque no directos).
              </small>
            </div>
            
            <% if form.persisted? %>
              <%= button_to "Editar Copropietarios", 
                  edit_co_owners_modal_initial_contact_form_path(form),
                  method: :get,
                  class: 'btn btn-primary btn-sm w-100',
                  data: { turbo_frame: 'modal' } %>
            <% else %>
              <button class="btn btn-primary btn-sm w-100" disabled>
                Guardar primero para editar copropietarios
              </button>
            <% end %>

          <% else %>
            <div class="alert alert-secondary">
              <small>Este formulario tiene 1 √∫nico propietario (sin copropietarios)</small>
            </div>
          <% end %>
        </div>
      </div>
      
    </div>
  </div>

  <!-- MODAL CONTAINER (Turbo Frame) -->
  <turbo-frame id="modal" target="_top"></turbo-frame>


  
  <!-- INDICADOR DE PROGRESO -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>Progreso de completitud</span>
        <strong><%= form.completion_percentage %>%</strong>
      </div>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" 
             style="width: <%= form.completion_percentage %>%">
          <%= form.completion_percentage %>% completado
        </div>
      </div>
    </div>
  </div>





  <!-- TABS DE NAVEGACI√ìN (4 SECCIONES) -->
  <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="section1-tab" data-bs-toggle="tab" data-bs-target="#section1" type="button">
        1. Condiciones Generales
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section2-tab" data-bs-toggle="tab" data-bs-target="#section2" type="button">
        2. Estatus Actual
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section3-tab" data-bs-toggle="tab" data-bs-target="#section3" type="button">
        3. Exenci√≥n ISR
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="section4-tab" data-bs-toggle="tab" data-bs-target="#section4" type="button">
        4. Promoci√≥n
      </button>
    </li>
  </ul>

  <!-- CONTENIDO DE TABS -->
  <div class="tab-content" id="formTabContent">
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 1: CONDICIONES GENERALES                           -->
    <!-- ========================================================== -->
    <div class="tab-pane fade show active" id="section1" role="tabpanel">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-1-circle"></i> Condiciones Generales</h5>
        </div>
        <div class="card-body">
          
          <!-- Tipo de Operaci√≥n y M√©todo de Adquisici√≥n -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :operation_type_id, '¬øQu√© tipo de operaci√≥n es? *', class: 'form-label' %>
              <%= f.collection_select :operation_type_id,
                                     OperationType.active.by_sort_order,
                                     :id,
                                     :display_name,
                                     { prompt: 'Seleccione tipo de operaci√≥n...' },
                                     { class: 'form-select', required: true } %>
              <small class="text-muted">Indica si es venta, renta, o ambas</small>
            </div>
            
            <div class="col-md-6 mb-3">
              <%= f.label :property_acquisition_method_id, '¬øC√≥mo adquiri√≥ la propiedad? *', class: 'form-label' %>
              <%= f.collection_select :property_acquisition_method_id,
                                     PropertyAcquisitionMethod.active.ordered,
                                     :id,
                                     :name,
                                     { prompt: 'Seleccione un m√©todo...' },
                                     { class: 'form-select',
                                       id: 'acquisition_method_select',
                                       required: true } %>
              
              <% if form.property_acquisition_method.present? %>
                <small class="text-muted mt-1 d-block">
                  <strong>Ref. legal:</strong> <%= form.property_acquisition_method.legal_reference %>
                </small>
              <% end %>
            </div>
          </div>
          
          <!-- Campo oculto con mapping ID -> Code para JavaScript -->
          <%= hidden_field_tag 'property_acquisition_method_codes',
                              @acquisition_method_codes,
                              id: 'acquisition_method_codes_data' %>
          
          <!-- Datos del propietario/representante -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :contract_signer_type_id, '¬øQui√©n firmar√° el contrato? *', class: 'form-label' %>
              <%= f.collection_select :contract_signer_type_id,
                                     ContractSignerType.active.ordered,
                                     :id,
                                     :display_name,
                                     { prompt: 'Seleccione...' },
                                     { class: 'form-select', required: true } %>
            </div>
            
          

            <!-- DESPU√âS: Campos separados -->
            <div class="card mb-4">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                  <i class="bi bi-person-fill"></i> Datos del Propietario/Representante
                </h5>
              </div>
              <div class="card-body">
                
                <!-- Nombre(s) propio(s) -->
                <div class="col-md-6 mb-3">
                  <%= label_tag 'general_conditions_first_names', 
                                'Nombre(s) propio(s) *', 
                                class: 'form-label' %>
                  <%= text_field_tag 'initial_contact_form[general_conditions][first_names]',
                                    form.general_conditions['first_names'],
                                    class: 'form-control',
                                    placeholder: 'Ej: Isabel Mar√≠a Luisa',
                                    required: true %>
                  <small class="text-muted">Incluye todos tus nombres propios</small>
                </div>
                
                <!-- Primer apellido -->
                <div class="col-md-6 mb-3">
                  <%= label_tag 'general_conditions_first_surname', 
                                'Primer Apellido *', 
                                class: 'form-label' %>
                  <%= text_field_tag 'initial_contact_form[general_conditions][first_surname]',
                                    form.general_conditions['first_surname'],
                                    class: 'form-control',
                                    placeholder: 'Ej: Calder√≥n',
                                    required: true %>
                  <small class="text-muted">Apellido paterno o principal</small>
                </div>
                
                <!-- Segundo apellido (opcional) -->
                <div class="col-md-6 mb-3">
                  <%= label_tag 'general_conditions_second_surname', 
                                'Segundo Apellido', 
                                class: 'form-label' %>
                  <%= text_field_tag 'initial_contact_form[general_conditions][second_surname]',
                                    form.general_conditions['second_surname'],
                                    class: 'form-control',
                                    placeholder: 'Ej: Grajales (opcional)' %>
                  <small class="text-muted">Apellido materno (si aplica)</small>
                </div>
                
                <!-- VISTA PREVIA: Nombre completo como aparecer√° -->
                <div class="col-md-12 mb-3">
                  <div class="bg-light p-3 rounded border">
                    <strong>‚úì Nombre legal (tal como aparecer√° en documentos):</strong>
                    <br>
                    <span class="font-monospace" id="full_name_preview">
                      <!-- Se actualiza con JavaScript -->
                      (Se completa al rellenar arriba)
                    </span>
                  </div>
                </div>
                
                <!-- Resto de datos de contacto -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= label_tag 'general_conditions_owner_phone', 
                                  'Tel√©fono de contacto', 
                                  class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[general_conditions][owner_phone]',
                                      form.general_conditions['owner_phone'],
                                      class: 'form-control',
                                      placeholder: '(55) 1234-5678',
                                      id: 'owner-phone-field' %>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <%= label_tag 'general_conditions_owner_email', 
                                  'Email de contacto', 
                                  class: 'form-label' %>
                    <%= email_field_tag 'initial_contact_form[general_conditions][owner_email]',
                                      form.general_conditions['owner_email'],
                                      class: 'form-control',
                                      placeholder: 'ejemplo@email.com' %>
                  </div>
                </div>
              </div>
            </div>
          </div>




          
          
          <div class="row">
          
          <div class="col-md-6 mb-3">
            <label for="civil_status_field" class="form-label">Estado civil al momento de la adquisici√≥n *</label>
            <%= select_tag 'initial_contact_form[general_conditions][civil_status]',
                options_from_collection_for_select(
                  CivilStatus.active.order(:sort_order),
                  :name,
                  :display_name,
                  form.general_conditions['civil_status']
                ),
                prompt: 'Seleccione...',
                class: 'form-select',
                id: 'civil-status-field',
                required: true %>
            <small class="text-muted">Estado civil del propietario</small>
          </div>

          <div class="col-md-6 mb-3 marriage-regime-field">
            <%= label_tag 'general_conditions_marriage_regime_id', 'R√©gimen matrimonial', class: 'form-label' %>
            <%= collection_select 'initial_contact_form[general_conditions]', :marriage_regime_id,
                                  MarriageRegime.active.ordered,
                                  :id, :display_name,
                                  { selected: form.general_conditions['marriage_regime_id'], prompt: 'Seleccione...' },
                                  { class: 'form-select' } %>
          </div>





          </div>
          



          <!-- ESTADO CIVIL ACTUAL (NUEVO) -->
          <div class="row mt-4">
            <div class="col-md-6 mb-3">
              <%= label_tag 'general_conditions[current_civil_status]', 'Estado civil actual *', class: 'form-label' %>

              <%= select_tag 'initial_contact_form[general_conditions][current_civil_status]',
                  options_from_collection_for_select(
                    CivilStatus.active.order(:sort_order),
                    :name,
                    :display_name,
                    form.general_conditions['current_civil_status']
                  ),
                  prompt: 'Seleccione...',
                  class: 'form-select',
                  id: 'current-civil-status-field',
                  required: true %>
              <small class="text-muted">Estado civil ACTUAL del propietario</small>
            </div>

            <div class="col-md-6 mb-3 current-marriage-regime-field" style="<%= 'display:none;' unless form.general_conditions['current_civil_status'] == 'casado' %>">
              <%= label_tag 'general_conditions_current_marriage_regime_id', 'R√©gimen matrimonial actual', class: 'form-label' %>
              <%= collection_select 'initial_contact_form[general_conditions]', :current_marriage_regime_id,
                                    MarriageRegime.active.ordered,
                                    :id, :display_name,
                                    { selected: form.general_conditions['current_marriage_regime_id'], prompt: 'Seleccione...' },
                                    { class: 'form-select' } %>
            </div>
          </div>



          <div class="mb-3">
            <%= label_tag 'general_conditions_notes', 'Observaciones adicionales', class: 'form-label' %>
            <%= text_area_tag 'initial_contact_form[general_conditions][notes]',
                             form.general_conditions['notes'],
                             class: 'form-control',
                             rows: 3,
                             placeholder: 'Cualquier informaci√≥n adicional relevante...' %>
          </div>


          <!-- CAMPOS GLOBALES (SIEMPRE VISIBLES) -->
          <div class="row mt-4 mb-4">
            <div class="col-12 mb-3">
              <h6 class="text-primary">
                <i class="bi bi-geo-alt"></i> Ubicaci√≥n y Uso
              </h6>
              <hr>
            </div>
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- DIRECCI√ìN DE LA PROPIEDAD                                              -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìç Ubicaci√≥n de la Propiedad</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <strong>Importante:</strong> La direcci√≥n se usar√° para generar el identificador √∫nico de la oportunidad y evitar duplicados en el sistema.
                </div>

                <div class="row">
                  <!-- Calle/Avenida -->
                  <div class="col-md-8 mb-3">
                    <%= f.label 'property_info[street]', 'Calle/Avenida *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][street]',
                                      form.property_info['street'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Av. Insurgentes Sur',
                                      required: true,
                                      id: 'property-street-field' %>
                    <small class="text-muted">Nombre completo de la calle o avenida</small>
                  </div>

                  <!-- N√∫mero Exterior -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[exterior_number]', 'N√∫mero Exterior *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][exterior_number]',
                                      form.property_info['exterior_number'],
                                      class: 'form-control',
                                      placeholder: 'Ej: 1500',
                                      required: true,
                                      id: 'property-exterior-field' %>
                  </div>
                </div>

                <div class="row">
                  <!-- N√∫mero Interior -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[interior_number]', 'N√∫mero Interior', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][interior_number]',
                                      form.property_info['interior_number'],
                                      class: 'form-control',
                                      placeholder: 'Ej: 301, Depto A',
                                      required: false,
                                      id: 'property-interior-field' %>
                    <small class="text-muted">Opcional</small>
                  </div>

                  <!-- Colonia -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[neighborhood]', 'Colonia *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][neighborhood]',
                                      form.property_info['neighborhood'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Del Valle',
                                      required: true %>
                  </div>

                  <!-- C√≥digo Postal -->
                  <div class="col-md-4 mb-3">
                    <%= f.label 'property_info[postal_code]', 'C√≥digo Postal *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][postal_code]',
                                      form.property_info['postal_code'],
                                      class: 'form-control',
                                      placeholder: '03100',
                                      required: true,
                                      pattern: '[0-9]{5}',
                                      maxlength: 5 %>
                  </div>
                </div>

                <div class="row">
                  <!-- Municipio/Alcald√≠a -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[municipality]', 'Municipio/Alcald√≠a *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][municipality]',
                                      form.property_info['municipality'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Benito Ju√°rez',
                                      required: true %>
                  </div>

                  <!-- Ciudad -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[city]', 'Ciudad *', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][city]',
                                      form.property_info['city'],
                                      class: 'form-control',
                                      placeholder: 'Ej: Ciudad de M√©xico',
                                      required: true %>
                  </div>
                </div>


                <!-- Estado (ahora en direcci√≥n) -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= f.label 'acquisition_details[state]', 'Estado *', class: 'form-label' %>
                    <%= select_tag 'initial_contact_form[acquisition_details][state]',
                                  options_from_collection_for_select(
                                    MexicanState.active.order(:sort_order),
                                    :name,
                                    :name,
                                    form.acquisition_details['state']
                                  ),
                                  prompt: 'Selecciona un estado...',
                                  id: 'property-state-field',
                                  class: 'form-select',
                                  required: true %>
                    <small class="text-muted">Estado donde se ubica la propiedad</small>
                  </div>

                  <!-- Pa√≠s (por defecto M√©xico) -->
                  <div class="col-md-6 mb-3">
                    <%= f.label 'property_info[country]', 'Pa√≠s', class: 'form-label' %>
                    <%= text_field_tag 'initial_contact_form[property_info][country]',
                                      form.property_info['country'] || 'M√©xico',
                                      class: 'form-control',
                                      readonly: true %>
                  </div>
                </div>


                <!-- Preview del identificador (se actualiza en tiempo real) -->
                <div class="alert alert-success mt-3">
                  <strong>üè∑Ô∏è Identificador de oportunidad:</strong>
                  <div id="opportunity-identifier-preview" class="mt-2 font-monospace fs-5">
                    <em class="text-muted">Se generar√° autom√°ticamente al completar los datos</em>
                  </div>
                  <small class="text-muted d-block mt-2">
                    Este identificador √∫nico se usar√° para rastrear la oportunidad y evitar duplicados
                  </small>
                </div>
              </div>
            </div>
           
            <div class="col-md-6 mb-3">
              <%= f.label 'acquisition_details[land_use]', 'Uso de suelo *', class: 'form-label' %>
              <%= select_tag 'initial_contact_form[acquisition_details][land_use]',
                            options_from_collection_for_select(
                              LandUseType.active.order(:sort_order),
                              :code,
                              :name,
                              form.acquisition_details['land_use']
                            ),
                            prompt: 'Selecciona uso de suelo...',
                            id: 'land_use_select',
                            class: 'form-select',
                            required: true %>
              <small class="text-muted">Clasificaci√≥n del inmueble</small>
            </div>


            <div class="col-md-6 mb-3">
              <%= f.label 'property_info[property_use]', 'Tipo de propiedad *', class: 'form-label' %>
              <%= select_tag 'initial_contact_form[property_info][property_use]',
                            options_from_collection_for_select(
                              PropertyType.active.order(:sort_order),
                              :id,
                              :display_name,
                              form.property_info['property_type']
                            ),
                            prompt: 'Selecciona tipo de propiedad...',
                            id: 'property_type_select',
                            class: 'form-select',
                            required: true %>
              <small class="text-muted">Tipo de propiedad</small>
            </div>


            
    








          </div>

        </div>
      </div>
      
      <!-- CAMPOS CONDICIONALES POR M√âTODO DE ADQUISICI√ìN (INLINE) -->
      <%= render 'conditional_fields', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->








          </div>

        </div>
      </div>
      
      <!-- CAMPOS CONDICIONALES POR M√âTODO DE ADQUISICI√ìN (INLINE) -->
      <%= render 'conditional_fields', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 2: ESTATUS ACTUAL                                  -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section2" role="tabpanel">
      <%= render 'section_current_status', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 3: EXENCI√ìN ISR                                    -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section3" role="tabpanel">
      <%= render 'section_tax_exemption', form: form, f: f %>
    </div>
    
    <!-- ========================================================== -->
    <!-- SECCI√ìN 4: PROMOCI√ìN                                       -->
    <!-- ========================================================== -->
    <div class="tab-pane fade" id="section4" role="tabpanel">
      <%= render 'section_promotion', form: form, f: f %>
    </div>
    
  </div>

  <!-- BOTONES DE NAVEGACI√ìN -->
  <div class="d-flex justify-content-between mt-4">
    <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
      <i class="bi bi-arrow-left"></i> Anterior
    </button>
    
    <div>
      <%= f.submit 'Guardar Borrador', 
                  name: 'save_draft', 
                  class: 'btn btn-outline-primary me-2',
                  formnovalidate: true %>
      
      <% if @initial_contact_form.persisted? && @initial_contact_form.draft? %>
        <%= f.submit 'Guardar y Completar', 
                    name: 'complete', 
                    class: 'btn btn-success',
                    data: { confirm: '¬øCompletar este formulario? Se generar√° el identificador y podr√°s convertirlo a transacci√≥n.' } %>
      <% elsif @initial_contact_form.persisted? %>
        <%= f.submit 'Actualizar', 
                    name: 'update',
                    class: 'btn btn-primary' %>
      <% else %>
        <%= f.submit 'Guardar y Completar', 
                    name: 'complete',
                    class: 'btn btn-primary' %>
      <% end %>
    </div>




    <button type="button" class="btn btn-secondary" id="nextBtn">
      Siguiente <i class="bi bi-arrow-right"></i>
    </button>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const operationTypeSelect = document.querySelector('select[name="initial_contact_form[operation_type_id]"]');
    const firstSurnameField = document.querySelector('input[name="initial_contact_form[general_conditions][first_surname]"]');
    const streetField = document.getElementById('property-street-field');
    const exteriorField = document.getElementById('property-exterior-field');
    const interiorField = document.getElementById('property-interior-field');
    const identifierField = document.querySelector('input[name="initial_contact_form[opportunity_identifier]"]');
    const previewDiv = document.getElementById('opportunity-identifier-preview');
    const phoneField = document.getElementById('owner-phone-field');

    function updateIdentifierPreview() {
      const operationTypeId = operationTypeSelect?.value || '';
      const firstSurname = firstSurnameField?.value || '';
      const street = streetField?.value || '';
      const exterior = exteriorField?.value || '';
      const interior = interiorField?.value || '';

      // Validar campos m√≠nimos
      if (!operationTypeId || !firstSurname || !street || !exterior) {
        if (previewDiv) {
          previewDiv.innerHTML = '<em class="text-muted">Completa: operaci√≥n, apellido, calle y n√∫mero exterior</em>';
        }
        if (identifierField) {
          identifierField.value = '';
        }
        return;
      }

      // Extraer c√≥digo de operaci√≥n
      const selectedOption = operationTypeSelect?.options[operationTypeSelect.selectedIndex];
      const operationType = selectedOption ? selectedOption.text.toLowerCase() : '';
      let opCode = 'X';

      if (operationType.includes('venta') || operationType.includes('sale')) {
        opCode = 'V';
      } else if (operationType.includes('renta') || operationType.includes('rent')) {
        opCode = 'R';
      } else if (operationType.includes('traspaso')) {
        opCode = 'T';
      }

      // Limpiar apellido (sin acentos, sin caracteres especiales, uppercase)
      const lastNameClean = firstSurname
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9]/g, '')
        .toUpperCase()
        .slice(0, 10);

      // Limpiar calle
      const streetClean = street
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9]/g, '')
        .toUpperCase()
        .slice(0, 15);

      // Generar fecha
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const dateStr = `${year}${month}${day}`;

      // Construir identificador (igual l√≥gica que Rails)
      let identifier = `${opCode}-${lastNameClean}-${streetClean}-${exterior}`;
      if (interior && interior.trim()) {
        identifier += `-${interior.slice(0, 3)}`;
      }
      identifier += `-${dateStr}`;

      // IMPORTANTE: Actualizar AMBOS: preview y campo hidden
      if (previewDiv) {
        previewDiv.innerHTML = `
          <code class="text-success fs-5">${identifier}</code>
          <small class="d-block text-muted mt-2">
            <strong>Desglose:</strong> ${opCode} (operaci√≥n) | ${lastNameClean} (cliente) | ${streetClean}-${exterior}${interior ? `-${interior}` : ''} (propiedad) | ${dateStr} (fecha)
          </small>
        `;
      }

      // ‚úÖ ACTUALIZAR EL CAMPO HIDDEN (esto es lo CR√çTICO)
      if (identifierField) {
        identifierField.value = identifier;
      }

      console.log('‚úÖ Identifier updated:', identifier);
    }

    // Event listeners
    if (operationTypeSelect) operationTypeSelect.addEventListener('change', updateIdentifierPreview);
    if (firstSurnameField) firstSurnameField.addEventListener('input', updateIdentifierPreview);
    if (streetField) streetField.addEventListener('input', updateIdentifierPreview);
    if (exteriorField) exteriorField.addEventListener('input', updateIdentifierPreview);
    if (interiorField) interiorField.addEventListener('input', updateIdentifierPreview);
    if (phoneField) {
      phoneField.addEventListener('blur', function(e) {
        let phone = e.target.value.trim();
        
        if (!phone) return;
        
        let cleaned = phone.replace(/[\s\-()]/g, '');
        
        if (cleaned.match(/^\d{10}$/)) {
          e.target.value = cleaned.slice(0, 2) + ' ' + 
                           cleaned.slice(2, 6) + ' ' + 
                           cleaned.slice(6, 10);
        }
      });
    }

    // Trigger inicial
    setTimeout(() => updateIdentifierPreview(), 100);
  });
  </script>

    <% end %>

<!-- JAVASCRIPT -->
<%= render 'form_javascript' %>
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/_form_javascript.html.erb
--------------------------------------------
```ruby
<!-- app/views/initial_contact_forms/_form_javascript.html.erb -->
<!-- JAVASCRIPT FINAL - VERSI√ìN VALIDADA Y CORREGIDA -->


<script>
function initializeInitialContactForm() {
  console.log('üöÄ InitialContactForm JavaScript initializing...');
  
  // ========================================================================
  // NAVEGACI√ìN ENTRE TABS
  // ========================================================================
  const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  let currentTab = 0;

  function updateButtons() {
    if (prevBtn && nextBtn) {
      prevBtn.disabled = currentTab === 0;
      nextBtn.disabled = currentTab === tabs.length - 1;
    }
  }

  if (nextBtn && prevBtn) {
    nextBtn.addEventListener('click', () => {
      if (currentTab < tabs.length - 1) {
        currentTab++;
        tabs[currentTab].click();
        updateButtons();
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentTab > 0) {
        currentTab--;
        tabs[currentTab].click();
        updateButtons();
      }
    });

    tabs.forEach((tab, index) => {
      tab.addEventListener('shown.bs.tab', () => {
        currentTab = index;
        updateButtons();
      });
    });

    updateButtons();
  }

  // ========================================================================
  // FUNCI√ìN PARA LIMPIAR CAMPOS DE SECCIONES OCULTAS
  // ========================================================================

function clearHiddenSectionFields(exceptSectionId) {
  const conditionalSections = document.querySelectorAll('.conditional-section');
  
  conditionalSections.forEach(section => {
    // Si la secci√≥n NO es la que estamos mostrando
    if (section.id !== exceptSectionId && section.style.display === 'none') {
      // Limpiar SOLO los campos espec√≠ficos del formulario condicional
      // NO limpiar co_owners_count, state, etc que pueden estar en varias secciones
      
      const fieldsToPreserve = [
        'co_owners_count', 'state', 'land_use', 'condominium_regime', 
        'rental_units_count', 'mortgage_balance', 'monthly_payment',
        'opportunity_identifier'
      ];
      
      const inputs = section.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"]');
      inputs.forEach(input => {
        // Obtener el nombre del campo (√∫ltimo elemento despu√©s de ][)
        const fieldName = input.name.split('[').pop().replace(']', '');
        
        // NO limpiar si est√° en la lista de campos a preservar
        if (!fieldsToPreserve.includes(fieldName) && !input.hasAttribute('data-keep-value')) {
          input.value = '';
        }
      });
      
      // Desmarcar checkboxes
      const checkboxes = section.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (!checkbox.hasAttribute('data-keep-value')) {
          checkbox.checked = false;
        }
      });
      
      // Resetear selects (EXCEPTO state que es requerido)
      const selects = section.querySelectorAll('select');
      selects.forEach(select => {
        const fieldName = select.name.split('[').pop().replace(']', '');
        if (fieldName !== 'state' && !select.hasAttribute('data-keep-value')) {
          select.selectedIndex = 0;
        }
      });
      
      console.log('üßπ Cleared fields in hidden section:', section.id);
    }
  });
}




  // ========================================================================
  // FUNCI√ìN PARA MANEJAR REQUIRED EN CAMPOS CONDICIONALES
  // ========================================================================
  function updateRequiredFields() {
    const conditionalSections = document.querySelectorAll('.conditional-section');
    
    conditionalSections.forEach(section => {
      const isVisible = section.style.display === 'block';
      const requiredInputs = section.querySelectorAll('input, select, textarea');
      
      requiredInputs.forEach(input => {
        if (!input.hasAttribute('data-originally-required')) {
          if (input.hasAttribute('required')) {
            input.setAttribute('data-originally-required', 'true');
          }
        }
        
        const wasRequired = input.getAttribute('data-originally-required') === 'true';
        
        if (isVisible && wasRequired) {
          input.setAttribute('required', 'required');
        } else if (!isVisible) {
          input.removeAttribute('required');
        }
      });
    });
  }

  // ========================================================================
  // CAMPOS CONDICIONALES POR M√âTODO DE ADQUISICI√ìN
  // ========================================================================
  const methodSelect = document.getElementById('acquisition_method_select');
  const conditionalSections = document.querySelectorAll('.conditional-section');
  
  const methodCodesData = document.getElementById('acquisition_method_codes_data');
  
  if (!methodCodesData) {
    console.error('‚ùå No se encontr√≥ el campo acquisition_method_codes_data');
    return;
  }
  
  // CORRECCI√ìN: Validar que methodCodesData.value no est√© vac√≠o
  let methodCodes = {};
  try {
    const codesValue = methodCodesData.value;
    if (codesValue && codesValue.trim()) {
      methodCodes = JSON.parse(codesValue);
    }
  } catch (e) {
    console.error('‚ùå Error parsing method codes:', e);
    methodCodes = {};
  }
  
  const methodSectionMap = {
    'compraventa': 'compraventa-fields',
    'compraventa_derechos': 'compraventa-fields',
    'herencia': 'herencia-fields',
    'usucapion': 'usucapion-fields',
    'prescripcion_negativa': 'usucapion-fields',
    'dacion_pago': 'dacion-pago-fields',
    'donacion': 'donacion-fields'
  };
  
  // ========================================================================
  // MOSTRAR/OCULTAR CAMPOS CONDICIONALES
  // ========================================================================
  function showConditionalFields(methodId, isInitialLoad = false) {
    console.log('üîç Showing fields for method ID:', methodId, 'isInitialLoad:', isInitialLoad);
    
    // Ocultar todas las secciones
    conditionalSections.forEach(section => {
      section.style.display = 'none';
    });
    
    if (!methodId || methodId === '') {
      console.log('‚ö†Ô∏è No method selected');
      updateRequiredFields();
      return;
    }
    
    const selectedId = parseInt(methodId);
    const methodCode = methodCodes[selectedId];
    
    console.log('Selected ID:', selectedId, 'Method Code:', methodCode);
    
    let sectionToShow = null;
    
    if (methodCode && methodSectionMap[methodCode]) {
      const sectionId = methodSectionMap[methodCode];
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
        sectionToShow = sectionId;
        console.log('‚úÖ Showing section:', sectionId);
      } else {
        console.error('‚ùå Section not found:', sectionId);
      }
    } else if (methodCode) {
      const section = document.getElementById('otros-fields');
      if (section) {
        section.style.display = 'block';
        sectionToShow = 'otros-fields';
        console.log('‚úÖ Showing generic section for:', methodCode);
      } else {
        console.warn('‚ö†Ô∏è Generic section "otros-fields" not found');
      }
    } else {
      console.warn('‚ö†Ô∏è No method code found for ID:', selectedId);
    }
    
    // IMPORTANTE: SOLO limpiar si NO es la carga inicial
    if (!isInitialLoad) {
      clearHiddenSectionFields(sectionToShow);
    }
    
    updateRequiredFields();
  }

  if (methodSelect) {
    console.log('‚úÖ Method select found');
    
    // Evento cuando cambia el select (el usuario lo cambia manualmente)
    methodSelect.addEventListener('change', function() {
      console.log('üìå Method changed:', this.value);
      showConditionalFields(this.value, false); // NO es carga inicial
    });
    
    // Trigger inicial (cuando carga la p√°gina)
    setTimeout(() => {
      if (methodSelect.value && methodSelect.value !== '') {
        console.log('üîÑ Triggering initial load for:', methodSelect.value);
        showConditionalFields(methodSelect.value, true); // S√ç es carga inicial
      } else {
        console.log('‚ö†Ô∏è No method selected on initial load');
        updateRequiredFields();
      }
    }, 50);
  } else {
    console.error('‚ùå Method select not found: acquisition_method_select');
  }



  // ========================================================================
  // SECCI√ìN 1: CONDICIONES GENERALES - Estado civil y Nombre Legal
  // ========================================================================

  const firstNamesField = document.querySelector('input[name="initial_contact_form[general_conditions][first_names]"]');
  const firstSurnameField = document.querySelector('input[name="initial_contact_form[general_conditions][first_surname]"]');
  const secondSurnameField = document.querySelector('input[name="initial_contact_form[general_conditions][second_surname]"]');
  const fullNamePreview = document.getElementById('full_name_preview');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SELECTORES DE ESTADO CIVIL (AL MOMENTO DE COMPRA)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const civilStatusField = document.getElementById('civil-status-field');
  const marriageRegimeField = document.querySelector('.marriage-regime-field');
  const marriageRegimeSelect = marriageRegimeField?.querySelector('select');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SELECTORES DE ESTADO CIVIL ACTUAL (NUEVO)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const currentCivilStatusField = document.getElementById('current-civil-status-field');
  const currentMarriageField = document.querySelector('.current-marriage-regime-field');
  const currentMarriageSelect = currentMarriageField?.querySelector('select');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FUNCI√ìN: Actualizar Preview de Nombre Legal
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function updateFullNamePreview() {
    if (!fullNamePreview) return;
    
    const firstName = firstNamesField?.value?.trim() || '';
    const firstSurname = firstSurnameField?.value?.trim() || '';
    const secondSurname = secondSurnameField?.value?.trim() || '';
    
    // Validar que haya al menos nombre y primer apellido
    if (!firstName || !firstSurname) {
      fullNamePreview.innerHTML = '<em class="text-muted">(Se completa al rellenar arriba)</em>';
      return;
    }
    
    // Construir el nombre legal
    let fullName = `${firstName} ${firstSurname}`;
    if (secondSurname) {
      fullName += ` ${secondSurname}`;
    }
    
    // Mostrar el nombre en el preview
    fullNamePreview.innerHTML = `<strong>${fullName.trim()}</strong>`;
    console.log('‚úÖ Full name updated:', fullName.trim());
  }

  // Event listeners para el nombre legal
  if (firstNamesField) firstNamesField.addEventListener('input', updateFullNamePreview);
  if (firstSurnameField) firstSurnameField.addEventListener('input', updateFullNamePreview);
  if (secondSurnameField) secondSurnameField.addEventListener('input', updateFullNamePreview);

  // Trigger inicial
  setTimeout(() => updateFullNamePreview(), 100);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FUNCI√ìN: Manejar visibilidad de r√©gimen matrimonial (AL MOMENTO DE COMPRA)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function updateMarriageRegimeVisibility() {
    if (!civilStatusField || !marriageRegimeField) {
      console.warn('‚ö†Ô∏è Marriage regime elements not found');
      return;
    }
    
    const civilStatus = civilStatusField.value;
    console.log('üîç Civil Status changed to:', civilStatus);
    
    const isMarried = civilStatus === 'casado';
    
    // Mostrar/ocultar el campo de r√©gimen matrimonial
    marriageRegimeField.style.display = isMarried ? 'block' : 'none';
    
    // Si est√° casado, hacer el select required; si no, hacerlo optional
    if (marriageRegimeSelect) {
      if (isMarried) {
        marriageRegimeSelect.setAttribute('required', 'required');
        console.log('‚úÖ Marriage regime field shown (required)');
      } else {
        marriageRegimeSelect.removeAttribute('required');
        marriageRegimeSelect.selectedIndex = 0;
        console.log('‚úÖ Marriage regime field hidden (not required)');
      }
    }
  }

  if (civilStatusField) {
    civilStatusField.addEventListener('change', updateMarriageRegimeVisibility);
    // Ejecutar inmediatamente al cargar para mostrar estado inicial correcto
    updateMarriageRegimeVisibility();
    console.log('‚úÖ Civil status field listener attached (immediate execution)');
  } else {
    console.warn('‚ö†Ô∏è civil-status-field not found');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FUNCI√ìN: Manejar visibilidad de r√©gimen matrimonial ACTUAL (NUEVO)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function updateCurrentMarriageRegimeVisibility() {
    if (!currentCivilStatusField || !currentMarriageField) {
      console.warn('‚ö†Ô∏è Current marriage regime elements not found');
      return;
    }
    
    const currentCivilStatus = currentCivilStatusField.value;
    console.log('üîç Current Civil Status changed to:', currentCivilStatus);
    
    const isMarried = currentCivilStatus === 'casado';
    
    // Mostrar/ocultar el campo de r√©gimen matrimonial actual
    currentMarriageField.style.display = isMarried ? 'block' : 'none';
    
    // Si est√° casado, hacer el select required; si no, hacerlo optional
    if (currentMarriageSelect) {
      if (isMarried) {
        currentMarriageSelect.setAttribute('required', 'required');
        console.log('‚úÖ Current marriage regime field shown (required)');
      } else {
        currentMarriageSelect.removeAttribute('required');
        currentMarriageSelect.selectedIndex = 0;
        console.log('‚úÖ Current marriage regime field hidden (not required)');
      }
    }
  }

  if (currentCivilStatusField) {
    currentCivilStatusField.addEventListener('change', updateCurrentMarriageRegimeVisibility);
    // Ejecutar al cargar para mostrar estado inicial correcto
    setTimeout(() => updateCurrentMarriageRegimeVisibility(), 100);
    console.log('‚úÖ Current civil status field listener attached');
  } else {
    console.warn('‚ö†Ô∏è current-civil-status-field not found');
  }



  // ========================================================================
  // SECCI√ìN 2: ESTATUS ACTUAL
  // ========================================================================
  
  const currentMortgageCheck = document.getElementById('current_has_mortgage_check');
  const mortgageSection = document.querySelector('.mortgage-section');
  
  if (currentMortgageCheck && mortgageSection) {
    currentMortgageCheck.addEventListener('change', function(e) {
      mortgageSection.style.display = e.target.checked ? 'block' : 'none';
    });
    if (currentMortgageCheck.checked) {
      mortgageSection.style.display = 'block';
    }
  }

  const condominiumCheck = document.getElementById('is_in_condominium_check');
  const condominiumDetails = document.querySelector('.condominium-details');
  
  if (condominiumCheck && condominiumDetails) {
    condominiumCheck.addEventListener('change', function(e) {
      condominiumDetails.style.display = e.target.checked ? 'block' : 'none';
    });
    if (condominiumCheck.checked) {
      condominiumDetails.style.display = 'block';
    }
  }

  const rentalCheck = document.getElementById('has_rental_units_check');
  const rentalDetails = document.querySelector('.rental-details');
  
  if (rentalCheck && rentalDetails) {
    rentalCheck.addEventListener('change', function(e) {
      rentalDetails.style.display = e.target.checked ? 'block' : 'none';
    });
    if (rentalCheck.checked) {
      rentalDetails.style.display = 'block';
    }
  }

  // ========================================================================
  // SECCI√ìN 3: EXENCI√ìN ISR
  // ========================================================================
  
  const previousSalesCheck = document.getElementById('previous_sales_check');
  const previousSalesDetails = document.querySelector('.previous-sale-details');
  
  if (previousSalesCheck && previousSalesDetails) {
    previousSalesCheck.addEventListener('change', function(e) {
      previousSalesDetails.style.display = e.target.checked ? 'block' : 'none';
    });
    if (previousSalesCheck.checked) {
      previousSalesDetails.style.display = 'block';
    }
  }

  // ========================================================================
  // SECCI√ìN 4: PROMOCI√ìN
  // ========================================================================
  
  const signageCheck = document.getElementById('allows_signage_check');
  const signageDetails = document.querySelector('.signage-details');
  
  if (signageCheck && signageDetails) {
    signageCheck.addEventListener('change', function(e) {
      signageDetails.style.display = e.target.checked ? 'block' : 'none';
    });
    if (signageCheck.checked) {
      signageDetails.style.display = 'block';
    }
  }

  // ========================================================================
  // VALIDACI√ìN ANTES DE SUBMIT
  // ========================================================================
  const form = document.getElementById('contactForm');
  // üî¥ CAPTURE FORM DATA BEFORE SUBMIT
  const originalSubmit = form.submit;
  form.submit = function() {
    const formData = new FormData(this);
    const params = new URLSearchParams(formData);
    console.log('üü¢ FORM DATA BEFORE SUBMIT:');
    console.log('co_owners_count:', params.get('initial_contact_form[acquisition_details][co_owners_count]'));
    console.log('Full params:', params.toString());
    originalSubmit.call(this);
  };
  
  if (form) {
    // Debugger para co_owners_count
    const coOwnersInput = document.querySelector('[name="initial_contact_form[acquisition_details][co_owners_count]"]');
    if (coOwnersInput) {
      coOwnersInput.addEventListener('change', function() {
        console.log('üî¥ co_owners_count input changed to:', this.value);
      });
      
      form.addEventListener('submit', function(e) {
        console.log('üü† SUBMIT - co_owners_count ANTES:', coOwnersInput.value);
        // Asegurar que tenga el valor
        if (coOwnersInput.value === '' || coOwnersInput.value === '0') {
          coOwnersInput.value = '1';
        }
        console.log('üü† SUBMIT - co_owners_count DESPU√âS:', coOwnersInput.value);
        updateRequiredFields();
      });
    }

    form.addEventListener('submit', function(e) {
      updateRequiredFields();
      console.log('üìù Form submitting...');
    });
  }
  // ========================================================================
  // AMPLIACIONES
  // ========================================================================
  const additionsCheck = document.getElementById('has_additions_check');
  const additionsSection = document.querySelector('.additions-section');

  if (additionsCheck && additionsSection) {
    additionsCheck.addEventListener('change', function(e) {
      additionsSection.style.display = e.target.checked ? 'block' : 'none';
    });
    if (additionsCheck.checked) {
      additionsSection.style.display = 'block';
    }
  }

  // ========================================================================
  // REMODELACIONES
  // ========================================================================
  const renovationsCheck = document.getElementById('has_renovations_check');
  const renovationsSection = document.querySelector('.renovations-section');

  if (renovationsCheck && renovationsSection) {
    renovationsCheck.addEventListener('change', function(e) {
      renovationsSection.style.display = e.target.checked ? 'block' : 'none';
    });
    if (renovationsCheck.checked) {
      renovationsSection.style.display = 'block';
    }
  }

  const renovationKnownSelect = document.getElementById('renovation_known_select');
  const renovationCostField = document.querySelector('.renovation-cost-field');

  if (renovationKnownSelect && renovationCostField) {
    renovationKnownSelect.addEventListener('change', function(e) {
      renovationCostField.style.display = e.target.value === 'true' ? 'block' : 'none';
    });
    if (renovationKnownSelect.value === 'true') {
      renovationCostField.style.display = 'block';
    }
  }


  // ========================================================================
  // SECCI√ìN 2: ESTATUS ACTUAL - Hipoteca - Despacho de cobranza
  // ========================================================================
  
  const mortgagePaymentsSelect = document.getElementById('mortgage_payments_current_select');
  const mortgageCollectionField = document.querySelector('.mortgage-collection-field');
  
  if (mortgagePaymentsSelect && mortgageCollectionField) {
    mortgagePaymentsSelect.addEventListener('change', function(e) {
      // Mostrar campo de cobranza SOLO si NO est√° al corriente
      mortgageCollectionField.style.display = e.target.value === 'false' ? 'block' : 'none';
    });
    // Trigger inicial
    if (mortgagePaymentsSelect.value === 'false') {
      mortgageCollectionField.style.display = 'block';
    }
  }

  // ========================================================================
  // SECCI√ìN 2: ESTATUS ACTUAL - Ampliaciones
  // ========================================================================
  
  const extensionsCheck = document.getElementById('has_extensions_check');
  const extensionsSection = document.querySelector('.extensions-section');
  
  if (extensionsCheck && extensionsSection) {
    extensionsCheck.addEventListener('change', function(e) {
      extensionsSection.style.display = e.target.checked ? 'block' : 'none';
    });
    if (extensionsCheck.checked) {
      extensionsSection.style.display = 'block';
    }
  }

  // ========================================================================
  // SECCI√ìN 2: ESTATUS ACTUAL - Remodelaciones
  // ========================================================================
  
 




  console.log('‚úÖ JavaScript initialization complete');
}






// ========================================================================
// EVENTOS TURBO
// ========================================================================

document.addEventListener('turbo:load', function() {
  console.log('üéØ turbo:load event fired');
  initializeInitialContactForm();
});

document.addEventListener('DOMContentLoaded', function() {
  console.log('üéØ DOMContentLoaded event fired');
  if (typeof Turbo === 'undefined') {
    initializeInitialContactForm();
  }
});


</script>

<style>
/* ========================================================================== */
/* ESTILOS PARA CAMPOS CONDICIONALES                                         */
/* ========================================================================== */

.conditional-section {
  margin-top: 1.5rem;
  animation: fadeIn 0.3s ease-in;
  opacity: 1;
  visibility: visible;
  transition: opacity 0.3s ease-in, visibility 0.3s ease-in;
}

.conditional-section[style*="display: none"],
.conditional-section[style*="display:none"] {
  display: none !important;
  opacity: 0;
  visibility: hidden;
}

/* Animaci√≥n de aparici√≥n suave */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Estilo de tarjeta para secciones condicionales */
.conditional-section .card {
  border-left: 4px solid #0d6efd;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  transition: box-shadow 0.3s ease;
}

.conditional-section .card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.conditional-section .card-header {
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* Estilos para campos dentro de secciones condicionales */
.conditional-section .form-control,
.conditional-section .form-select {
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.conditional-section .form-control:focus,
.conditional-section .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Alertas dentro de secciones condicionales */
.conditional-section .alert {
  border-radius: 0.375rem;
  margin-bottom: 1rem;
}

/* Campos con atributo data-originally-required */
[data-originally-required="true"] {
  background-color: rgba(13, 110, 253, 0.02);
}

[data-originally-required="true"]:invalid {
  border-color: #dc3545;
}
</style>
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/_section_current_status.html.erb
--------------------------------------------
```ruby
<div class="card">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0"><i class="bi bi-2-circle"></i> Estatus Actual de la Propiedad</h5>
  </div>
  <div class="card-body">
    
    <h6 class="mb-3">Hipoteca y Financiamiento</h6>
    
    <div class="mb-3">
      <div class="form-check">
        <%= check_box_tag 'initial_contact_form[current_status][has_active_mortgage]',
                         '1',
                         form.current_status['has_active_mortgage'],
                         class: 'form-check-input',
                         id: 'current_has_mortgage_check' %>
        <%= label_tag 'current_has_mortgage_check', '¬øTiene hipoteca activa que liquidar?', class: 'form-check-label' %>
      </div>
    </div>
    

    <div class="mortgage-section" style="display: none;">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label 'current_status[mortgage_balance]', 'Saldo hipotecario aproximado', class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[current_status][mortgage_balance]',
                              form.current_status['mortgage_balance'],
                              class: 'form-control',
                              placeholder: '$',
                              step: '0.01' %>
        </div>
        
        <div class="col-md-4 mb-3">
          <%= label_tag 'current_status[mortgage_payments_current]', '¬øEst√° al corriente en los pagos? *', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][mortgage_payments_current]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['S√≠', 'true'],
                          ['No', 'false'],
                          ['No sabe', 'unknown']
                        ], form.current_status['mortgage_payments_current']),
                        id: 'mortgage_payments_current_select',
                        class: 'form-select',
                        data: { originally_required: 'true' } %>
        </div>
        
        <div class="col-md-4 mb-3 mortgage-collection-field" style="display: none;">
          <%= label_tag 'current_status[in_collection_agency]', '¬øEst√° en despacho de cobranza?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][in_collection_agency]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['S√≠', 'true'],
                          ['No', 'false'],
                          ['No sabe', 'unknown']
                        ], form.current_status['in_collection_agency']),
                        class: 'form-select' %>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-12 mb-3">
          <%= f.label 'current_status[mortgage_notes]', 'Notas sobre hipoteca', class: 'form-label' %>
          <%= text_area_tag 'initial_contact_form[current_status][mortgage_notes]',
                            form.current_status['mortgage_notes'],
                            class: 'form-control',
                            rows: 2,
                            placeholder: 'Informaci√≥n adicional sobre la hipoteca...' %>
        </div>
      </div>
    </div>
   



    
    <h6 class="mt-4 mb-3">Remodelaciones y Mejoras</h6>

    <!-- Ampliaciones -->
    <div class="form-check mb-3">
      <%= check_box_tag 'initial_contact_form[current_status][has_extensions]',
                        'true',
                        form.current_status['has_extensions'] == 'true',
                        id: 'has_extensions_check',
                        class: 'form-check-input' %>
      <%= label_tag 'has_extensions_check', '¬øLa propiedad tiene ampliaciones?', class: 'form-check-label' %>
    </div>

    <div class="extensions-section" style="display: none;">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= label_tag 'current_status[extensions_reported]', '¬øEst√°n reportadas?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][extensions_reported]',
                         options_for_select([
                           ['Seleccione...', ''],
                           ['S√≠', 'true'],
                           ['No', 'false'],
                           ['No sabe', 'unknown']
                         ], form.current_status['extensions_reported']),
                         class: 'form-select' %>
        </div>

        <div class="col-md-6 mb-3">
          <%= f.label 'current_status[extensions_notes]', 'Notas sobre ampliaciones', class: 'form-label' %>
          <%= text_area_tag 'initial_contact_form[current_status][extensions_notes]',
                            form.current_status['extensions_notes'],
                            class: 'form-control',
                            rows: 2,
                            placeholder: 'Detalles de las ampliaciones...' %>
        </div>
      </div>
    </div>


<!-- ========================================================================== -->
<!-- REEMPLAZAR EN SECCI√ìN 2: ESTATUS ACTUAL                                   -->
<!-- El checkbox simple de remodelaciones por esta secci√≥n completa            -->
<!-- ========================================================================== -->

    <!-- Remodelaciones -->
    <div class="form-check mb-3">
      <%= check_box_tag 'initial_contact_form[current_status][has_renovations]',
                        'true',
                        form.current_status['has_renovations'] == 'true',
                        id: 'has_renovations_check',
                        class: 'form-check-input' %>
      <%= label_tag 'has_renovations_check', '¬øSe realizaron remodelaciones?', class: 'form-check-label' %>
    </div>

    <div class="renovations-section" style="display: none;">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= label_tag 'current_status[knows_renovation_cost]', '¬øConoce el monto aproximado de inversi√≥n?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][knows_renovation_cost]',
                         options_for_select([
                           ['Seleccione...', ''],
                           ['S√≠', 'true'],
                           ['No', 'false']
                         ], form.current_status['knows_renovation_cost']),
                         id: 'renovation_known_select',
                         class: 'form-select' %>
        </div>

        <div class="col-md-6 mb-3 renovation-cost-field" style="display: none;">
          <%= f.label 'current_status[renovation_cost]', 'Monto aproximado de inversi√≥n', class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[current_status][renovation_cost]',
                               form.current_status['renovation_cost'],
                               class: 'form-control',
                               min: 0,
                               step: 0.01,
                               placeholder: '$0.00' %>
        </div>

        <div class="col-md-12 mb-3">
          <%= f.label 'current_status[renovation_notes]', 'Notas sobre remodelaciones', class: 'form-label' %>
          <%= text_area_tag 'initial_contact_form[current_status][renovation_notes]',
                            form.current_status['renovation_notes'],
                            class: 'form-control',
                            rows: 2,
                            placeholder: 'Detalles de las remodelaciones realizadas...' %>
        </div>
      </div>
    </div>





    
    <h6 class="mt-4 mb-3">Condominio</h6>
    
    <div class="mb-3">
      <div class="form-check">
        <%= check_box_tag 'initial_contact_form[current_status][is_in_condominium]',
                         '1',
                         form.current_status['is_in_condominium'],
                         class: 'form-check-input',
                         id: 'is_in_condominium_check' %>
        <%= label_tag 'is_in_condominium_check', '¬øEl inmueble est√° dentro de un condominio/fraccionamiento?', class: 'form-check-label' %>
      </div>
    </div>
    
    <div class="condominium-details" style="display: none;">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label 'current_status[condominium_regime]', 'Tipo de r√©gimen', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][condominium_regime]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['Vertical', 'vertical'],
                          ['Horizontal', 'horizontal'],
                          ['Mixto', 'mixto'],
                          ['En proceso', 'en_proceso'],
                          ['Otro', 'otro']
                        ], form.current_status['condominium_regime']),
                        id: 'initial_contact_form_current_status_condominium_regime',
                        class: 'form-select' %>
        </div>

<!-- ========================================================================== -->
<!-- AGREGAR EN .condominium-details                                            -->
<!-- UBICACI√ìN: Despu√©s del campo condominium_regime                            -->
<!-- ========================================================================== -->

        <div class="col-md-6 mb-3">
          <%= label_tag 'current_status[has_condominium_rules]', '¬øCuenta con reglamento de condominio?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][has_condominium_rules]',
                         options_for_select([
                           ['Seleccione...', ''],
                           ['S√≠', 'true'],
                           ['No', 'false'],
                           ['No sabe', 'unknown']
                         ], form.current_status['has_condominium_rules']),
                         class: 'form-select' %>
        </div>

        <div class="col-md-6 mb-3">
          <%= label_tag 'current_status[has_maintenance_clearance]', '¬øTiene constancia de no adeudo de mantenimiento?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][has_maintenance_clearance]',
                         options_for_select([
                           ['Seleccione...', ''],
                           ['S√≠', 'true'],
                           ['No', 'false'],
                           ['No sabe', 'unknown']
                         ], form.current_status['has_maintenance_clearance']),
                         class: 'form-select' %>
        </div>



      </div>
    </div>

    
    <h6 class="mt-4 mb-3">Unidades Rentables</h6>
    
    <div class="mb-3">
      <div class="form-check">
        <%= check_box_tag 'initial_contact_form[current_status][has_rental_units]',
                         '1',
                         form.current_status['has_rental_units'],
                         class: 'form-check-input',
                         id: 'has_rental_units_check' %>
        <%= label_tag 'has_rental_units_check', '¬øTiene unidades rentadas o rentables?', class: 'form-check-label' %>
      </div>
      <small class="text-muted">Por ejemplo: departamentos, locales, cuartos independientes</small>
    </div>


    <div class="rental-details" style="display: none;">
      <div class="row">
        <div class="col-md-12 mb-3">
          <div class="alert alert-info">
            <strong><i class="bi bi-building"></i> Unidades rentables:</strong> Proporciona detalles de departamentos y/o locales comerciales
          </div>
        </div>

        <!-- DEPARTAMENTOS -->
        <div class="col-md-12 mb-3">
          <h6 class="text-primary mb-3">
            <i class="bi bi-door-closed"></i> Departamentos
          </h6>
        </div>

        <div class="col-md-3 mb-3">
          <%= f.label 'current_status[apartment_units_count]', 'Cantidad de departamentos', class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[current_status][apartment_units_count]',
                              form.current_status['apartment_units_count'],
                              class: 'form-control',
                              min: 0,
                              placeholder: '0' %>
        </div>

        <div class="col-md-3 mb-3">
          <%= label_tag 'current_status[apartments_natural_light]', '¬øTienen luz natural?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][apartments_natural_light]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['S√≠', 'true'],
                          ['No', 'false'],
                          ['Algunos', 'partial']
                        ], form.current_status['apartments_natural_light']),
                        class: 'form-select' %>
        </div>

        <div class="col-md-3 mb-3">
          <%= label_tag 'current_status[apartments_access]', 'Tipo de acceso', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][apartments_access]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['Interno', 'interno'],
                          ['Externo', 'externo'],
                          ['Ambos', 'ambos']
                        ], form.current_status['apartments_access']),
                        class: 'form-select' %>
        </div>

        <div class="col-md-3 mb-3">
          <%= label_tag 'current_status[apartments_have_kitchen]', '¬øTienen cocina?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][apartments_have_kitchen]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['S√≠', 'true'],
                          ['No', 'false'],
                          ['Algunos', 'partial']
                        ], form.current_status['apartments_have_kitchen']),
                        class: 'form-select' %>
        </div>

        <div class="col-md-12 mb-3">
          <%= label_tag 'current_status[apartments_finish_type]', 'Tipo de obra', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][apartments_finish_type]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['Obra Negra', 'negra'],
                          ['Obra Gris', 'gris'],
                          ['Obra Blanca', 'blanca']
                        ], form.current_status['apartments_finish_type']),
                        class: 'form-select' %>
        </div>

        <div class="col-md-12 mb-3">
          <hr class="my-4">
        </div>

        <!-- LOCALES COMERCIALES -->
        <div class="col-md-12 mb-3">
          <h6 class="text-primary mb-3">
            <i class="bi bi-shop"></i> Locales Comerciales
          </h6>
        </div>

        <div class="col-md-3 mb-3">
          <%= f.label 'current_status[commercial_units_count]', 'Cantidad de locales', class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[current_status][commercial_units_count]',
                              form.current_status['commercial_units_count'],
                              class: 'form-control',
                              min: 0,
                              placeholder: '0' %>
        </div>

        <div class="col-md-3 mb-3">
          <%= label_tag 'current_status[commercial_access]', 'Tipo de acceso', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][commercial_access]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['Interno', 'interno'],
                          ['Externo', 'externo'],
                          ['Ambos', 'ambos']
                        ], form.current_status['commercial_access']),
                        class: 'form-select' %>
        </div>

        <div class="col-md-3 mb-3">
          <%= f.label 'current_status[commercial_shutters_count]', 'N√∫mero de cortinas', class: 'form-label' %>
          <%= number_field_tag 'initial_contact_form[current_status][commercial_shutters_count]',
                              form.current_status['commercial_shutters_count'],
                              class: 'form-control',
                              min: 0,
                              placeholder: '0' %>
        </div>

        <div class="col-md-3 mb-3">
          <%= label_tag 'current_status[commercial_modifiable]', '¬øEs modificable?', class: 'form-label' %>
          <%= select_tag 'initial_contact_form[current_status][commercial_modifiable]',
                        options_for_select([
                          ['Seleccione...', ''],
                          ['S√≠', 'true'],
                          ['No', 'false'],
                          ['Con restricciones', 'restricted']
                        ], form.current_status['commercial_modifiable']),
                        class: 'form-select' %>
        </div>

        <div class="col-md-12 mb-3">
          <hr class="my-4">
        </div>

        <!-- NOTAS GENERALES -->
        <div class="col-md-12 mb-3">
          <%= f.label 'current_status[rental_units_notes]', 'Notas sobre unidades rentables', class: 'form-label' %>
          <%= text_area_tag 'initial_contact_form[current_status][rental_units_notes]',
                            form.current_status['rental_units_notes'],
                            class: 'form-control',
                            rows: 3,
                            placeholder: 'Informaci√≥n adicional sobre las unidades rentables (distribuci√≥n, estado, inquilinos actuales, contratos, etc.)' %>
        </div>
      </div>
    </div>


    
  


  </div>
</div>
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/_section_promotion.html.erb
--------------------------------------------
```ruby
<div class="card">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0"><i class="bi bi-4-circle"></i> Preferencias de Promoci√≥n</h5>
  </div>
  <div class="card-body">
    
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>Autorizaci√≥n para promoci√≥n.</strong> Indica c√≥mo deseas promocionar la propiedad.
    </div>
    
    <h6 class="mb-3">Se√±alizaci√≥n</h6>
    
    <div class="mb-3">
      <div class="form-check">
        <%= check_box_tag 'initial_contact_form[promotion_preferences][allows_signage]',
                         '1',
                         form.promotion_preferences['allows_signage'],
                         class: 'form-check-input',
                         id: 'allows_signage_check' %>
        <%= label_tag 'allows_signage_check', '¬øAutoriza colocar lonas o carteles \"SE VENDE\"?', class: 'form-check-label' %>
      </div>
    </div>
    
    <div class="signage-details" style="<%= 'display:none;' unless form.promotion_preferences['allows_signage'] %>">
      <div class="mb-3">
        <label class="form-label">Tipo de se√±alizaci√≥n autorizada</label>
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[promotion_preferences][signage_types][]',
                           'lona',
                           form.promotion_preferences['signage_types']&.include?('lona'),
                           class: 'form-check-input' %>
          <%= label_tag 'signage_lona', 'Lona grande', class: 'form-check-label' %>
        </div>
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[promotion_preferences][signage_types][]',
                           'se_vende',
                           form.promotion_preferences['signage_types']&.include?('se_vende'),
                           class: 'form-check-input' %>
          <%= label_tag 'signage_se_vende', 'Cartel \"SE VENDE\"', class: 'form-check-label' %>
        </div>
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[promotion_preferences][signage_types][]',
                           'numero_inmueble',
                           form.promotion_preferences['signage_types']&.include?('numero_inmueble'),
                           class: 'form-check-input' %>
          <%= label_tag 'signage_numero', 'N√∫mero de inmueble', class: 'form-check-label' %>
        </div>
      </div>
    </div>
    
    <h6 class="mb-3">Volantes y Direcci√≥n</h6>
    
    <div class="mb-3">
      <div class="form-check">
        <%= check_box_tag 'initial_contact_form[promotion_preferences][allows_flyers_with_address]',
                         '1',
                         form.promotion_preferences['allows_flyers_with_address'],
                         class: 'form-check-input' %>
        <%= label_tag 'allows_flyers_address', '¬øAutoriza volantes con la direcci√≥n exacta?', class: 'form-check-label' %>
      </div>
      <small class="text-muted">Si no, se usar√° descripci√≥n general sin direcci√≥n exacta</small>
    </div>
    
    <h6 class="mb-3">Open House</h6>
    
    <div class="mb-3">
      <div class="form-check">
        <%= check_box_tag 'initial_contact_form[promotion_preferences][allows_open_house]',
                         '1',
                         form.promotion_preferences['allows_open_house'],
                         class: 'form-check-input' %>
        <%= label_tag 'allows_open_house', '¬øAutoriza organizar Open House?', class: 'form-check-label' %>
      </div>
    </div>
    
    <h6 class="mb-3">Contacto Preferido</h6>
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <%= label_tag 'promotion_preferences_preferred_contact_method', 'M√©todo de contacto preferido', class: 'form-label' %>
        <%= select_tag 'initial_contact_form[promotion_preferences][preferred_contact_method]',
                       options_for_select([
                         ['Tel√©fono', 'telefono'],
                         ['Email', 'email'],
                         ['WhatsApp', 'whatsapp'],
                         ['Indistinto', 'indistinto']
                       ], form.promotion_preferences['preferred_contact_method']),
                       class: 'form-select' %>
      </div>
      
      <div class="col-md-6 mb-3">
        <%= label_tag 'promotion_preferences_contact_hours', 'Horarios de contacto', class: 'form-label' %>
        <%= select_tag 'initial_contact_form[promotion_preferences][contact_hours]',
                       options_for_select([
                         ['Cualquier hora', 'cualquier'],
                         ['Ma√±ana (07:00-13:00)', 'manana'],
                         ['Tarde (13:00-19:00)', 'tarde'],
                         ['Noche (19:00-23:00)', 'noche'],
                         ['Fines de semana', 'fines_semana']
                       ], form.promotion_preferences['contact_hours']),
                       class: 'form-select' %>
      </div>
    </div>
    
    <h6 class="mb-3">Observaciones</h6>
    
    <div class="mb-3">
      <%= label_tag 'promotion_preferences_special_instructions', 'Instrucciones especiales', class: 'form-label' %>
      <%= text_area_tag 'initial_contact_form[promotion_preferences][special_instructions]',
                       form.promotion_preferences['special_instructions'],
                       class: 'form-control',
                       rows: 3,
                       placeholder: 'Ej: No contactar despu√©s de las 22:00, avisar antes de visitaciones...' %>
    </div>
    
    <h6 class="mb-3">Observaciones Generales del Agente</h6>
    
    <div class="mb-3">
      <%= label_tag 'agent_notes', 'Notas internas', class: 'form-label' %>
      <%= text_area_tag 'initial_contact_form[agent_notes]',
                       form.agent_notes,
                       class: 'form-control',
                       rows: 4,
                       placeholder: 'Informaci√≥n adicional relevante, puntos importantes a considerar, etc...' %>
    </div>
  </div>
</div>

```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/_section_tax_exemption.html.erb
--------------------------------------------
```ruby

<div class="card">
  <div class="card-header bg-danger text-white">
    <h5 class="mb-0"><i class="bi bi-3-circle"></i> Exenci√≥n de Impuesto sobre la Renta (ISR)</h5>
  </div>
  <div class="card-body">
    
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>Informaci√≥n fiscal importante.</strong> Completa estos campos para determinar si la venta puede calificar para exenci√≥n de ISR.
    </div>
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[tax_exemption][first_home_sale]',
                           '1',
                           form.tax_exemption['first_home_sale'],
                           class: 'form-check-input' %>
          <%= label_tag 'first_home_sale', '¬øEs la primera venta de inmueble del vendedor?', class: 'form-check-label' %>
        </div>
      </div>
      
      <div class="col-md-6 mb-3">
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[tax_exemption][lived_last_5_years]',
                           '1',
                           form.tax_exemption['lived_last_5_years'],
                           class: 'form-check-input' %>
          <%= label_tag 'lived_last_5_years', '¬øHa vivido en la propiedad los √∫ltimos 5 a√±os?', class: 'form-check-label' %>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[tax_exemption][ine_matches_deed]',
                           '1',
                           form.tax_exemption['ine_matches_deed'],
                           class: 'form-check-input' %>
          <%= label_tag 'ine_matches_deed', '¬øEl domicilio en INE coincide con la escritura?', class: 'form-check-label' %>
        </div>
      </div>
      
      <div class="col-md-6 mb-3">
        <div class="form-check">
          <%= check_box_tag 'initial_contact_form[tax_exemption][previous_sales_last_3_years]',
                           '1',
                           form.tax_exemption['previous_sales_last_3_years'],
                           class: 'form-check-input',
                           id: 'previous_sales_check' %>
          <%= label_tag 'previous_sales_check', '¬øHa vendido otro inmueble en los √∫ltimos 3 a√±os?', class: 'form-check-label' %>
        </div>
      </div>
    </div>
    
    <div class="previous-sale-details" style="<%= 'display:none;' unless form.tax_exemption['previous_sales_last_3_years'] %>">
      <div class="mb-3">
        <%= label_tag 'tax_exemption_previous_sale_date', 'Fecha de venta anterior', class: 'form-label' %>
        <%= date_field_tag 'initial_contact_form[tax_exemption][previous_sale_date]',
                          form.tax_exemption['previous_sale_date'],
                          class: 'form-control' %>
      </div>
    </div>
    
    <div class="mb-3">
      <% label_tag 'tax_exemption_estimated_capital_gain', 'Ganancia de capital estimada (MXN)', class: 'form-label' %>
      <% number_field_tag 'initial_contact_form[tax_exemption][estimated_capital_gain]',
                          form.tax_exemption['estimated_capital_gain'],
                          class: 'form-control',
                          step: '0.01',
                          min: '0' %>
      <%# <small class="text-muted">(Precio de venta - Precio de compra)</small> %>
    </div>
    
    <%# <div class="alert alert-success mt-3"> %>
      <%# <strong>Resultado:</strong> %>
      <%# <% if form.qualifies_for_tax_exemption? %> 
        <%# ‚úÖ <strong>Podr√≠a calificar para exenci√≥n ISR</strong> %>
      <%# <% else %> 
        <%# ‚ö†Ô∏è <strong>Probablemente NO califica para exenci√≥n</strong> - Requiere asesor√≠a fiscal %>
      <%# <% end %>
    <%# </div> %>
  </div>
</div>

```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/edit.html.erb
--------------------------------------------
```ruby
<!-- app/views/initial_contact_forms/edit.html.erb -->
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-clipboard-check"></i>
      Editar Formulario de Contacto Inicial
    </h2>
    <%= link_to initial_contact_forms_path, class: 'btn btn-secondary' do %>
      <i class="bi bi-arrow-left"></i> Volver
    <% end %>
  </div>

  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>Informaci√≥n:</strong> Edita este formulario con los datos del contacto inicial con el vendedor.
    Puedes guardar como borrador y completarlo despu√©s. Una vez completado, podr√°s convertirlo en una transacci√≥n.
  </div>

  <%= render 'form', form: @initial_contact_form %>

  <script>
  document.addEventListener('turbo:submit-start', function(e) {
    const coOwnersField = document.querySelector('[name="initial_contact_form[acquisition_details][co_owners_count]"]');
    console.log('üî¥ TURBO SUBMIT START - co_owners_count:', coOwnersField.value);
  });

  document.addEventListener('turbo:before-cache', function(e) {
    const coOwnersField = document.querySelector('[name="initial_contact_form[acquisition_details][co_owners_count]"]');
    console.log('üü° TURBO BEFORE CACHE - co_owners_count:', coOwnersField.value);
  });
  </script>

</div>```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/edit_client_modal.html.erb
--------------------------------------------
```ruby
<div class="offcanvas offcanvas-end" tabindex="-1" id="clientOffcanvas" aria-labelledby="clientOffcanvasLabel" data-controller="client-offcanvas">
  <div class="offcanvas-header bg-success text-white">
    <h5 class="offcanvas-title" id="clientOffcanvasLabel">
      <i class="bi bi-person-fill"></i> Editar Datos del Cliente/Propietario
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body p-4">
    <form id="clientForm" class="needs-validation">
      
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i>
        <strong>Nota:</strong> Esta informaci√≥n identifica al propietario/cliente.
        El Opportunity ID se genera con su apellido + fecha.
      </div>

      <!-- NOMBRE COMPLETO -->
      <div class="mb-3">
        <label class="form-label fw-bold">Nombre Completo del Propietario *</label>
        <input type="text"
               id="ownerName"
               class="form-control form-control-lg"
               placeholder="Juan P√©rez Garc√≠a"
               value="<%= @general_conditions['owner_or_representative_name'] %>"
               required>
        <small class="text-muted">Formato: Nombre Apellido1 Apellido2</small>
      </div>

      <!-- TEL√âFONO Y EMAIL -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Tel√©fono de Contacto</label>
          <input type="tel"
                 id="ownerPhone"
                 class="form-control"
                 placeholder="(55) 1234-5678"
                 value="<%= @general_conditions['owner_phone'] %>">
        </div>

        <div class="col-md-6">
          <label class="form-label">Email de Contacto</label>
          <input type="email"
                 id="ownerEmail"
                 class="form-control"
                 placeholder="cliente@email.com"
                 value="<%= @general_conditions['owner_email'] %>">
        </div>
      </div>

      <!-- ESTADO CIVIL -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Estado Civil *</label>
          <select id="civilStatusField"
                  class="form-select"
                  required>
            <option value="">Selecciona...</option>
            <% CivilStatus.active.order(:sort_order).each do |status| %>
              <option value="<%= status.name %>"
                      <%= 'selected' if @general_conditions['civil_status'] == status.name %>>
                <%= status.display_name %>
              </option>
            <% end %>
          </select>
        </div>

        <!-- R√âGIMEN MATRIMONIAL (condicional) -->
        <div class="col-md-6" id="marriageRegimeField"
             style="display: <%= @general_conditions['civil_status'] == 'casado' ? 'block' : 'none' %>;">
          <label class="form-label">R√©gimen Matrimonial</label>
          <select id="marriageRegimeSelect"
                  class="form-select">
            <option value="">Selecciona...</option>
            <% MarriageRegime.active.ordered.each do |regime| %>
              <option value="<%= regime.id %>"
                      <%= 'selected' if @general_conditions['marriage_regime_id'].to_i == regime.id %>>
                <%= regime.display_name %>
              </option>
            <% end %>
          </select>
        </div>
      </div>

      <!-- NOTAS -->
      <div class="mb-3">
        <label class="form-label">Observaciones Adicionales</label>
        <textarea id="clientNotes"
                  class="form-control"
                  rows="3"
                  placeholder="Informaci√≥n adicional relevante..."><%= @general_conditions['notes'] %></textarea>
      </div>

      <!-- PREVIEW DE OPPORTUNITY ID -->
      <div class="alert alert-success mt-4">
        <strong>üè∑Ô∏è Identificador de Oportunidad (autom√°tico):</strong>
        <div class="font-monospace mt-2 fs-6" id="opportunityPreview">
          <% name_parts = @general_conditions['owner_or_representative_name'].to_s.split(/\s+/) %>
          <% last_name = name_parts.length >= 2 ? name_parts : name_parts %>
          <% last_name_clean = last_name.to_s.upcase.slice(0, 10) %>
          V-<%= last_name_clean %>-<%= Date.current.strftime('%Y%m%d') %>-001
        </div>
        <small class="text-muted mt-2 d-block">
          Este ID es temporal y cambia si el propietario o la fecha cambian
        </small>
      </div>

      <!-- BOTONES -->
      <div class="d-flex gap-2 mt-4 pt-3 border-top">
        <button type="button" class="btn btn-secondary flex-grow-1" data-bs-dismiss="offcanvas">
          Cancelar
        </button>
        <button type="button" class="btn btn-success flex-grow-1" id="saveClientBtn">
          <i class="bi bi-check-lg"></i> Guardar Cliente
        </button>
      </div>
    </form>
  </div>
</div>
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/edit_client_modal.turbo_stream.erb
--------------------------------------------
```ruby
<turbo-stream action="update" target="modal">
  <template>
    <div class="modal modal-lg" id="clientModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="bi bi-person-fill"></i> Editar Datos del Cliente/Propietario
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          
          <form action="<%= update_client_from_modal_initial_contact_form_path(@form) %>" 
                method="POST"
                class="needs-validation"
                id="clientForm">
            
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            
            <div class="modal-body">
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                <strong>Nota:</strong> Esta informaci√≥n identifica al propietario/cliente.
                El Opportunity ID se genera con su apellido + fecha.
              </div>
              
              <!-- NOMBRE COMPLETO -->
              <div class="mb-3">
                <label class="form-label fw-bold">Nombre Completo del Propietario *</label>
                <input type="text" 
                       name="general_conditions[owner_or_representative_name]" 
                       class="form-control form-control-lg" 
                       placeholder="Juan P√©rez Garc√≠a"
                       value="<%= @general_conditions['owner_or_representative_name'] %>"
                       required>
                <small class="text-muted">Formato: Nombre Apellido1 Apellido2</small>
              </div>
              




              <!-- TEL√âFONO Y EMAIL -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Tel√©fono de Contacto</label>
                  <input type="tel" 
                         name="general_conditions[owner_phone]" 
                         class="form-control" 
                         placeholder="(55) 1234-5678"
                         value="<%= @general_conditions['owner_phone'] %>">
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">Email de Contacto</label>
                  <input type="email" 
                         name="general_conditions[owner_email]" 
                         class="form-control" 
                         placeholder="cliente@email.com"
                         value="<%= @general_conditions['owner_email'] %>">
                </div>
              </div>
              
              <!-- ESTADO CIVIL -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Estado Civil *</label>
                  <select name="general_conditions[civil_status]" 
                          class="form-select"
                          id="civilStatusField"
                          required>
                    <option value="">Selecciona...</option>
                    <% CivilStatus.active.order(:sort_order).each do |status| %>
                      <option value="<%= status.name %>" 
                              <%= 'selected' if @general_conditions['civil_status'] == status.name %>>
                        <%= status.display_name %>
                      </option>
                    <% end %>
                  </select>
                </div>
                
                <!-- R√âGIMEN MATRIMONIAL (condicional) -->
                <div class="col-md-6" id="marriageRegimeField" 
                     style="display: <%= @general_conditions['civil_status'] == 'casado' ? 'block' : 'none' %>;">
                  <label class="form-label">R√©gimen Matrimonial</label>
                  <select name="general_conditions[marriage_regime_id]" 
                          class="form-select">
                    <option value="">Selecciona...</option>
                    <% MarriageRegime.active.ordered.each do |regime| %>
                      <option value="<%= regime.id %>" 
                              <%= 'selected' if @general_conditions['marriage_regime_id'].to_i == regime.id %>>
                        <%= regime.display_name %>
                      </option>
                    <% end %>
                  </select>
                </div>
              </div>
              
              <!-- NOTAS -->
              <div class="mb-3">
                <label class="form-label">Observaciones Adicionales</label>
                <textarea name="general_conditions[notes]" 
                          class="form-control" 
                          rows="3"
                          placeholder="Informaci√≥n adicional relevante..."><%= @general_conditions['notes'] %></textarea>
              </div>
              
              <!-- PREVIEW DE OPPORTUNITY ID -->
              <div class="alert alert-success mt-4">
                <strong>üè∑Ô∏è Identificador de Oportunidad (autom√°tico):</strong>
                <div class="font-monospace mt-2 fs-5">
                  <% name_parts = @general_conditions['owner_or_representative_name'].to_s.split(/\s+/) %>
                  <% last_name = name_parts.length >= 2 ? name_parts[1] : name_parts[0] %>
                  <% last_name_clean = last_name.to_s.upcase.slice(0, 10) %>
                  V-<%= last_name_clean %>-<%= Date.current.strftime('%Y%m%d') %>-001
                </div>
                <small class="text-muted mt-2 d-block">
                  Este ID es temporal y cambia si el propietario o la fecha cambian
                </small>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check-lg"></i> Guardar Cliente
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <script>
      document.addEventListener('turbo:load', function() {
        const modal = new bootstrap.Modal(document.getElementById('clientModal'), {
          backdrop: 'static',
          keyboard: false
        });
        modal.show();
        
        // Mostrar/ocultar r√©gimen matrimonial seg√∫n estado civil
        const civilStatusField = document.getElementById('civilStatusField');
        const marriageRegimeField = document.getElementById('marriageRegimeField');
        
        if (civilStatusField) {
          civilStatusField.addEventListener('change', function() {
            marriageRegimeField.style.display = this.value === 'casado' ? 'block' : 'none';
          });
        }
        
        document.getElementById('clientModal').addEventListener('hidden.bs.modal', function() {
          Turbo.visit(location);
        });
      });
    </script>
  </template>
</turbo-stream>

```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/edit_co_owners_modal.turbo_stream.erb
--------------------------------------------
```ruby
<turbo-stream action="update" target="modal">
  <template>
    <div class="modal modal-xl" id="coOwnersModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">
              <i class="bi bi-people-fill"></i> Gestionar Copropietarios
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i> 
              <strong>Importante:</strong> Este formulario tiene <strong><%= @co_owners_count %></strong> copropietarios.
              <br>
              Cada copropietario es un CLIENTE tambi√©n y necesita:
              <ul class="mb-0 mt-2">
                <li>Datos personales completos (nombre, tel√©fono, email)</li>
                <li>Porcentaje de propiedad</li>
                <li>Identificador de Oportunidad (autom√°tico: CP-APELLIDO-FECHA)</li>
              </ul>
            </div>
            
            <!-- TABS PARA CADA COPROPIETARIO -->
            <ul class="nav nav-tabs mb-4" id="coOwnersTabs" role="tablist">
              <% (1..@co_owners_count).each do |index| %>
                <li class="nav-item" role="presentation">
                  <button class="nav-link <%= 'active' if index == 1 %>" 
                          id="coowner-<%= index %>-tab" 
                          data-bs-toggle="tab" 
                          data-bs-target="#coowner-<%= index %>" 
                          type="button">
                    Copropietario <%= index %>
                  </button>
                </li>
              <% end %>
            </ul>
            
            <div class="tab-content" id="coOwnersContent">
              <% (1..@co_owners_count).each do |index| %>
                <div class="tab-pane fade <%= 'show active' if index == 1 %>" 
                     id="coowner-<%= index %>" 
                     role="tabpanel">
                  
                  <form action="<%= create_co_owner_initial_contact_form_path(@form) %>" 
                        method="POST"
                        class="coowner-form"
                        data-coowner-index="<%= index %>">
                    
                    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                    <%= hidden_field_tag :initial_contact_form_id, @form.id %>
                    <%= hidden_field_tag :coowner_index, index %>
                    
                    <div class="alert alert-info mb-4">
                      <strong>Copropietario <%= index %> de <%= @co_owners_count %></strong>
                      <br>
                      <small>Introduce los datos de este copropietario. El identificador se generar√° autom√°ticamente.</small>
                    </div>
                    
                    <!-- NOMBRE -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">Nombre Completo *</label>
                      <input type="text" 
                             name="co_owner_name" 
                             class="form-control" 
                             placeholder="Ej: Mar√≠a Garc√≠a L√≥pez"
                             required>
                    </div>
                    
                    <!-- TEL√âFONO Y EMAIL -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Tel√©fono</label>
                        <input type="tel" 
                               name="co_owner_phone" 
                               class="form-control" 
                               placeholder="(55) 1234-5678">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" 
                               name="co_owner_email" 
                               class="form-control" 
                               placeholder="cliente@email.com">
                      </div>
                    </div>
                    
                    <!-- PORCENTAJE DE PROPIEDAD -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Porcentaje de Propiedad (%) *</label>
                        <div class="input-group">
                          <input type="number" 
                                 name="ownership_percentage" 
                                 class="form-control" 
                                 min="0.01" 
                                 max="100" 
                                 step="0.01"
                                 placeholder="50.00"
                                 required>
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Debe sumar 100% entre todos los copropietarios</small>
                      </div>
                      
                      <div class="col-md-6">
                        <label class="form-label">Relaci√≥n/Parentesco</label>
                        <select name="relationship_type" class="form-select">
                          <option value="">Selecciona...</option>
                          <% RelationshipType.active.where(category: 'copropietario').ordered.each do |rel| %>
                            <option value="<%= rel.name %>"><%= rel.display_name %></option>
                          <% end %>
                        </select>
                      </div>
                    </div>
                    
                    <!-- UBICACI√ìN -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Direcci√≥n</label>
                        <input type="text" 
                               name="co_owner_address" 
                               class="form-control" 
                               placeholder="Calle Principal 123">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Ciudad</label>
                        <input type="text" 
                               name="co_owner_city" 
                               class="form-control" 
                               placeholder="Ciudad de M√©xico">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <select name="co_owner_state" class="form-select">
                          <option value="">Selecciona...</option>
                          <% MexicanState.active.order(:sort_order).each do |state| %>
                            <option value="<%= state.name %>"><%= state.name %></option>
                          <% end %>
                        </select>
                      </div>
                    </div>
                    
                    <!-- NOTAS -->
                    <div class="mb-3">
                      <label class="form-label">Notas Adicionales</label>
                      <textarea name="notes" 
                                class="form-control" 
                                rows="2"
                                placeholder="Informaci√≥n adicional de este copropietario..."></textarea>
                    </div>
                    
                    <!-- PREVIEW OPPORTUNITY ID -->
                    <div class="alert alert-success">
                      <strong>üë• Identificador de Oportunidad Copropietario:</strong>
                      <div class="font-monospace mt-2">
                        CP-[APELLIDO]-<%= Date.current.strftime('%Y%m%d') %>-<%= (index.to_s.rjust(3, '0')) %>
                      </div>
                      <small class="text-muted d-block mt-2">
                        Este ID identifica ESTA RELACI√ìN de copropiedad espec√≠fica
                      </small>
                    </div>
                    
                    <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-warning">
                        <i class="bi bi-plus-lg"></i> Guardar Copropietario <%= index %>
                      </button>
                    </div>
                  </form>
                </div>
              <% end %>
            </div>
          </div>
          
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <small class="text-muted">
              Completa los datos de todos los copropietarios para poder generar los documentos necesarios
            </small>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      document.addEventListener('turbo:load', function() {
        const modal = new bootstrap.Modal(document.getElementById('coOwnersModal'), {
          backdrop: 'static'
        });
        modal.show();
        
        // Manejar env√≠o de formularios
        document.querySelectorAll('.coowner-form').forEach(form => {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            fetch(this.action, {
              method: 'POST',
              headers: {
                'X-CSRF-Token': document.querySelector('[name=authenticity_token]').value,
                'Accept': 'text/vnd.turbo-stream.html, text/html, application/xhtml+xml'
              },
              body: formData
            })
            .then(response => response.text())
            .then(html => {
              if (html.includes('turbo-stream')) {
                Turbo.renderStreamMessage(html);
              }
              this.reset();
            });
          });
        });
        
        document.getElementById('coOwnersModal').addEventListener('hidden.bs.modal', function() {
          Turbo.visit(location);
        });
      });
    </script>
  </template>
</turbo-stream>

```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/edit_property_modal.turbo_stream.erb
--------------------------------------------
```ruby
<turbo-stream action="update" target="modal">
  <template>
    <div class="modal modal-lg" id="propertyModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-house-fill"></i> Editar Datos de Propiedad
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          
          <form action="<%= update_property_from_modal_initial_contact_form_path(@form) %>" 
                method="POST"
                class="needs-validation"
                id="propertyForm">
            
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            
            <div class="modal-body">
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                <strong>Importante:</strong> La direcci√≥n se usa para generar el Property ID √∫nico 
                que identifica esta propiedad geogr√°ficamente de forma permanente.
              </div>
              
              <!-- CALLE Y N√öMERO -->
              <div class="row mb-3">
                <div class="col-md-8">
                  <label class="form-label fw-bold">Calle/Avenida *</label>
                  <input type="text" 
                         name="property_info[street]" 
                         class="form-control" 
                         placeholder="Ej: Av. Insurgentes Sur"
                         value="<%= @street %>"
                         required>
                  <small class="text-muted">Nombre completo de la calle o avenida</small>
                </div>
                
                <div class="col-md-4">
                  <label class="form-label fw-bold">N√∫mero Exterior *</label>
                  <input type="text" 
                         name="property_info[exterior_number]" 
                         class="form-control" 
                         placeholder="1500"
                         value="<%= @exterior_number %>"
                         required>
                </div>
              </div>
              
              <!-- INTERIOR, COLONIA, POSTAL -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">N√∫mero Interior</label>
                  <input type="text" 
                         name="property_info[interior_number]" 
                         class="form-control" 
                         placeholder="Ej: 301, Depto A"
                         value="<%= @interior_number %>">
                  <small class="text-muted">Opcional</small>
                </div>
                
                <div class="col-md-4">
                  <label class="form-label fw-bold">Colonia/Barrio *</label>
                  <input type="text" 
                         name="property_info[neighborhood]" 
                         class="form-control" 
                         placeholder="Del Valle"
                         value="<%= @neighborhood %>"
                         required>
                </div>
                
                <div class="col-md-4">
                  <label class="form-label fw-bold">C√≥digo Postal *</label>
                  <input type="text" 
                         name="property_info[postal_code]" 
                         class="form-control" 
                         placeholder="03100"
                         value="<%= @postal_code %>"
                         pattern="[0-9]{5}"
                         maxlength="5"
                         required>
                </div>
              </div>
              
              <!-- MUNICIPIO Y CIUDAD -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Municipio/Alcald√≠a *</label>
                  <input type="text" 
                         name="property_info[municipality]" 
                         class="form-control" 
                         placeholder="Benito Ju√°rez"
                         value="<%= @municipality %>"
                         required>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label fw-bold">Ciudad *</label>
                  <input type="text" 
                         name="property_info[city]" 
                         class="form-control" 
                         placeholder="Ciudad de M√©xico"
                         value="<%= @city %>"
                         required>
                </div>
              </div>
              
              <!-- ESTADO Y USO DE SUELO -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Estado *</label>
                  <select name="acquisition_details[state]" 
                          class="form-select"
                          required>
                    <option value="">Selecciona un estado...</option>
                    <% MexicanState.active.order(:sort_order).each do |state| %>
                      <option value="<%= state.name %>" 
                              <%= 'selected' if @state == state.name %>>
                        <%= state.name %>
                      </option>
                    <% end %>
                  </select>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label fw-bold">Uso de Suelo *</label>
                  <select name="acquisition_details[land_use]" 
                          class="form-select"
                          required>
                    <option value="">Selecciona uso de suelo...</option>
                    <% LandUseType.active.order(:sort_order).each do |land_use| %>
                      <option value="<%= land_use.code %>" 
                              <%= 'selected' if @land_use == land_use.code %>>
                        <%= land_use.name %>
                      </option>
                    <% end %>
                  </select>
                </div>
              </div>
              
              <!-- PREVIEW DE PROPERTY ID -->
              <div class="alert alert-success mt-4">
                <strong>üó∫Ô∏è Identificador de Propiedad (autom√°tico):</strong>
                <div class="font-monospace mt-2 fs-5">
                  <% street_norm = @street.to_s.downcase.gsub(/[^a-z0-9]/, '').slice(0, 15) %>
                  <% ext_norm = @exterior_number.to_s.gsub(/[^a-z0-9]/, '').upcase.slice(0, 6) %>
                  <% municipality_norm = @municipality.to_s.downcase.gsub(/[^a-z0-9]/, '').slice(0, 8) %>
                  <%= "#{street_norm.upcase}-#{ext_norm}-#{municipality_norm.upcase}-..." %>
                </div>
                <small class="text-muted mt-2 d-block">
                  Este ID es permanente y no cambia aunque cambien clientes o propietarios
                </small>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Guardar Propiedad
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <script>
      document.addEventListener('turbo:load', function() {
        const modal = new bootstrap.Modal(document.getElementById('propertyModal'), {
          backdrop: 'static',
          keyboard: false
        });
        modal.show();
        
        document.getElementById('propertyModal').addEventListener('hidden.bs.modal', function() {
          Turbo.visit(location);
        });
      });
    </script>
  </template>
</turbo-stream>
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/index.html.erb
--------------------------------------------
```ruby
<!-- app/views/initial_contact_forms/index.html.erb -->
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-clipboard-check"></i>
      Formularios de Contacto Inicial
    </h2>
    <%= link_to new_initial_contact_form_path, class: 'btn btn-primary' do %>
      <i class="bi bi-plus-circle"></i> Nuevo Formulario
    <% end %>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SECCI√ìN DE FILTROS MEJORADA - REEMPLAZA TU CARD ACTUAL DE FILTROS -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-funnel"></i> Filtros de B√∫squeda
      </h5>
    </div>
    <div class="card-body">
      <%= form_with url: initial_contact_forms_path, method: :get, local: true do |f| %>
        <div class="row g-3">
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- FILA 1: Filtros principales -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          
          <!-- Filtro por Agente (solo para admin/superadmin) -->
          <% if current_user.superadmin? || current_user.admin? %>
            <div class="col-md-3">
              <%= label_tag :agent_id, "üë§ Agente", class: "form-label" %>
              <%= select_tag :agent_id, 
                  options_from_collection_for_select(
                    @agents || [], 
                    :id, 
                    ->(a) { a.user.name }, 
                    params[:agent_id]
                  ),
                  include_blank: "Todos los agentes",
                  class: "form-select" %>
            </div>
          <% end %>
          
          <!-- Filtro por Estado -->
          <div class="col-md-3">
            <%= label_tag :status, "üìä Estado", class: "form-label" %>
            <%= select_tag :status, 
                options_for_select([
                  ["Borrador", "draft"],
                  ["Completado", "completed"],
                  ["Convertido", "converted"],
                  ["Archivado", "archived"]
                ], params[:status]),
                include_blank: "Todos los estados",
                class: "form-select" %>
          </div>
          
          <!-- Filtro por M√©todo de Adquisici√≥n -->
          <div class="col-md-3">
            <%= label_tag :acquisition_method_id, "üìã M√©todo de Adquisici√≥n", class: "form-label" %>
            <%= select_tag :acquisition_method_id,
                options_from_collection_for_select(
                  @acquisition_methods || [], 
                  :id, 
                  :name, 
                  params[:acquisition_method_id]
                ),
                include_blank: "Todos los m√©todos",
                class: "form-select" %>
          </div>
          
          <!-- Filtro por Tipo de Operaci√≥n -->
          <div class="col-md-3">
            <%= label_tag :operation_type_id, "üè† Tipo de Operaci√≥n", class: "form-label" %>
            <%= select_tag :operation_type_id,
                options_from_collection_for_select(
                  @operation_types || [], 
                  :id, 
                  :name, 
                  params[:operation_type_id]
                ),
                include_blank: "Todos los tipos",
                class: "form-select" %>
          </div>
          
        </div>
        
        <div class="row g-3 mt-2">
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- FILA 2: B√∫squedas de texto -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          
          <!-- B√∫squeda por Nombre de Propietario -->
          <div class="col-md-4">
            <%= label_tag :owner_name, "üîç Nombre del Propietario", class: "form-label" %>
            <%= text_field_tag :owner_name, 
                params[:owner_name], 
                placeholder: "Buscar por nombre...",
                class: "form-control" %>
          </div>
          
          <!-- B√∫squeda por Identificador -->
          <div class="col-md-4">
            <%= label_tag :property_identifier, "üè∑Ô∏è Identificador de Propiedad", class: "form-label" %>
            <%= text_field_tag :property_identifier, 
                params[:property_identifier],
                placeholder: "Ej: Venta-Casa-Garcia",
                class: "form-control" %>
          </div>
          
          <!-- Rango de Fechas (opcional) -->
          <div class="col-md-4">
            <%= label_tag :period, "üìÖ Periodo", class: "form-label" %>
            <%= select_tag :period, 
                options_for_select([
                  ["Hoy", "today"],
                  ["Esta semana", "week"],
                  ["Este mes", "month"],
                  ["√öltimos 3 meses", "quarter"],
                  ["Este a√±o", "year"]
                ], params[:period]),
                include_blank: "Todo el tiempo",
                class: "form-select" %>
          </div>
          
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- BOTONES DE ACCI√ìN -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        
        <div class="row mt-3">
          <div class="col-12 d-flex justify-content-end gap-2">
            <%= link_to initial_contact_forms_path, class: "btn btn-outline-secondary" do %>
              <i class="bi bi-arrow-clockwise"></i> Limpiar Filtros
            <% end %>
            <%= submit_tag "üîç Buscar", class: "btn btn-primary" %>
          </div>
        </div>
        
      <% end %>
    </div>
  </div>
  
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- FIN DE SECCI√ìN DE FILTROS MEJORADA -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- Contador de resultados -->
  <% if params.slice(:status, :agent_id, :acquisition_method_id, :operation_type_id, :owner_name, :property_identifier, :period).values.any?(&:present?) %>
    <div class="alert alert-info mb-3">
      <i class="bi bi-info-circle"></i>
      Mostrando <strong><%= @forms.total_count %></strong> resultados con los filtros aplicados
      <%= link_to "Ver todos", initial_contact_forms_path, class: "ms-2 text-decoration-none" %>
    </div>
  <% end %>

  <!-- Estad√≠sticas r√°pidas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">Borradores</h5>
          <h2><%= @forms.where(status: :draft).count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <h5 class="card-title">Pendientes</h5>
          <h2><%= @forms.where(status: :completed, business_transaction_id: nil).count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">Convertidos</h5>
          <h2><%= @forms.where(status: :converted).count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">Este mes</h5>
          <h2><%= @forms.this_month.count %></h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de formularios -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Identificador</th>
              <th>Fecha</th>
              <th>Propietario</th>
              <th>Tel√©fono</th>
              <th>M√©todo</th>
              <th>Estado</th>
              <th>Progreso</th>
              <th>Agente</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @forms.each do |form| %>
              <tr>
                <td>
                  <strong><%= form.initial_contact_folio || "##{form.id}" %></strong>
                </td>
                <td>
                  <small class="text-primary">
                    <%= form.opportunity_identifier || content_tag(:em, 'Sin identificador', class: 'text-muted') %>
                  </small>
                </td>
                <td><%= l(form.created_at, format: :short) %></td>
                <td>
                  <%= form.general_conditions['owner_or_representative_name'] || 
                      content_tag(:em, 'Sin nombre', class: 'text-muted') %>
                </td>
                <td>
                  <%= form.general_conditions['owner_phone'] || 
                      content_tag(:em, 'Sin tel√©fono', class: 'text-muted') %>
                </td>
                <td>
                  <% if form.property_acquisition_method.present? %>
                    <span class="badge bg-info">
                      <%= form.property_acquisition_method.name %>
                    </span>
                  <% else %>
                    <span class="badge bg-secondary">N/A</span>
                  <% end %>
                </td>
                <td>
                  <% 
                    badge_class = case form.status
                    when 'draft' then 'bg-secondary'
                    when 'completed' then 'bg-warning'
                    when 'converted' then 'bg-success'
                    else 'bg-light'
                    end
                  %>
                  <span class="badge <%= badge_class %>">
                    <%= form.status.humanize %>
                  </span>
                </td>
                <td>
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar" 
                         role="progressbar" 
                         style="width: <%= form.completion_percentage %>%">
                      <%= form.completion_percentage %>%
                    </div>
                  </div>
                </td>
                <td>
                  <small class="text-muted">
                    <%= form.agent.user.name rescue form.agent.email %>
                  </small>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <%= link_to form, class: 'btn btn-outline-primary', title: 'Ver' do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                    
                    <% unless form.converted? %>
                      <%= link_to edit_initial_contact_form_path(form), 
                                  class: 'btn btn-outline-secondary', 
                                  title: 'Editar' do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      
                      <% if form.completed? && !form.business_transaction.present? %>
                        <%= button_to convert_to_transaction_initial_contact_form_path(form),
                                      method: :post,
                                      class: 'btn btn-outline-success',
                                      title: 'Convertir',
                                      data: { confirm: '¬øConvertir a transacci√≥n?' } do %>
                          <i class="bi bi-arrow-right-circle"></i>
                        <% end %>
                      <% end %>
                    <% else %>
                      <%= link_to business_transaction_path(form.business_transaction),
                                  class: 'btn btn-outline-success',
                                  title: 'Ver transacci√≥n' do %>
                        <i class="bi bi-check-circle"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        
        <% if @forms.empty? %>
          <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3">No hay formularios que coincidan con los filtros</p>
            <%= link_to 'Limpiar filtros', initial_contact_forms_path, class: 'btn btn-secondary me-2' %>
            <%= link_to 'Crear nuevo formulario', new_initial_contact_form_path, class: 'btn btn-primary' %>
          </div>
        <% end %>
      </div>
      
      <!-- Paginaci√≥n -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div class="text-muted">
          P√°gina <%= @forms.current_page %> de <%= @forms.total_pages %> 
          (<%= @forms.total_count %> total)
        </div>
        <%= paginate @forms %>
      </div>
    </div>
  </div>
</div>

```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/new.html.erb
--------------------------------------------
```ruby
<!-- app/views/initial_contact_forms/new.html.erb -->
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-clipboard-plus"></i>
      Nuevo Formulario de Contacto Inicial
    </h2>
    <%= link_to initial_contact_forms_path, class: 'btn btn-secondary' do %>
      <i class="bi bi-arrow-left"></i> Volver
    <% end %>
  </div>

  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>Informaci√≥n:</strong> Llena este formulario con los datos del contacto inicial con el vendedor.
    Puedes guardar como borrador y completarlo despu√©s. Una vez completado, podr√°s convertirlo en una transacci√≥n.
  </div>

  <%= render 'form', form: @initial_contact_form %>
</div>
```
--------------------------------------------
Archivo:  app/views/initial_contact_forms/show.html.erb
--------------------------------------------
```ruby
 <!-- app/views/initial_contact_forms/show.html.erb -->

<% if flash[:notice] %>
  <div class="alert alert-<%= flash[:notice].include?('‚ö†Ô∏è') ? 'warning' : 'success' %> alert-dismissible fade show" role="alert">
    <%= flash[:notice].html_safe %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% end %>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="bi bi-clipboard-check"></i>
        <%= @form.opportunity_identifier || "Formulario de Contacto Inicial ##{@form.id}" %>
      </h2>
      <p class="text-muted mb-0">
        <strong>Folio:</strong> <%= @form.initial_contact_folio || "Sin folio" %> |
        <strong>Agente:</strong> <%= @form.agent && @form.agent.user ? @form.agent.user.name : "No asignado" %> |
        <strong>Estado:</strong> <span class="badge <%= status_badge_class(@form.status) %>"><%= @form.status.humanize %></span>
        <% if @form.completed_at %>
          | <strong>Completado:</strong> <%= l(@form.completed_at, format: :short) %>
        <% end %>
      </p>
    </div>


    
    <!-- Botones de acci√≥n (mant√©n los que ya ten√≠as) -->
    <div class="btn-group">
      <%= link_to 'Editar', edit_initial_contact_form_path(@form), class: 'btn btn-primary' unless @form.converted? %>
      <%= link_to 'Volver', initial_contact_forms_path, class: 'btn btn-secondary' %>
      
      <% if @form.completed? && !@form.business_transaction.present? %>
        <%= button_to 'Convertir a Transacci√≥n',
                      convert_to_transaction_initial_contact_form_path(@form),
                      method: :post,
                      class: 'btn btn-success',
                      data: { confirm: '¬øConvertir este formulario a una transacci√≥n de negocio?' } %>
      <% end %>
    </div>
  </div>
   
    <div>
      <% unless @form.converted? %>
        <%= link_to 'Editar', edit_initial_contact_form_path(@form), 
                    class: 'btn btn-primary' %>
        
        <% if @form.completed? %>
          <%= button_to 'Convertir a Transacci√≥n', 
                        convert_to_transaction_initial_contact_form_path(@form),
                        method: :post,
                        class: 'btn btn-success',
                        data: { confirm: '¬øConvertir este formulario a una transacci√≥n?' } %>
        <% end %>
      <% end %>
      
      <%= link_to 'Volver', initial_contact_forms_path, class: 'btn btn-secondary' %>
    </div>
  </div>
  
  <!-- Progreso -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>Progreso: <%= @form.completion_percentage %>%</h5>
      <div class="progress">
        <div class="progress-bar" style="width: <%= @form.completion_percentage %>%"></div>
      </div>
    </div>
  </div>
  
  <!-- Datos generales -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Informaci√≥n General</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-6">Agente:</dt>
            <dd class="col-sm-6"><%= @form.agent.email %></dd>
            
            <dt class="col-sm-6">Creado:</dt>
            <dd class="col-sm-6"><%= l(@form.created_at, format: :short) %></dd>
            
            <dt class="col-sm-6">Completado:</dt>
            <dd class="col-sm-6">
              <%= @form.completed_at ? l(@form.completed_at, format: :short) : 'Pendiente' %>
            </dd>
            
            <% if @form.converted? %>
              <dt class="col-sm-6">Transacci√≥n:</dt>
              <dd class="col-sm-6">
                <%= link_to "##{@form.business_transaction_id}", 
                            business_transaction_path(@form.business_transaction) %>
              </dd>
            <% end %>
          </dl>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Resumen del Contacto</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-6">Propietario:</dt>
            <dd class="col-sm-6">
              <%= @form.general_conditions['owner_or_representative_name'] || 'No especificado' %>
            </dd>
            
            <dt class="col-sm-6">Tel√©fono:</dt>
            <dd class="col-sm-6">
              <%= @form.general_conditions['owner_phone'] || 'No especificado' %>
            </dd>
            
            <dt class="col-sm-6">Tipo inmueble:</dt>
            <dd class="col-sm-6">
              <%= @form.general_conditions['property_type']&.humanize || 'No especificado' %>
            </dd>
            
            <dt class="col-sm-6">M√©todo adquisici√≥n:</dt>
            <dd class="col-sm-6">
              <%= @form.acquisition_method_display %>
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Alertas especiales -->
  <% if @form.is_inheritance? %>
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>HERENCIA</strong> - Requiere atenci√≥n especial.
      Herederos: <%= @form.inheritance_info['heirs_count'] %>
    </div>
  <% end %>
  
  <% if @form.current_status['has_active_mortgage'] %>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>HIPOTECA ACTIVA</strong> - 
      Saldo: $<%= number_with_delimiter(@form.current_status['mortgage_balance']) %>
    </div>
  <% end %>
  
  <!-- Detalles de cada secci√≥n -->
  <div class="card mt-4">
    <div class="card-header">
      <h3>Detalles Completos</h3>
    </div>
    <div class="card-body">
      
      <%# ============================================================ %>
      <%# CONDICIONES GENERALES %>
      <%# ============================================================ %>
      <% if @form.general_conditions.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üìã Condiciones Generales</h4>
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Propietario:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['owner_or_representative_name'] %></dd>
                
                <dt class="col-sm-5">Tel√©fono:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['owner_phone'] %></dd>
                
                <dt class="col-sm-5">Email:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['owner_email'] %></dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Estado civil:</dt>
                <dd class="col-sm-7"><%= @form.general_conditions['civil_status']&.humanize %></dd>
                
                <% if @form.general_conditions['marriage_regime_id'].present? %>
                  <dt class="col-sm-5">R√©gimen matrimonial:</dt>
                  <dd class="col-sm-7"><%= MarriageRegime.find_by(id: @form.general_conditions['marriage_regime_id'])&.name %></dd>
                <% end %>
                
                <% if @form.general_conditions['notes'].present? %>
                  <dt class="col-sm-5">Observaciones:</dt>
                  <dd class="col-sm-7"><%= @form.general_conditions['notes'] %></dd>
                <% end %>
              </dl>
            </div>
          </div>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# INFORMACI√ìN DE LA PROPIEDAD %>
      <%# ============================================================ %>
      <% if @form.property_info.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üè† Ubicaci√≥n de la Propiedad</h4>
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Calle:</dt>
                <dd class="col-sm-7"><%= @form.property_info['street'] %></dd>
                
                <dt class="col-sm-5">N√∫mero exterior:</dt>
                <dd class="col-sm-7"><%= @form.property_info['exterior_number'] %></dd>
                
                <% if @form.property_info['interior_number'].present? %>
                  <dt class="col-sm-5">N√∫mero interior:</dt>
                  <dd class="col-sm-7"><%= @form.property_info['interior_number'] %></dd>
                <% end %>
                
                <dt class="col-sm-5">Colonia:</dt>
                <dd class="col-sm-7"><%= @form.property_info['neighborhood'] %></dd>
                
                <dt class="col-sm-5">C√≥digo Postal:</dt>
                <dd class="col-sm-7"><%= @form.property_info['postal_code'] %></dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Municipio:</dt>
                <dd class="col-sm-7"><%= @form.property_info['municipality'] %></dd>
                
                <dt class="col-sm-5">Ciudad:</dt>
                <dd class="col-sm-7"><%= @form.property_info['city'] %></dd>
                
                <dt class="col-sm-5">Pa√≠s:</dt>
                <dd class="col-sm-7"><%= @form.property_info['country'] %></dd>
              </dl>
            </div>
          </div>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# DETALLES DE ADQUISICI√ìN %>
      <%# ============================================================ %>
      <% if @form.acquisition_details.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üìù Detalles de Adquisici√≥n</h4>
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Estado:</dt>
                <dd class="col-sm-7"><%= @form.acquisition_details['state'] %></dd>
                
                <dt class="col-sm-5">Uso de suelo:</dt>
                <dd class="col-sm-7">
                  <% if @form.acquisition_details['land_use'].present? %>
                    <%= LandUseType.find_by(code: @form.acquisition_details['land_use'])&.name || @form.acquisition_details['land_use'] %>
                  <% end %>
                </dd>
                
                <dt class="col-sm-5">Copropietarios:</dt>
                <dd class="col-sm-7"><%= @form.acquisition_details['co_owners_count']  %></dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <% if @form.acquisition_details['relationship_type'].present? %>
                <dl class="row">
                  <dt class="col-sm-5">Relaci√≥n entre copropietarios:</dt>
                  <dd class="col-sm-7"><%= @form.acquisition_details['relationship_type']&.humanize %></dd>
                </dl>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# ESTADO ACTUAL %>
      <%# ============================================================ %>
      <% if @form.current_status.present? && @form.current_status.any? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üîß Estado Actual</h4>
          
          <%# Hipoteca %>
          <% if @form.current_status['has_active_mortgage'] %>
            <h5>Hipoteca</h5>
            <dl class="row">
              <dt class="col-sm-3">Saldo:</dt>
              <dd class="col-sm-9"><%= number_to_currency(@form.current_status['mortgage_balance']) rescue @form.current_status['mortgage_balance'] %></dd>
              
              <dt class="col-sm-3">Pagos al corriente:</dt>
              <dd class="col-sm-9"><%= @form.current_status['mortgage_payments_current'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
              
              <% if @form.current_status['mortgage_notes'].present? %>
                <dt class="col-sm-3">Notas:</dt>
                <dd class="col-sm-9"><%= @form.current_status['mortgage_notes'] %></dd>
              <% end %>
            </dl>
          <% end %>
          
          <%# Ampliaciones %>
          <% if @form.current_status['has_extensions'] %>
            <h5>Ampliaciones</h5>
            <dl class="row">
              <dt class="col-sm-3">Reportadas:</dt>
              <dd class="col-sm-9"><%= @form.current_status['extensions_reported'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
              
              <% if @form.current_status['extensions_notes'].present? %>
                <dt class="col-sm-3">Notas:</dt>
                <dd class="col-sm-9"><%= @form.current_status['extensions_notes'] %></dd>
              <% end %>
            </dl>
          <% end %>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# EXENCI√ìN ISR %>
      <%# ============================================================ %>
      <% if @form.tax_exemption.present? && @form.tax_exemption.any? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üí∞ Exenci√≥n ISR</h4>
          <dl class="row">
            <% if @form.tax_exemption['first_home_sale'].present? %>
              <dt class="col-sm-4">Primera venta de casa habitaci√≥n:</dt>
              <dd class="col-sm-8"><%= @form.tax_exemption['first_home_sale'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
            <% end %>
            
            <% if @form.tax_exemption['lived_last_5_years'].present? %>
              <dt class="col-sm-4">Vivi√≥ √∫ltimos 5 a√±os:</dt>
              <dd class="col-sm-8"><%= @form.tax_exemption['lived_last_5_years'] ? '‚úÖ S√≠' : '‚ùå No' %></dd>
            <% end %>
            
            <% if @form.tax_exemption['estimated_capital_gain'].present? %>
              <dt class="col-sm-4">Ganancia de capital estimada:</dt>
              <dd class="col-sm-8"><%= number_to_currency(@form.tax_exemption['estimated_capital_gain']) rescue @form.tax_exemption['estimated_capital_gain'] %></dd>
            <% end %>
          </dl>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# PREFERENCIAS DE PROMOCI√ìN %>
      <%# ============================================================ %>
      <% if @form.promotion_preferences.present? && @form.promotion_preferences.any? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üì£ Preferencias de Promoci√≥n</h4>
          <dl class="row">
            <dt class="col-sm-4">M√©todo de contacto preferido:</dt>
            <dd class="col-sm-8"><%= @form.promotion_preferences['preferred_contact_method']&.humanize %></dd>
            
            <dt class="col-sm-4">Horario de contacto:</dt>
            <dd class="col-sm-8"><%= @form.promotion_preferences['contact_hours']&.humanize %></dd>
            
            <% if @form.promotion_preferences['special_instructions'].present? %>
              <dt class="col-sm-4">Instrucciones especiales:</dt>
              <dd class="col-sm-8"><%= @form.promotion_preferences['special_instructions'] %></dd>
            <% end %>
          </dl>
        </div>
      <% end %>

      <%# ============================================================ %>
      <%# NOTAS DEL AGENTE %>
      <%# ============================================================ %>
      <% if @form.agent_notes.present? %>
        <div class="detail-section mb-4">
          <h4 class="section-title">üìù Notas del Agente</h4>
          <p class="text-muted"><%= simple_format(@form.agent_notes) %></p>
        </div>
      <% end %>

    </div>
  </div>

  <style>
    .detail-section {
      border-left: 3px solid #007bff;
      padding-left: 15px;
    }
    
    .section-title {
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    dl.row {
      margin-bottom: 0;
    }
    
    dl.row dt {
      font-weight: 600;
      color: #555;
    }
    
    dl.row dd {
      color: #666;
    }
  </style>
  
</div>
```
